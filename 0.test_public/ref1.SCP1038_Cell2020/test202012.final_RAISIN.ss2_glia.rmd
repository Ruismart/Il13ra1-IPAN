---
output: 
  html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
---
# ss2_glia part  
  
load all dependancies  
```{r message=FALSE, warning=FALSE}
source("analysis.r")
```
  
  
load seurat object from ss2_neur/glia sub-clustering results in previous page  
because ss2_glia has only 3 sub-clusters, not as complicated as ss2_neur's, first to do ss2_glia   

```{r}
ss2_glia.seur <- readRDS("ss2_glia.seur.rds")
```


## before differeital analysis  

before differential analysis, ..., in fact, did that directly more than once then found sth. interesting,   
ss2_Glia_1, no matter inpaper or inlocal(99% matched anyway), may further contain at least two distinct sub-clusters,   
just as that one of the three marker genes shows the difference (though they are not that unique).    

```{r ss2_glia_inpl, fig.height=10.8, fig.width=5.1, warning=FALSE}
multiplot(
  DimPlot(ss2_glia.seur, group.by = 'Annotation', label = T) + labs(title = "ss2_glia inpaper"),
  DimPlot(ss2_glia.seur, group.by = 'inlocal', label = T) + labs(title = "ss2_glia inlocal"),
  FeaturePlot(ss2_glia.seur, c("Slc18a2")) + coord_fixed(0.88), cols = 1
)
```

could also find a few unique (not 100% clean, just visually obvious) identifiers on the top empty part of Glia_1,     
like "Rxrg","Xylt1","Pappa" and so on.    

```{r ss2_glia_inpl2.2, fig.height=10.8, fig.width=5.1, warning=FALSE}
multiplot(
  FeaturePlot(ss2_glia.seur, c("Rxrg")) + coord_fixed(0.88),
  FeaturePlot(ss2_glia.seur, c("Xylt1")) + coord_fixed(0.88),
  FeaturePlot(ss2_glia.seur, c("Pappa")) + coord_fixed(0.88), cols = 1
)
```


and the nGene distribution also get a difference.  

```{r ss2_glia_inpl3, fig.height=4.8, fig.width=6.8, warning=FALSE}
DimPlot(ss2_glia.seur, group.by = 'nGene', cols = material.heat(1909)) + labs(title = "Number of genes")  + 
             guides(colour = guide_coloursteps(show.limits = TRUE,label=FALSE)) + coord_fixed(0.88)
```

sorry for still unavailable to add scale mark on the colorbar because of the conflicts of data formats inside.        
lightblue should be >3500, and orange still <6000    

ss2_glia's nGene distribution     
```{r}
cat("nGene quantile statistics of ss2_glia: \n" ); quantile(as.numeric(ss2_glia.seur@meta.data$nGene), probs=seq(0,1,0.05))
```


```{r warning=FALSE}
h <- hist(as.numeric(ss2_glia.seur@meta.data$nGene), breaks = 30, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = T)
h1 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$nGene), breaks = 30, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)
h2 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2"))$nGene), breaks = 30, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)
h3 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_3"))$nGene), breaks = 20, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)

d <- density(as.numeric(ss2_glia.seur@meta.data$nGene))
d1 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$nGene))
d2 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2"))$nGene))
d3 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_3"))$nGene))

title(paste0("nGene distribtusion for Glia_1(red), Glia_2(green), Glia_3(blue)"))

lines(x = d1$x, y=d1$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$nGene))* diff(h1$breaks)[1],
      col="red1",lwd=3, xlim = c(0,8000), ylim = c(0,400))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2"))$nGene))* diff(h2$breaks)[1],
      col="green3",lwd=3, xlim = c(0,8000), ylim = c(0,400))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_3"))$nGene))* diff(h3$breaks)[1],
      col="blue3",lwd=3, xlim = c(0,8000), ylim = c(0,400))
legend(x=0,y=400,c("Glia_1","Glia_2","Glia_3"),lty = 1,lwd=2,
       col=c("red","green","blue"))
```


is this nGene distribution a cause to drive the clustering or it's just somehow related but not the main reason ?  
try to sub-cluster Glia_1.  

comparing to complicated sub-clustering results of ss2_neur's:  
 level 1, into Chat+ and Nos1+,  
 level 2, into PEMNs/PIMNs/PINs/PSNs/PSVNs,  
 level 3, each again into 2-7 sub-clusters,  
     
ss2_glia just partition into three parts roughly with big 'k'NN and no further biological things to talk about.  
maybe it's just because ENS glia lack of existing knowledge, on the other hand,  
indeed it's less complicated for having less varible PCs.   


## sub-clustering of Glia_1  

batch info  
```{r}
cat("inlocal ss2_Glia_1 in each Mouse: \n");
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Mouse_ID)[paste0("M",1:29)]
```


```{r}
min_cells <- 4
cat("ss2_Glia_1 mice: ",length(table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Mouse_ID)),
    "\nss2_mix count: ",sum(table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Mouse_ID)),
    paste0("\n\nmin_cell < ",min_cells," : ",
           "\n    mice ",sum(table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Mouse_ID) < min_cells),
           "\n    count ",sum((table((ss2_glia.seur@meta.data %>% 
                               filter(inlocal == "Glia_1"))$Mouse_ID))[table((ss2_glia.seur@meta.data %>% 
                                    filter(inlocal == "Glia_1"))$Mouse_ID) < min_cells])))
```


sub-clustering test  
```{r}
# 
batch_use.Glia_1 <- (ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Mouse_ID
names(batch_use.Glia_1) <- rownames(ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))
batch_use.Glia_1 <- factor(batch_use.Glia_1)

#
#ss2_Glia_1.seur.test <- run_analysis(name='ss2_Glia_1.test',
#                               counts=ss2_glia.seur@assays[['RNA']]@counts[,rownames(ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))],
#                               do.batch=TRUE,
#                               batch.use=batch_use.Glia_1,
#                               min_cells=4,
#                               var_regex='^Cd|^Ig|^Rn|^mt|^Rp',
#                               num_pcs=9,
#                               clust_pcs=6,
#                               k=100)
# same issue should concern  
#ss2_Glia_1.seur.test$orig.ident <- factor("ss2_Glia_1.test")
#ss2_Glia_1.seur.test@active.ident <- factor("ss2_Glia_1.test")


```

```{r}
#saveRDS(ss2_Glia_1.seur.test,"ss2_Glia_1.seur.rds")
```

```{r}
ss2_Glia_1.seur.test <- readRDS("ss2_Glia_1.seur.rds")
```

Check PCA and tsne    

PCs 1-6 should be fine  
```{r}
ElbowPlot(ss2_Glia_1.seur.test,ndims = 9)
```

PCs  
```{r}
DimPlot(ss2_Glia_1.seur.test, reduction = 'pca', dims = c(1,2))
```

```{r}
DimPlot(ss2_Glia_1.seur.test, reduction = 'pca', dims = c(1,3))
```


```{r}
DimPlot(ss2_Glia_1.seur.test, reduction = 'tsne')
```

how did k100 do to cluster Glia_1,  
might be a little more to mixd one or two but not so sure about that  
```{r}
DimPlot(ss2_Glia_1.seur.test, group.by = 'phenograph.k100')
```


well then try to range a series of 'k'NNs, k=20 to 300,  
for convinient storage of variables, use a 'List' object to store all the results  

```{r}
# 
#batch_use.Glia_1 <- (ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Mouse_ID
#names(batch_use.Glia_1) <- rownames(ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))
#batch_use.Glia_1 <- factor(batch_use.Glia_1)

#
#ss2_Glia_1.seur.range <- list(NULL)

#for(kkk in 20*(1:15)){
#  ss2_Glia_1.seur.test <- run_analysis(name='ss2_Glia_1.test',
#                               counts=ss2_glia.seur@assays[['RNA']]@counts[,rownames(ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))],
#                               do.batch=TRUE,
#                               batch.use=batch_use.Glia_1,
#                               min_cells=4,
#                               var_regex='^Cd|^Ig|^Rn|^mt|^Rp',
#                               num_pcs=9,
#                               clust_pcs=6,
#                               k=kkk)      
  # same issue should concern  
#  ss2_Glia_1.seur.test$orig.ident <- factor("ss2_Glia_1.test")
#  ss2_Glia_1.seur.test@active.ident <- factor("ss2_Glia_1.test")
#  
#  ss2_Glia_1.seur.range <- c(ss2_Glia_1.seur.range, ss2_Glia_1.seur.test)
#}
#rm(ss2_Glia_1.seur.test)


#
```

```{r}
#saveRDS(ss2_Glia_1.seur.range, "ss2_Glia_1.seur.range.rds")
```

```{r}
ss2_Glia_1.seur.range <- readRDS("ss2_Glia_1.seur.range.rds")
```

 k=20:300 in 'List' '[[2]]' - '[[16]]'
```{r}
ss2_Glia_1.seur.range
```

how about 'k'NN 300-20 look like   
```{r Glia_1.range, fig.height=6.6, fig.width=13.6}
multiplot(
  DimPlot(ss2_Glia_1.seur.range[[16]], group.by = 'phenograph.k300') + labs(title="k300"),
  DimPlot(ss2_Glia_1.seur.range[[15]], group.by = 'phenograph.k280') + labs(title="k280"),
  DimPlot(ss2_Glia_1.seur.range[[14]], group.by = 'phenograph.k260') + labs(title="k260"),
  DimPlot(ss2_Glia_1.seur.range[[13]], group.by = 'phenograph.k240') + labs(title="k240"),
  DimPlot(ss2_Glia_1.seur.range[[12]], group.by = 'phenograph.k220') + labs(title="k220"),
DimPlot(ss2_Glia_1.seur.range[[11]], group.by = 'phenograph.k200') + labs(title="k200"),
DimPlot(ss2_Glia_1.seur.range[[10]], group.by = 'phenograph.k180') + labs(title="k180"),
DimPlot(ss2_Glia_1.seur.range[[9]], group.by = 'phenograph.k160') + labs(title="k160"),
DimPlot(ss2_Glia_1.seur.range[[8]], group.by = 'phenograph.k140') + labs(title="k140"),
DimPlot(ss2_Glia_1.seur.range[[7]], group.by = 'phenograph.k120') + labs(title="k120"),
DimPlot(ss2_Glia_1.seur.range[[6]], group.by = 'phenograph.k100') + labs(title="k100"),
DimPlot(ss2_Glia_1.seur.range[[5]], group.by = 'phenograph.k80') + labs(title="k80"),
DimPlot(ss2_Glia_1.seur.range[[4]], group.by = 'phenograph.k60') + labs(title="k60"),
DimPlot(ss2_Glia_1.seur.range[[3]], group.by = 'phenograph.k40') + labs(title="k40"),
DimPlot(ss2_Glia_1.seur.range[[2]], group.by = 'phenograph.k20') + labs(title="k20"),
cols = 5)
```


plot them back to ss2_glia  
add meta.data  

```{r}
ss2_glia.seur@meta.data$K300 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[16]]@meta.data),]$K300 <- ss2_Glia_1.seur.range[[16]]@meta.data$phenograph.k300
ss2_glia.seur@meta.data$K280 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[15]]@meta.data),]$K280 <- ss2_Glia_1.seur.range[[15]]@meta.data$phenograph.k280
ss2_glia.seur@meta.data$K260 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[14]]@meta.data),]$K260 <- ss2_Glia_1.seur.range[[14]]@meta.data$phenograph.k260
ss2_glia.seur@meta.data$K240 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[13]]@meta.data),]$K240 <- ss2_Glia_1.seur.range[[13]]@meta.data$phenograph.k240
ss2_glia.seur@meta.data$K220 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[12]]@meta.data),]$K220 <- ss2_Glia_1.seur.range[[12]]@meta.data$phenograph.k220

ss2_glia.seur@meta.data$K200 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[11]]@meta.data),]$K200 <- ss2_Glia_1.seur.range[[11]]@meta.data$phenograph.k200
ss2_glia.seur@meta.data$K180 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[10]]@meta.data),]$K180 <- ss2_Glia_1.seur.range[[10]]@meta.data$phenograph.k180
ss2_glia.seur@meta.data$K160 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[9]]@meta.data),]$K160 <- ss2_Glia_1.seur.range[[9]]@meta.data$phenograph.k160
ss2_glia.seur@meta.data$K140 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[8]]@meta.data),]$K140 <- ss2_Glia_1.seur.range[[8]]@meta.data$phenograph.k140
ss2_glia.seur@meta.data$K120 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[7]]@meta.data),]$K120 <- ss2_Glia_1.seur.range[[7]]@meta.data$phenograph.k120
ss2_glia.seur@meta.data$K100 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[6]]@meta.data),]$K100 <- ss2_Glia_1.seur.range[[6]]@meta.data$phenograph.k100
ss2_glia.seur@meta.data$K80 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[5]]@meta.data),]$K80 <- ss2_Glia_1.seur.range[[5]]@meta.data$phenograph.k80
ss2_glia.seur@meta.data$K60 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[4]]@meta.data),]$K60 <- ss2_Glia_1.seur.range[[4]]@meta.data$phenograph.k60
ss2_glia.seur@meta.data$K40 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[3]]@meta.data),]$K40 <- ss2_Glia_1.seur.range[[3]]@meta.data$phenograph.k40
ss2_glia.seur@meta.data$K20 <- ss2_glia.seur@meta.data$inlocal
ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[2]]@meta.data),]$K20 <- ss2_Glia_1.seur.range[[2]]@meta.data$phenograph.k20
```


plot with old Glia_2/3  
```{r Glia_1.range2, fig.height=6.6, fig.width=15.6} 
multiplot(
  DimPlot(ss2_glia.seur, group.by = 'K300') + labs(title="K300"),
  DimPlot(ss2_glia.seur, group.by = 'K280') + labs(title="K280"),
  DimPlot(ss2_glia.seur, group.by = 'K260') + labs(title="K260"),
  DimPlot(ss2_glia.seur, group.by = 'K240') + labs(title="K240"),
  DimPlot(ss2_glia.seur, group.by = 'K220') + labs(title="K220"),
DimPlot(ss2_glia.seur, group.by = 'K200') + labs(title="K200"),
DimPlot(ss2_glia.seur, group.by = 'K180') + labs(title="K180"),
DimPlot(ss2_glia.seur, group.by = 'K160') + labs(title="K160"),
DimPlot(ss2_glia.seur, group.by = 'K140') + labs(title="K140"),
DimPlot(ss2_glia.seur, group.by = 'K120') + labs(title="K120"),
DimPlot(ss2_glia.seur, group.by = 'K100') + labs(title="K100"),
DimPlot(ss2_glia.seur, group.by = 'K80') + labs(title="K80"),
DimPlot(ss2_glia.seur, group.by = 'K60') + labs(title="K60"),
DimPlot(ss2_glia.seur, group.by = 'K40') + labs(title="K40"),
DimPlot(ss2_glia.seur, group.by = 'K20') + labs(title="K20"),
cols=5
)
```

visually, clustering into 2-4 sub-clusters could be fine,    
but genes found upstairs tell us more possible here to choose K300 or K280 with nearly the same result  
(next if find DEGs that would get more clusters, back here to use other 'K's)   

let's call "0" Glia_1.0 and "1" Glia_1.1
```{r}
#ss2_glia.seur <- readRDS("ss2_glia.seur.rds")
#ss2_glia.seur@meta.data$K300 <- ss2_glia.seur@meta.data$inlocal
#ss2_glia.seur@meta.data[rownames(ss2_Glia_1.seur.range[[16]]@meta.data),]$K300 <- ss2_Glia_1.seur.range[[16]]@meta.data$phenograph.k300

#ss2_glia.seur@meta.data$K300[ss2_glia.seur@meta.data$K300=="0"] <- "Glia_1.0"
#ss2_glia.seur@meta.data$K300[ss2_glia.seur@meta.data$K300=="1"] <- "Glia_1.1"
```

```{r}
#saveRDS(ss2_glia.seur,"ss2_glia_new.seur.rds")
```

```{r}
ss2_glia.seur <- readRDS("ss2_glia_new.seur.rds")
```


```{r warning=FALSE,nGene_1,fig.height=4.5, fig.width=7.2}
h <- hist(as.numeric(ss2_glia.seur@meta.data$nGene), breaks = 30, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = T)
h1 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$nGene), breaks = 30, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)
h2 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2"))$nGene), breaks = 30, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)
h3 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_3"))$nGene), breaks = 20, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)

d <- density(as.numeric(ss2_glia.seur@meta.data$nGene))
d1 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$nGene))
d2 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2"))$nGene))
d3 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_3"))$nGene))

title(paste0("nGene distribtusion for Glia_1(red), Glia_2(green), Glia_3(blue)"))

lines(x = d1$x, y=d1$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$nGene))* diff(h1$breaks)[1],
      col="red1",lwd=3, xlim = c(0,8000), ylim = c(0,400))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2"))$nGene))* diff(h2$breaks)[1],
      col="green3",lwd=3, xlim = c(0,8000), ylim = c(0,400))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_3"))$nGene))* diff(h3$breaks)[1],
      col="blue3",lwd=3, xlim = c(0,8000), ylim = c(0,400))
legend(x=0,y=400,c("Glia_1","Glia_2","Glia_3"),lty = 1,lwd=2,
       col=c("red","green","blue"))
```

```{r warning=FALSE,nGene_2,fig.height=4.5, fig.width=7.3}
h <- hist(as.numeric(ss2_glia.seur@meta.data$nGene), breaks = 30, xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = T)
h1.1 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_1.1"))$nGene), breaks = 30, 
             xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)
h1.0 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_1.0"))$nGene), breaks = 30, 
             xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)
h2 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_2"))$nGene), breaks = 30, 
           xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)
h3 <- hist(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_3"))$nGene), breaks = 20, 
           xlab="", main="", xlim = c(0,8000), ylim = c(0,400), plot = F)

d <- density(as.numeric(ss2_glia.seur@meta.data$nGene))
d1.1 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_1.1"))$nGene))
d1.0 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_1.0"))$nGene))
d2 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_2"))$nGene))
d3 <- density(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_3"))$nGene))

title(paste0("nGene distribtusion for \nGlia_1.1(red), Glia_1.0(green), Glia_2(blue), Glia_3(purple)"))

lines(x = d1.1$x, y=d1.1$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_1.1"))$nGene))* diff(h1.1$breaks)[1],
      col="#F8766D",lwd=3, xlim = c(0,8000), ylim = c(0,400))
lines(x = d1.0$x, y=d1.0$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_1.0"))$nGene))* diff(h1.0$breaks)[1],
      col="#7CAE00",lwd=3, xlim = c(0,8000), ylim = c(0,400))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_2"))$nGene))* diff(h2$breaks)[1],
      col="#00BFC4",lwd=3, xlim = c(0,8000), ylim = c(0,400))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_glia.seur@meta.data %>% filter(K300 == "Glia_3"))$nGene))* diff(h3$breaks)[1],
      col="#C77CFF",lwd=3, xlim = c(0,8000), ylim = c(0,400))
legend(x=0,y=400,c("Glia_1.1","Glia_1.0","Glia_2","Glia_3"),lty = 1,lwd=2,
       col=c("#F8766D","#7CAE00","#00BFC4","#C77CFF"))
```

well not a very clean separation on nGene level, could see green(Glia_1.0) with a peak < 4000   

```{r message=FALSE, warning=FALSE}
DimPlot(ss2_glia.seur, group.by = 'K300', order = rev(c("Glia_1.1","Glia_1.0","Glia_2","Glia_3"))) + 
  coord_fixed(0.88)  + labs(title="inlocal new")
```





## differential analysis

test with MAST, fit a hurdle model,      
for mouse colon atlas, fit Yi with covariate:    
   
 Yi : standardzed log2(TP10K+1) expression vector for gene i across cells  
 X : variable reflecting cell subset membership (e.g. PSNs versus non-PSNs)   
 A : age associated with each cell (aged versus adult)  
 C : circadian phase for each cell (evening versus morning)  
 L : location for each cell (distal versus proximal)  
 S : sex for each cell (male versus female)  
 T : mouse model for each cell (Uchl1 versus Sox10)  
 N: scaled number of genes for each cell (i.e., cell complexity)   


in paper, comparisons of different conditions on ss2_glia are not mentioned much,   
but they are tested on ss2_neur, so here just do it the same way  

to find DEGs between different conditions, used to add covariates, but got quite different results comparing to inpaper's  
(ss2_neur, similar - different: Segment > Time > Age)  
here just without other covariates except nGene  

to find DEGs between sub-clusters, add covariates which would have effect on the comparison to do a regression to decrease the putative effects,   
though in the end it turns out that nGene level might match the clusterings anyway,   
still doubtful about if nGene distribution is the reason or result or sth. else but somehow related ~   

to filter for final unique DEGs between sub-clusters, inpaper calculates the next highest values for each highly-regulated gene     
but the results are confused and lack exact cutoffs of parameters to get a very close DEG list which is always a tricky process   
maybe it's because DEGs between Glia_2/3 are not that unique, and no previous biological knowledge as standard       
so no more discussion, except to set a next highest group to make the result look more confident, maybe       
    
    
add one more contrast between ss2_Glia_1 and ss2_Glia_2&3 !    
add condition contrasts on major group !    
    
(ss2_glia no 'Model' contrast)   
```{r}
# build covariates dataframe
#     
ss2_glia.cov <- data.frame(inlocal = factor(as.character(ss2_glia.seur@meta.data$K300)),
    inpaper = factor(as.character(ss2_glia.seur@meta.data$Annotation)),
    Age = factor(as.character(ss2_glia.seur@meta.data$Age_Processed), levels = c("Old","Young")),
    Time = as.character(ss2_glia.seur@meta.data$Time_Processed),
    Segment = factor(as.character(ss2_glia.seur@meta.data$Segment_Processed), levels = c("Distal","Proximal")),
    Seg_raw = as.character(ss2_glia.seur@meta.data$Segment),
    Sex = factor(as.character(ss2_glia.seur@meta.data$Sex_Processed), levels = c("M","F")),
    Model = factor(as.character(ss2_glia.seur@meta.data$Model_Processed), levels = c("Uchl1","Sox10")),
    nGene = scale(as.numeric(ss2_glia.seur@meta.data$nGene)),
    Sample = factor(rownames(ss2_glia.seur@meta.data)))
ss2_glia.cov$Time[ss2_glia.cov$Time=="7AM"] <- "Morning"
ss2_glia.cov$Time[ss2_glia.cov$Time=="7PM"] <- "Evening"
ss2_glia.cov$Time <- factor(ss2_glia.cov$Time, levels = c("Evening","Morning"))
ss2_glia.cov$Seg_raw[ss2_glia.cov$Seg_raw=="1"] <- "Seg1"
ss2_glia.cov$Seg_raw[ss2_glia.cov$Seg_raw=="2"] <- "Seg2"
ss2_glia.cov$Seg_raw[ss2_glia.cov$Seg_raw=="3"] <- "Seg3"
ss2_glia.cov$Seg_raw[ss2_glia.cov$Seg_raw=="4"] <- "Seg4"
ss2_glia.cov$Seg_raw <- factor(ss2_glia.cov$Seg_raw, levels = c("Seg1","Seg2","Seg3","Seg4"))

rownames(ss2_glia.cov) <- as.character(ss2_glia.cov$Sample)

ss2_glia.cov$major <- as.character(ss2_glia.seur@meta.data$inlocal)
ss2_glia.cov$major[grep("Glia_1",ss2_glia.cov$major)] <- "Glia_1"
ss2_glia.cov$major[grep("Glia_2",ss2_glia.cov$major)] <- "Glia_23"
ss2_glia.cov$major[grep("Glia_3",ss2_glia.cov$major)] <- "Glia_23"
ss2_glia.cov$major <- factor(ss2_glia.cov$major)
 
#ss2_glia.cov
```

```{r}
#write.table(ss2_glia.cov,"ss2_glia.cov.csv",col.names = TRUE,row.names = FALSE,quote = FALSE,sep=",")
```


differential analysis with MAST  
```{r}
# inlocal
#ss2_glia.masts_inlocal <- sapply(levels(factor(ss2_glia.cov$inlocal)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$inlocal == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Age","Time","Segment","Sex","Model","Sample")], 
#                 formula='~ nGene + ident + Age + Time + Segment + Sex + Model', 
#                lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal <- do.call(rbind,ss2_glia.masts_inlocal)

# major
#ss2_glia.masts_inlocal.major <- sapply(levels(factor(ss2_glia.cov$major)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$major == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Age","Time","Segment","Sex","Model","Sample")], 
#                 formula='~ nGene + ident + Age + Time + Segment + Sex + Model', 
#                lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.major <- do.call(rbind,ss2_glia.masts_inlocal.major)

# conditions
# Age
#ss2_glia.masts_inlocal.Age <- sapply(levels(factor(ss2_glia.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Age))]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Age <- do.call(rbind,ss2_glia.masts_inlocal.Age)

# Age_Glia1
#ss2_glia.masts_inlocal.Age_Glia1 <- sapply(levels(factor(ss2_glia.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Age)) & (ss2_glia.cov$major == "Glia_1")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Age_Glia1 <- do.call(rbind,ss2_glia.masts_inlocal.Age_Glia1)

# Age_Glia23
#ss2_glia.masts_inlocal.Age_Glia23 <- sapply(levels(factor(ss2_glia.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Age)) & (ss2_glia.cov$major == "Glia_23")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Age_Glia23 <- do.call(rbind,ss2_glia.masts_inlocal.Age_Glia23)

# Time
#ss2_glia.masts_inlocal.Time <- sapply(levels(factor(ss2_glia.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Time))]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Time <- do.call(rbind,ss2_glia.masts_inlocal.Time)

# Time_Glia1
#ss2_glia.masts_inlocal.Time_Glia1 <- sapply(levels(factor(ss2_glia.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Time)) & (ss2_glia.cov$major == "Glia_1")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Time_Glia1 <- do.call(rbind,ss2_glia.masts_inlocal.Time_Glia1)

# Time_Glia23
#ss2_glia.masts_inlocal.Time_Glia23 <- sapply(levels(factor(ss2_glia.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Time)) & (ss2_glia.cov$major == "Glia_23")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Time_Glia23 <- do.call(rbind,ss2_glia.masts_inlocal.Time_Glia23)



# Segment
#ss2_glia.masts_inlocal.Segment <- sapply(levels(factor(ss2_glia.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Segment))]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Segment <- do.call(rbind,ss2_glia.masts_inlocal.Segment)

# Segment_Glia1
#ss2_glia.masts_inlocal.Segment_Glia1 <- sapply(levels(factor(ss2_glia.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Segment)) & (ss2_glia.cov$major == "Glia_1")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Segment_Glia1 <- do.call(rbind,ss2_glia.masts_inlocal.Segment_Glia1)

# Segment_Glia23
#ss2_glia.masts_inlocal.Segment_Glia23 <- sapply(levels(factor(ss2_glia.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Segment)) & (ss2_glia.cov$major == "Glia_23")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Segment_Glia23 <- do.call(rbind,ss2_glia.masts_inlocal.Segment_Glia23)


# Seg_raw
#ss2_glia.masts_inlocal.Seg_raw <- sapply(levels(factor(ss2_glia.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Seg_raw))]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Seg_raw <- do.call(rbind,ss2_glia.masts_inlocal.Seg_raw)

# Seg_raw_Glia1
#ss2_glia.masts_inlocal.Seg_raw_Glia1 <- sapply(levels(factor(ss2_glia.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Seg_raw)) & (ss2_glia.cov$major == "Glia_1")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Seg_raw_Glia1 <- do.call(rbind,ss2_glia.masts_inlocal.Seg_raw_Glia1)

# Seg_raw_Glia23
#ss2_glia.masts_inlocal.Seg_raw_Glia23 <- sapply(levels(factor(ss2_glia.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Seg_raw)) & (ss2_glia.cov$major == "Glia_23")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Seg_raw_Glia23 <- do.call(rbind,ss2_glia.masts_inlocal.Seg_raw_Glia23)


# Sex
#ss2_glia.masts_inlocal.Sex <- sapply(levels(factor(ss2_glia.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Sex))]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Sex <- do.call(rbind,ss2_glia.masts_inlocal.Sex)

# Sex_Glia1
#ss2_glia.masts_inlocal.Sex_Glia1 <- sapply(levels(factor(ss2_glia.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Sex)) & (ss2_glia.cov$major == "Glia_1")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Sex_Glia1 <- do.call(rbind,ss2_glia.masts_inlocal.Sex_Glia1)

# Sex_Glia23
#ss2_glia.masts_inlocal.Sex_Glia23 <- sapply(levels(factor(ss2_glia.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Sex)) & (ss2_glia.cov$major == "Glia_23")]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Sex_Glia23 <- do.call(rbind,ss2_glia.masts_inlocal.Sex_Glia23)


# Model
#ss2_glia.masts_inlocal.Model <- sapply(levels(factor(ss2_glia.cov$Model)), function(ident){
#  ident.use = factor(ifelse(ss2_glia.cov$Model == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_glia.cov$Sample[!is.na(as.character(ss2_glia.cov$Model))]
#  p.find_markers(seur=ss2_glia.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_glia.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_glia.masts_inlocal.Model <- do.call(rbind,ss2_glia.masts_inlocal.Model)

## save raw output
#write.table(protectgene(ss2_glia.masts_inlocal),"MAST_raw/ss2_glia.masts_inlocal.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.major),"MAST_raw/ss2_glia.masts_inlocal.major.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Age),"MAST_raw/ss2_glia.masts_inlocal.Age.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Age_Glia1),"MAST_raw/ss2_glia.masts_inlocal.Age_Glia1.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Age_Glia23),"MAST_raw/ss2_glia.masts_inlocal.Age_Glia23.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Segment),"MAST_raw/ss2_glia.masts_inlocal.Segment.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Segment_Glia1),"MAST_raw/ss2_glia.masts_inlocal.Segment_Glia1.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Segment_Glia23),"MAST_raw/ss2_glia.masts_inlocal.Segment_Glia23.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw),"MAST_raw/ss2_glia.masts_inlocal.Seg_raw.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw_Glia1),"MAST_raw/ss2_glia.masts_inlocal.Seg_raw_Glia1.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw_Glia23),"MAST_raw/ss2_glia.masts_inlocal.Seg_raw_Glia23.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Sex),"MAST_raw/ss2_glia.masts_inlocal.Sex.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Sex_Glia1),"MAST_raw/ss2_glia.masts_inlocal.Sex_Glia1.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Sex_Glia23),"MAST_raw/ss2_glia.masts_inlocal.Sex_Glia23.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Time),"MAST_raw/ss2_glia.masts_inlocal.Time.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Time_Glia1),"MAST_raw/ss2_glia.masts_inlocal.Time_Glia1.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Time_Glia23),"MAST_raw/ss2_glia.masts_inlocal.Time_Glia23.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

```

  
this part would take much time, annotate the code when it's done.   
 
```{r}
ss2_glia.masts_inlocal <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.raw.csv",
                                             header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.major <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.major.raw.csv",
                                                   header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_glia.masts_inlocal.Age <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Age.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Age_Glia1 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Age_Glia1.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Age_Glia23 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Age_Glia23.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_glia.masts_inlocal.Segment <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Segment.raw.csv",
                                                     header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Segment_Glia1 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Segment_Glia1.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Segment_Glia23 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Segment_Glia23.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_glia.masts_inlocal.Seg_raw <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Seg_raw.raw.csv",
                                                     header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Seg_raw_Glia1 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Seg_raw_Glia1.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Seg_raw_Glia23 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Seg_raw_Glia23.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_glia.masts_inlocal.Sex <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Sex.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Sex_Glia1 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Sex_Glia1.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Sex_Glia23 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Sex_Glia23.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_glia.masts_inlocal.Time <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Time.raw.csv",
                                                  header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Time_Glia1 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Time_Glia1.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_glia.masts_inlocal.Time_Glia23 <- recgene(read.table("MAST_raw/ss2_glia.masts_inlocal.Time_Glia23.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
```

   
## filtering and figures  
    
     
there're a few columns to filter for the final unique DEGs,   
for ss2 data, here ignores contam.res (contaminated residuals for droplet-based filtering)   
and would only filter with p.adjD<0.05 (coefD > 0 and sorted) to save DEGs' table,    
(keep duplicated DEGs only in one group with biggest coefD instead of using 'next highest' things)  

if filter others like mean expression (mu, mean), expressed cells ratio(alpha) and log2FC et al. just for repeating figures in paper..  

### filt1  

```{r}
filt1_mast <- function(mast_raw){
  mast_filt <- mast_raw %>% filter(padjD<0.05) %>% filter(coefD >0) %>% arrange(desc(coefD))
  mast_filt <- mast_filt[!duplicated(mast_filt$gene),]
  mast_filt <- mast_filt %>% arrange(contrast,desc(coefD))
  return(mast_filt)
}
```


```{r}
ss2_glia.masts_inlocal.filt1 <- filt1_mast(ss2_glia.masts_inlocal)
ss2_glia.masts_inlocal.major.filt1 <- filt1_mast(ss2_glia.masts_inlocal.major)

ss2_glia.masts_inlocal.Age.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Age)
ss2_glia.masts_inlocal.Age_Glia1.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Age_Glia1)
ss2_glia.masts_inlocal.Age_Glia23.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Age_Glia23)

ss2_glia.masts_inlocal.Segment.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Segment)
ss2_glia.masts_inlocal.Segment_Glia1.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Segment_Glia1)
ss2_glia.masts_inlocal.Segment_Glia23.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Segment_Glia23)

ss2_glia.masts_inlocal.Seg_raw.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Seg_raw)
ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Seg_raw_Glia1)
ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Seg_raw_Glia23)

ss2_glia.masts_inlocal.Sex.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Sex)
ss2_glia.masts_inlocal.Sex_Glia1.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Sex_Glia1)
ss2_glia.masts_inlocal.Sex_Glia23.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Sex_Glia23)

ss2_glia.masts_inlocal.Time.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Time)
ss2_glia.masts_inlocal.Time_Glia1.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Time_Glia1)
ss2_glia.masts_inlocal.Time_Glia23.filt1 <- filt1_mast(ss2_glia.masts_inlocal.Time_Glia23)
```


```{r}
#write.table(protectgene(ss2_glia.masts_inlocal.filt1),"MAST_filt1/ss2_glia.masts_inlocal.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.major.filt1),"MAST_filt1/ss2_glia.masts_inlocal.major.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Age.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Age.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Age_Glia1.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Age_Glia1.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Age_Glia23.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Age_Glia23.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Segment.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Segment.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Segment_Glia1.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Segment_Glia1.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Segment_Glia23.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Segment_Glia23.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Seg_raw.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Sex.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Sex.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Sex_Glia1.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Sex_Glia1.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Sex_Glia23.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Sex_Glia23.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Time.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Time.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Time_Glia1.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Time_Glia1.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Time_Glia23.filt1),"MAST_filt1/ss2_glia.masts_inlocal.Time_Glia23.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
```

several columns in MAST results could be candidate cutoffs to filter for 'significant' DEGs   
   
| Column | Description |  
| :-----| :------------------------------------------------------------------------------------------|  
| ident | Cell subset or lineage |  
| gene | Gene |  
| coefD | Coefficient (discrete term) |  
| pvalD | P-value (discrete term) |  
| padjD | Adjusted p-value (discrete term) |  
| coefC | Coefficient (continuous term) |  
| pvalC | P-value (continuous term) |  
| padjC | Adjusted p-value (continuous term) |  
| mastfc | Fold change estimated by MAST |  
| alpha | Fraction of expressing cells |  
| ref_alpha | Fraction of expressing cells (reference group) |  
| mu | Mean log2(TP10K) in expressing cells |  
| ref_mu | Mean log2(TP10K) in expressing cells (reference group) |  
| mean | Mean log2(TP10K) in all cells |  
| ref_mean | Mean log2(TP10K) in all cells (reference group) |  
| log2fc | log2 fold change (relative to reference group) |  
| contam.res | Residual (contamination model) |  
| Note: | reference group = all other cells (for example, reference group for Tregs = all non-Tregs) |  


in paper, comparing to ss2_neur, analysis of ss2_glia is very absent.  
maybe it is because glia can not be the key point considering the poor number of subclusters.    
(is it born this way ? Or, showed like this for some quality/technique limitations ?)     

besides, the highlighted markers: Gfra2, Slc18a2, Ntsr1, don't look good from the start.   

```{r feature0,fig.width=8,fig.height=6}
FeaturePlot(ss2_glia.seur,c("Gfra2","Slc18a2","Ntsr1"))
```
    
```{r message=FALSE, warning=FALSE,majormarker1,fig.height=8,fig.width=5}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes="Gfra2", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,6),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Slc18a2", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Ntsr1", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
cols = 1)
```
    
    
### check labelings in fig.S2E         
tested cutoffs using coefD + padjD + additional "next highest" fold change, can't directly get these genes.       
for Glia 1, some labelings might could be fine.(like Col5a3, Kcna2, Cadm2, but where's Gfra2 ?)   

fig.S2E, Glia 1 labeled genes.  
```{r feature1,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,c("Col5a3","Kcna2","Frmd4a","Abca8b","Clvs1","Prnp","Cadm2","Kcnn2",
                            "Aatk","Olfm2","Fyn","Ntng1","Apba2","Nav1","Kcnk13","Zfyve28"))
```

for Glia 2/3, hard to say...    

ss2_glia clusters.   
```{r ss2_glia_inpl1, fig.height=3, fig.width=12.8, warning=FALSE}
multiplot(
  DimPlot(ss2_glia.seur, group.by = 'Annotation', label = T) + labs(title = "ss2_glia inpaper"),
  DimPlot(ss2_glia.seur, group.by = 'inlocal', label = T) + labs(title = "ss2_glia inlocal"),
  DimPlot(ss2_glia.seur, group.by = 'K300', label = T) + labs(title = "ss2_glia inlocal new"),
  cols=3
)
```

fig.S2E, Glia 2 labeled genes.  
```{r feature2,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,c("Slc18a2","Mapk10","Fam184b","Trim9","Lsamp","Erc2","Auts2","Cpe",
                            "Sobp","Dio2","Ank2","Ppp2r2c","Kcnc4","Kcnab2","Ctnnd2"))
```

fig.S2E, Glia 3 labeled genes.     
(Dkk3/Olfml3/Clu/Ncan/Omg/Ntsr1 look like that they have some pattern)    

```{r feature3,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,c("Bcan","Dkk3","Tspan18","Olfml3","Fam184b","Lsamp","Clu","Trim9",
                            "Mest","Ncan","Omg","Ntsr1","Auts2","Cdh2"))
```

```{r message=FALSE, warning=FALSE,majormarker1.1,fig.height=16,fig.width=5}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes="Dkk3", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Olfml3", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Clu", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Ncan", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Omg", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Ntsr1", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
cols = 1)
```

   
### filt2    

tested "mu","mean","foldchange","n","alpha", still confused about how to exactly do it.   
according to the nGene distribution upstairs,   
may think "n" or "alpha" which represents "expressed cells (ratio)" could have more weights than only using expressing levels.  
finally just use quantile 95% of "diff_alpha = alpha - ref_alpha" as cutoff.  

```{r}
# min - max of diff_alpha  
range(ss2_glia.masts_inlocal.filt1$alpha - ss2_glia.masts_inlocal.filt1$ref_alpha)
```

```{r paged.print=FALSE}
# quantile with step 0.05
test_quant <- data.frame(quantile(ss2_glia.masts_inlocal.filt1$alpha - ss2_glia.masts_inlocal.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant) <- "alpha-ref_alpha"
test_quant
```

choose 95% as cutoff  
```{r quantile1,fig.width=8,fig.height=6}
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.filt1$alpha - ss2_glia.masts_inlocal.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.45))
text(x=0:20*1.2+0.65,y=test_quant[,1]+0.01*test_quant[,1]/abs(test_quant[,1]),round(test_quant[,1],3),cex=0.8)
```

filt2   
      
modification from 'future check of ss2_neur':   
if one gene expressed in most cells, or with similar ratio in all groups,   
but uniquely high in one(or two), this 'alpha - ref_alpha' filtering couldn't find them.   
     
so filt2 add condition:   
or "genes with alpha > 'quantile 20%' and 'mu - ref_mu' > 'quantile 95%'"        
      
```{r}
filt2_mast <- function(mast_raw){
  mast_filt <- mast_raw %>% filter(padjD<0.05) %>% filter(coefD >0) %>% arrange(desc(coefD))
  mast_filt <- mast_filt[!duplicated(mast_filt$gene),]
  mast_filt <- mast_filt %>% arrange(contrast,desc(coefD))
  
  mast_filt$diff_alpha <- mast_filt$alpha - mast_filt$ref_alpha
  mast_filt$diff_mu <- mast_filt$mu - mast_filt$ref_mu 
  
  mast_filt <- mast_filt %>% filter(diff_alpha> as.numeric((quantile(mast_filt$diff_alpha,
                                                                     probs = seq(0,1,0.05)))["95%"]) |
                                      (diff_mu > as.numeric((quantile(mast_filt$diff_mu,
                                                                      probs = seq(0,1,0.05)))["95%"]) &
                                         alpha > as.numeric((quantile(mast_filt$alpha,
                                                                      probs = seq(0,1,0.05)))["20%"])))
  return(mast_filt)
}
```

```{r}
ss2_glia.masts_inlocal.filt2 <- filt2_mast(ss2_glia.masts_inlocal)
ss2_glia.masts_inlocal.major.filt2 <- filt2_mast(ss2_glia.masts_inlocal.major)

ss2_glia.masts_inlocal.Age.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Age)
ss2_glia.masts_inlocal.Age_Glia1.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Age_Glia1)
ss2_glia.masts_inlocal.Age_Glia23.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Age_Glia23)

ss2_glia.masts_inlocal.Segment.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Segment)
ss2_glia.masts_inlocal.Segment_Glia1.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Segment_Glia1)
ss2_glia.masts_inlocal.Segment_Glia23.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Segment_Glia23)

ss2_glia.masts_inlocal.Seg_raw.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Seg_raw)
ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Seg_raw_Glia1)
ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Seg_raw_Glia23)

ss2_glia.masts_inlocal.Sex.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Sex)
ss2_glia.masts_inlocal.Sex_Glia1.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Sex_Glia1)
ss2_glia.masts_inlocal.Sex_Glia23.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Sex_Glia23)

ss2_glia.masts_inlocal.Time.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Time)
ss2_glia.masts_inlocal.Time_Glia1.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Time_Glia1)
ss2_glia.masts_inlocal.Time_Glia23.filt2 <- filt2_mast(ss2_glia.masts_inlocal.Time_Glia23)
```

```{r}
#write.table(protectgene(ss2_glia.masts_inlocal.filt2),"MAST_filt2/ss2_glia.masts_inlocal.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.major.filt2),"MAST_filt2/ss2_glia.masts_inlocal.major.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Age.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Age.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Age_Glia1.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Age_Glia1.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Age_Glia23.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Age_Glia23.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Segment.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Segment.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Segment_Glia1.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Segment_Glia1.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Segment_Glia23.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Segment_Glia23.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Seg_raw.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Sex.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Sex.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Sex_Glia1.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Sex_Glia1.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Sex_Glia23.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Sex_Glia23.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_glia.masts_inlocal.Time.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Time.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Time_Glia1.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Time_Glia1.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_glia.masts_inlocal.Time_Glia23.filt2),"MAST_filt2/ss2_glia.masts_inlocal.Time_Glia23.filt2.csv",
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
```


how many DEGs in .filt2    
```{r}
dim(ss2_glia.masts_inlocal.filt2)[1]
```

```{r}
ss2_glia.masts_inlocal.filt2[1:5,]
```

### volcano plots similar to fig.S2E   

```{r volcano1,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_1.0"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_1.0"))$padjD)),
     pch=16,col="grey",
     main="Glia_1.0", xlab="DE coefficient (Glia_1.0 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_1.0"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_1.0"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.0"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.0"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.0"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.0"))$padjD)+1),
     (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.0"))$gene,cex=0.6)

legend(x=0,y=45,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```


```{r volcano2,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_1.1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_1.1"))$padjD)),
     pch=16,col="grey",
     main="Glia_1.1", xlab="DE coefficient (Glia_1.1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_1.1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_1.1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.1"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.1"))$padjD)+1),
     (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.1"))$gene,cex=0.6)

legend(x=0,y=56,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano3,fig.width=10,fig.height=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_2"))$padjD)),
     pch=16,col="grey",
     main="Glia_2", xlab="DE coefficient (Glia_2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.03,y=1.8,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2"))$gene,cex=0.6)

legend(x=0,y=25,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```


```{r volcano4,fig.width=10,fig.height=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal %>% filter(coefD > 0 & contrast=="identGlia_3"))$padjD)),
     pch=16,col="grey",
     main="Glia_3", xlab="DE coefficient (Glia_3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt1 %>% filter(contrast=="identGlia_3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3"))$padjD)+1),
     (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3"))$gene,cex=0.6)

legend(x=0,y=52,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

as displayed upstairs, filt2 filtering for 'diff_alpha' basically get genes with top '-log10(padjD)' which would make sense logically.      
however, if it's 'really significant' ? I have no idea. could only say 'putative' or 'candidate'. next check these DEGs.   

## DEGs of subclusters    
   
clusters   
```{r ss2_glia_inpl2.1, fig.height=3, fig.width=12.8, warning=FALSE}
multiplot(
  DimPlot(ss2_glia.seur, group.by = 'Annotation', label = T) + labs(title = "ss2_glia inpaper"),
  DimPlot(ss2_glia.seur, group.by = 'inlocal', label = T) + labs(title = "ss2_glia inlocal"),
  DimPlot(ss2_glia.seur, group.by = 'K300', label = T) + labs(title = "ss2_glia inlocal new"),
  cols=3
)
```


### Glia_1.1 DEGs
left top group   

```{r ss2_glia_inpl_1.1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'K300',cells = ss2_glia.seur$K300=="Glia_1.1", cols = "#7CAE00",
        pt.size = 0.5,label = T) + 
  labs(title = "ss2_glia inlocal new") + coord_cartesian(xlim = c(-50,42), ylim = c(-40,35)),
cols = 1)
```

```{r feat1_1.1,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.1") %>% arrange(padjD))$gene[1:16])
```

```{r feat2_1.1, fig.height=9, fig.width=12, warning=FALSE}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.1") %>% arrange(padjD))$gene[17:32])
```

### Glia_1.0 DEGs
left down group   

```{r ss2_glia_inpl_1.0, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'K300',cells = ss2_glia.seur$K300=="Glia_1.0", cols = "#F8766D", 
        pt.size = 0.5,label = T) + 
  labs(title = "ss2_glia inlocal new") + coord_cartesian(xlim = c(-50,42), ylim = c(-40,35)),
cols = 1)
```

```{r feat1_1.0,fig.height=6.75, fig.width=12, warning=FALSE}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_1.0") %>% arrange(padjD))$gene[1:16])
```

### Glia_2 DEGs
right outside group   

```{r ss2_glia_inpl_2, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'K300',cells = ss2_glia.seur$K300=="Glia_2", cols = "#00BFC4", pt.size = 0.5,label = T) + 
  labs(title = "ss2_glia inlocal new") + coord_cartesian(xlim = c(-50,42), ylim = c(-40,35)),
cols = 1)
```


```{r feat1_2,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2") %>% arrange(padjD))$gene[1:16])
```


```{r feat2_2,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2") %>% arrange(padjD))$gene[17:32])
```


```{r feat3_2,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2") %>% arrange(padjD))$gene[33:48])
```


```{r feat4_2, fig.height=4.5, fig.width=12, message=FALSE, warning=FALSE}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_2") %>% arrange(padjD))$gene[49:64],ncol = 4)
```

### Glia_3 DEGs
right inside group   

```{r ss2_glia_inpl_3, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'K300',cells = ss2_glia.seur$K300=="Glia_3", cols = "#C77CFF", 
        pt.size = 0.5,label = T) + 
  labs(title = "ss2_glia inlocal new") + coord_cartesian(xlim = c(-50,42), ylim = c(-40,35)),
cols = 1)
```


```{r feat1_3,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3") %>% arrange(padjD))$gene[1:16])
```

```{r feat2_3,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3") %>% arrange(padjD))$gene[17:32])
```

```{r feat3_3,fig.width=12,fig.height=9}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3") %>% arrange(padjD))$gene[33:48])
```


```{r feat4_3, fig.height=9, fig.width=12, warning=FALSE}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3") %>% arrange(padjD))$gene[49:64])
```

```{r feat5_3, fig.height=9, fig.width=12, warning=FALSE}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3") %>% arrange(padjD))$gene[65:80])
```

```{r feat6_3, fig.height=9, fig.width=12, warning=FALSE}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3") %>% arrange(padjD))$gene[81:96])
```

```{r feat7_3, fig.height=2.25, fig.width=3, warning=FALSE}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt2 %>% filter(contrast=="identGlia_3") %>% arrange(padjD))$gene[97:112])
```


## conclusion of ss2_glia DEGs   

comparing to ss2_neur, in spite of similar cell number, not many DEGs could be highly unique.   
it could be possible here glia in ENS have dynamic stages rather than distant subgroups.    

these filt2 DEGs just show genes that might be more significant than other unlabeled,   
but if there's one gene with alpha=15% and ref_alpha=0 which is more like a unique identifier, it wouldn't be here,   
test that situation:      

```{r paged.print=FALSE}
quantile(ss2_glia.masts_inlocal.filt1$ref_alpha, probs = seq(0,1,0.05))
```

choose 'ref_alpha=0.06' < 'quantile 10%' as cutoff, all genes with '0.06 < alpha - ref_alpha < 0.182':    
('>0.182' already found)        

```{r paged.print=FALSE}
(ss2_glia.masts_inlocal.filt1 %>% filter(ref_alpha<0.06 & ((alpha - 0.06) > ref_alpha) & (alpha - ref_alpha)<0.182)
 )[,c("gene","contrast","coefD","n","alpha","ref_alpha","mu","ref_mu")]
```

could see Glia_1.0 finally gets a relatively better one, 'Artn',     

and Glia_1.1 gets a familiar gene, 'Aldh1a1', which is investigated by Christian Wolfrum Lab in     
"snRNA-seq reveals a subpopulation of adipocytes that regulates thermogenesis",     
this paper was published less than two months later      


```{r feat4,fig.width=12,fig.height=13.5}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.filt1 %>% filter(ref_alpha<0.06 & ((alpha - 0.06) > ref_alpha) & (alpha - ref_alpha)<0.182))[,c("gene","contrast","coefD","n","alpha","ref_alpha")]$gene)
```

```{r message=FALSE, warning=FALSE,majormarker0,fig.height=8,fig.width=5}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes="Artn", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Aldh1a1", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
easy_violin(seur=ss2_glia.seur,
            genes="Omg", 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"K300"], 
            cells=rownames(ss2_glia.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = glia.colors.inlocal,
            color.point = glia.colorpoint.inlocal),
cols = 1)
```


## Pseudotime    

how about UMAP result comparing to tSNE ?    
and what does the putative cell trajectory look like ?   

```{r message=FALSE, warning=FALSE}
#ss2_glia.seur_traj <- ss2_glia.seur
#ss2_glia.seur_traj <- RunUMAP(ss2_glia.seur_traj, dims=1:9)
```

```{r}
#saveRDS(ss2_glia.seur_traj,"ss2_glia.seur_traj.rds")
ss2_glia.seur_traj <- readRDS("ss2_glia.seur_traj.rds")
```


```{r ss2_glia_inpl_4, fig.height=8, fig.width=5.67, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur_traj,reduction = 'tsne', group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur_traj,reduction = 'umap', group.by = "K300",label = T) + labs(title = "ss2_glia inlocal new"),
cols = 1)
```
     
```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ss2_glia.seur_traj1 <- ss2_glia.seur
ss2_glia.seur_traj1 <- RunUMAP(ss2_glia.seur_traj1, n.neighbors = 500 , dims=1:9)
```


```{r ss2_glia_inpl_4.1, eval=FALSE, fig.height=8, fig.width=5.67, warning=FALSE, include=FALSE}
multiplot(
DimPlot(ss2_glia.seur_traj1,reduction = 'tsne', group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur_traj1,reduction = 'umap', group.by = "K300",label = T) + labs(title = "ss2_glia inlocal new"),
cols = 1)
```     
        
        
visually, UMAP result gives a clearer understanding of the difference between clusters.    
     
### DiffusionMap using DEGs or PCs   
ref. https://broadinstitute.github.io/2020_scWorkshop/trajectory-inference.html  

```{r}
diffusion_test <- DiffusionMap(t(data.frame(ss2_glia.seur_traj@assays[['RNA']]@data))[,ss2_glia.masts_inlocal.filt2$gene])
diffusion_testpca <- DiffusionMap(data.frame(ss2_glia.seur_traj@reductions[['pca']]@cell.embeddings)[,1:9])
```

```{r}
diffusion_tmp <- data.frame(DC1 = eigenvectors(diffusion_test)[,1],
                            DC2 = eigenvectors(diffusion_test)[,2],
                            label = ss2_glia.seur_traj$K300)
head(diffusion_tmp)
```

```{r}
diffusion_pca <- data.frame(DC1 = eigenvectors(diffusion_testpca)[,1],
                            DC2 = eigenvectors(diffusion_testpca)[,2],
                            label = ss2_glia.seur_traj$K300)
head(diffusion_pca)
```

```{r eval=FALSE, include=FALSE}
plot(eigenvalues(diffusion_test), ylim = 0:1, pch = 20, xlab = 'Diffusion component (DC)', ylab = 'Eigenvalue')
plot(eigenvalues(diffusion_testpca), ylim = 0:1, pch = 20, xlab = 'Diffusion component (DC)', ylab = 'Eigenvalue')
```

```{r diffusion1,fig.height=6.8, fig.width=5.6}
multiplot(
ggplot(diffusion_tmp, aes(x = DC1, y = DC2, colour = label)) +
    geom_point(cex=1.0) + 
    scale_color_manual(values=c("#F8766D","#7CAE00","#00BFC4","#C77CFF")) +
    #ggthemes::scale_color_tableau() + 
    xlab("Diffusion component 1") + 
    ylab("Diffusion component 2") +
    theme_classic() + labs(title=("DM with DEGs")),
ggplot(diffusion_pca, aes(x = DC1, y = DC2, colour = label)) +
    geom_point(cex=1.0) + 
    scale_color_manual(values=c("#F8766D","#7CAE00","#00BFC4","#C77CFF")) +
    #ggthemes::scale_color_tableau() + 
    xlab("Diffusion component 1") + 
    ylab("Diffusion component 2") +
    theme_classic() + labs(title=("DM with PCs")),
cols = 1)
```


### Slingshot pseudotime on UMAP    
ref. https://bustools.github.io/BUS_notebooks_R/slingshot.html  

```{r}
sds_umap <- slingshot(Embeddings(ss2_glia.seur_traj, "umap"), clusterLabels = ss2_glia.seur_traj$K300)
```

```{r}
sds_umap
```

```{r}
# as people described, to plot Slingshot result, may need to give each cell a color  
sds_colors <- ss2_glia.seur_traj$K300
clust_colors <- c("#7CAE00","#F8766D","#00BFC4","#C77CFF")
clust_names <- paste0("Glia_",c("1.1","1.0","2","3"))
for(i in 1:length(clust_colors)){
  sds_colors[sds_colors==clust_names[i]] <- clust_colors[i]
}
```

```{r sds1,fig.height=4.8, fig.width=6}
plot(reducedDims(sds_umap), col = sds_colors, pch=16, cex = 0.35, asp = 1.25,
     ylim=c(-5,6),main="Slingshot on UMAP")
lines(sds_umap, lwd=2, type = 'lineages', col = 'black')
legend(x=-12,y=6,clust_names,cex=0.65,
       col=clust_colors,pch=c(16,16,16))
```
       
       
seems the trajectory is like Glia_1.1 <--> Glia_1.0 <--> Glia_2 <--> Glia_3.  

well, no direction yet,     
here just take a look, all those methods are doing the same thing: Dimension Reduction,          
which one is better has been discussed a lot,     
just as https://broadinstitute.github.io/2020_scWorkshop/trajectory-inference.html,    
those google slides make a good introduction.    

additionally check pseudotime in monocle3.    


### Monocle3 Pseudotime     
ref. https://cole-trapnell-lab.github.io/monocle3/docs/trajectories/#learn-graph     


```{r message=FALSE, warning=FALSE}
# perform seruat v3 object to monocle v3 trajectory analysis  
# ref. https://github.com/satijalab/seurat/issues/1658  
gene_annt <- as.data.frame(rownames(ss2_glia.seur_traj@reductions[['pca']]@feature.loadings),
                           row.names = rownames(ss2_glia.seur_traj@reductions[['pca']]@feature.loadings))
colnames(gene_annt) <- "gene_short_name"
# genes in @feature.loadings is the seurat used variable genes ! 
# so here just use those about 1500 features instead of whole >10k genes.  

cell_meta <- as.data.frame(ss2_glia.seur_traj@meta.data)

new_mtx <- ss2_glia.seur_traj@assays[['RNA']]@counts
new_mtx <- new_mtx[rownames(ss2_glia.seur_traj@reductions[['pca']]@feature.loadings),]

cds <- new_cell_data_set(new_mtx,
                         cell_metadata = cell_meta,
                         gene_metadata = gene_annt)

recreate.partition <- c(rep(1,length(cds@colData@rownames)))
#recreate.partition <- ss2_glia.seur_traj@meta.data$K300
names(recreate.partition) <- cds@colData@rownames
recreate.partition <- as.factor(recreate.partition)

cds@clusters@listData[['UMAP']][['partitions']] <- recreate.partition
#cds@clusters@listData[['tSNE']][['partitions']] <- recreate.partition

list_clusters <- ss2_glia.seur_traj@meta.data$K300
names(list_clusters) <- rownames(ss2_glia.seur_traj@meta.data)

cds@clusters@listData[['UMAP']][['clusters']] <- list_clusters
#cds@clusters@listData[['tSNE']][['clusters']] <- list_clusters

cds@clusters@listData[['UMAP']][['louvarin_res']] <- "NA"
#cds@clusters@listData[['tSNE']][['louvarin_res']] <- "NA"
cds@int_colData@listData[['reducedDims']][["UMAP"]] <- ss2_glia.seur_traj@reductions[['umap']]@cell.embeddings
#cds@int_colData@listData[['reducedDims']][["tSNE"]] <- ss2_glia.seur_traj@reductions[['tsne']]@cell.embeddings

cds@preprocess_aux$gene_loadings <- ss2_glia.seur_traj@reductions[["pca"]]@feature.loadings
# UMAP from Seurat v3 to Monocle v3 done.  

cds <- learn_graph(cds)
```

```{r eval=FALSE, include=FALSE}
cds
```


similar to DM, but more branches making it complex.            


```{r echo=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, cds_umap2,fig.width=6}
plot_cells(cds, label_groups_by_cluster = T, reduction_method = "UMAP",group_label_size = 4.5,graph_label_size = 4,cell_size = 0.75)
```

```{r message=FALSE, warning=FALSE}
root_cells <- rownames(ss2_glia.seur_traj@meta.data %>% filter(K300 == "Glia_1.1") )[
  order((ss2_glia.seur_traj@meta.data %>% filter(K300 == "Glia_1.1"))$nGene)[1:10]]
cds <- order_cells(cds,root_cells = root_cells )
```

manually choose 10 cells from Glia_1.1 with the smallest nGene values as 'root_cells',       
so that there are directions starting in color 0:'dark purple'.       

```{r echo=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, cds_umap3,fig.width=7}
plot_cells(cds,color_cells_by = "pseudotime",show_trajectory_graph = TRUE,group_label_size = 4.5,graph_label_size = 4,cell_size = 0.75)
```

```{r fig.height=4.5, message=FALSE, warning=FALSE, cds_umap4,fig.width=6.5}
DimPlot(ss2_glia.seur_traj, group.by = 'nGene', reduction = 'umap',cols = material.heat(1909)) + 
             labs(title = "nGene distribution")  + 
             guides(colour = guide_coloursteps(show.limits = TRUE,label=FALSE))
```
      
this pseudotime is highly related to nGene map,    
maybe ss2 expression level normalized by 'CPM' is naturally with 'nGene pattern',   
making this result nonsense. hope the following 10x data by 'UMI count' would provide support.    

     
according to analysis above, can't help to think if there are only two major groups, next check 'Glia_1 vs Glia_2/3'   
    
## DEGs of 'Glia_1 vs Glia_2/3'   

nuclei info     
```{r}
table(ss2_glia.cov$major)
```

    
### volcano plots   
    
```{r}
# quantile with step 0.05
test_quant.major <- data.frame(quantile(ss2_glia.masts_inlocal.major.filt1$alpha - ss2_glia.masts_inlocal.major.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.major) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.major.filt1$alpha - ss2_glia.masts_inlocal.major.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.6))
text(x=0:20*1.2+0.65,y=test_quant.major[,1]+0.02*test_quant.major[,1]/abs(test_quant.major[,1]),round(test_quant.major[,1],3),cex=0.7)
```

```{r eval=FALSE, include=FALSE}
# quantile with step 0.05
test_quant.major <- data.frame(quantile(ss2_glia.masts_inlocal.major.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.major) <- "ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.major.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.major[,1]+0.02*test_quant.major[,1]/abs(test_quant.major[,1]),round(test_quant.major[,1],3),cex=0.7)
```
    


```{r volcano_major1,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identGlia_1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identGlia_1"))$padjD)),
     pch=16,col="grey",
     main="Glia_1", xlab="DE coefficient (Glia_1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.major.filt1 %>% filter(contrast=="identGlia_1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.major.filt1 %>% filter(contrast=="identGlia_1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1"))$coefD+0.1,
                logP=-log10((ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1" ))$padjD)+0.8),
     (ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1"))$gene,cex=0.6)

legend(x=0,y=95,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_major2,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identGlia_23"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identGlia_23"))$padjD)),
     pch=16,col="grey",
     main="Glia_23", xlab="DE coefficient (Glia_23 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.major.filt1 %>% filter(contrast=="identGlia_23"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.major.filt1 %>% filter(contrast=="identGlia_23"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$coefD+0.06,
                logP=-log10((ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$padjD)+1.5),
     (ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23" ))$gene,cex=0.6)

legend(x=0,y=120,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```


### Glia_1 DEGs    
left group    

```{r ss2_glia_inpl_Glia_1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'K300',cells = grepl("Glia_1",ss2_glia.seur$K300), cols = c("#7CAE00","#F8766D"),
        pt.size = 0.5,label = T) + 
  labs(title = "ss2_glia inlocal new") + coord_cartesian(xlim = c(-50,42), ylim = c(-40,35)),
cols = 1)
```


```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1" ))$gene
```

(sorted by coefD, left -> right, up -> down)    
```{r feat_major1,fig.width=12,fig.height=47.25}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1" ))$gene[1:83], ncol = 4)
```

(sorted by coefD, up -> down, left -> right)    
```{r fig.height=30, message=FALSE, warning=FALSE, violin_major1,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1" ))$gene[1:20], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1"))$gene[21:40], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1"))$gene[41:60], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1"))$gene[61:80], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
cols = 4)
```

```{r fig.height=4.5, message=FALSE, warning=FALSE, violin_major1.1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_1" ))$gene[81:83], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6))
```

    
### Glia_23 DEGs    
right group    

```{r ss2_glia_inpl_Glia_23, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'K300',cells = grepl("Glia_2|Glia_3",ss2_glia.seur$K300), cols = c("#00BFC4","#C77CFF"),
        pt.size = 0.5,label = T) + 
  labs(title = "ss2_glia inlocal new") + coord_cartesian(xlim = c(-50,42), ylim = c(-40,35)),
cols = 1)
```


```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23" ))$gene
```

(sorted by coefD, left -> right, up -> down)     
```{r feat_major2_1,fig.width=12,fig.height=92.25}
FeaturePlot(ss2_glia.seur,
            (ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23" ))$gene[1:165],ncol = 4)
```


(sorted by coefD, up -> down, left -> right)    
```{r fig.height=49.5, message=FALSE, warning=FALSE, violin_major2_1,fig.width=10}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23" ))$gene[1:33], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$gene[34:66], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$gene[67:99], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$gene[100:132], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.major.filt2 %>% filter(contrast=="identGlia_23"))$gene[133:165], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.cov$major, 
            cells=rownames(ss2_glia.seur@meta.data), 
            ylim=c(0,6)),
cols = 5)
```
   

## DEGs of different conditions    

### Age    

nuclei with Age info     
```{r}
table(ss2_glia.seur@meta.data$Age_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_glia.masts_inlocal.Age.filt1$alpha - ss2_glia.masts_inlocal.Age.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Age.filt1$alpha - ss2_glia.masts_inlocal.Age.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.45))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.02*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=40,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age2, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=46,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Age_1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Age_Processed',label = F) + labs(title = "ss2_glia Age"),

cols = 1)
```
   
#### Age DEGs
    
##### Old upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene
```

```{r echo=FALSE, fig.height=9, message=FALSE, warning=FALSE, violin_Age1,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[1:6], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[7:12], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[13:18], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[19:24], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE, violin_Age1.1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[25:26], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6))
```

##### Young upregulated    
   
```{r}
(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r echo=FALSE,message=FALSE,warning=FALSE,violin_Age2,fig.width=8,fig.height=12}
multiplot(
  easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[1:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[9:16], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[17:24], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[25:32], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```
     
```{r echo=FALSE,message=FALSE,warning=FALSE,violin_Age21,fig.width=2,fig.height=4.5}
  easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[33:35], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6))
```
      
### Age_Glia1    

nuclei with Age info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Age_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_glia.masts_inlocal.Age_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Age_Glia1.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Age_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Age_Glia1.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.45))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.02*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age1_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1 %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1 %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identOld"))$padjD)+0.2),
     (ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=40,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age2_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1 %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1 %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.3),
     (ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=46,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Age_1_Glia1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(glia.colors.inlocal[1:2],rep("grey",2))) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Age_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_1",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Age_Glia1") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Age_Glia1 DEGs
    
##### Old upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identOld"))$gene
```

```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE, violin_Age1_Glia1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identOld"))$gene[1:2], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))

```


##### Young upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Age_Glia1.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r echo=FALSE,message=FALSE,warning=FALSE,violin_Age22Glia1,fig.width=2,fig.height=7.5}
  easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```

      
### Age_Glia23    

nuclei with Age info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2" |inlocal == "Glia_3"))$Age_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_glia.masts_inlocal.Age_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Age_Glia23.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Age_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Age_Glia23.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.3))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.01*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age1_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23 %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23 %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$padjD)+0.2),
     (ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=40,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age2_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23 %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23 %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.3),
     (ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=46,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Age_1_Glia23, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(rep("grey",2),glia.colors.inlocal[3:4])) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Age_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_2|Glia_3",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Age_Glia2/3") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Age_Glia23 DEGs
    
##### Old upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$gene
```

```{r echo=FALSE, fig.height=6, message=FALSE, warning=FALSE, violin_Age1_Glia23,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$gene[1:4], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$gene[5:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$gene[9:12], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identOld"))$gene[13:16], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)

```


##### Young upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r echo=FALSE,message=FALSE,warning=FALSE,violin_Age20,fig.width=8,fig.height=6}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$gene[1:4], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$gene[5:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$gene[9:12], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$gene[13:16], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE,message=FALSE,warning=FALSE,violin_Age21Glia23,fig.width=2,fig.height=4.5}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Age_Glia23.filt2 %>% filter(contrast=="identYoung"))$gene[17:19], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Age_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```


### Model    

##### should pass Model part, >99% nuclei from Sox10 mice        
   
nuclei with Model info   
```{r}
table(ss2_glia.seur@meta.data$Model_Processed)
```
    
```{r ss2_glia_Model_1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Model',label = F) + labs(title = "ss2_glia Model") +
  coord_fixed(ratio=0.94),
cols = 1)
```
    
### Segment    
    
nuclei with Segment info   
```{r}
table(ss2_glia.seur@meta.data$Segment_Processed)
```
    
```{r}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_glia.masts_inlocal.Segment.filt1$alpha - ss2_glia.masts_inlocal.Segment.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Segment.filt1$alpha - ss2_glia.masts_inlocal.Segment.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.02*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```
      
        
```{r volcano_Segment1, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$padjD)+1.6),
     (ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=85,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```    

```{r volcano_Segment2, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=5.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$padjD)+2.8),
     (ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=200,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  


```{r ss2_glia_Segment_1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Segment_Processed',label = F) + labs(title = "ss2_glia Segment"),
cols = 1)
```
   
#### Segment DEGs

##### Distal upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene
```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSegment=FALSE, violin_Segment1,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[1:3], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[4:6], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[7:9], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[10:12], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSegment=FALSE, violin_Segment1.1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[13:13], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6))
```

##### Proximal upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene
```

```{r echo=FALSE, fig.height=14.5, warning=FALSE, messSegment=FALSE, violin_Segment2,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[1:13], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[14:26], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[27:39], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[40:52], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```
   
    
      
### Segment_Glia1    

nuclei with Segment info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Segment_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_glia.masts_inlocal.Segment_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Segment_Glia1.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Segment_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Segment_Glia1.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.02*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```

```{r volcano_Segment1_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1 %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1 %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identDistal"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=35,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Segment2_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1 %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1 %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identProximal"))$padjD)+1.0),
     (ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=70,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Segment_1_Glia1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(glia.colors.inlocal[1:2],rep("grey",2))) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Segment_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_1",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Segment_Glia1") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Segment_Glia1 DEGs
    
##### Distal upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identDistal"))$gene
```

```{r echo=FALSE, fig.height=7.5, warning=FALSE, messSegment=FALSE, violin_Segment1_Glia1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identDistal"))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))

```


##### Proximal upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Segment_Glia1.filt2 %>% filter(contrast=="identProximal"))$gene
```

```{r echo=FALSE,messSegment=FALSE,warning=FALSE,violin_Segment23,fig.width=4,fig.height=4.5}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[1:3], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[4:6], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 2)
```

      
### Segment_Glia23    

nuclei with Segment info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2" |inlocal == "Glia_3"))$Segment_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_glia.masts_inlocal.Segment_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Segment_Glia23.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Segment_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Segment_Glia23.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.02*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```

```{r volcano_Segment1_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23 %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23 %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=48,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Segment2_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23 %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23 %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$padjD)+1.5),
     (ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=130,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Segment_1_Glia23, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(rep("grey",2),glia.colors.inlocal[3:4])) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Segment_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_2|Glia_3",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Segment_Glia2/3") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Segment_Glia23 DEGs
    
##### Distal upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messSegment=FALSE, violin_Segment1_Glia23,fig.width=4}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$gene[1:4], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identDistal"))$gene[5:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 2)

```


##### Proximal upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$gene
```

```{r echo=FALSE,messSegment=FALSE,warning=FALSE,violin_Segment2Glia23,fig.width=8,fig.height=12}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$gene[1:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$gene[9:16], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$gene[17:24], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$gene[25:32], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```
    
    
```{r echo=FALSE,messSegment=FALSE,warning=FALSE,violin_Segment21Glia23,fig.width=2,fig.height=3.2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Segment_Glia23.filt2 %>% filter(contrast=="identProximal"))$gene[33:34], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Segment_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```    
        
### Seg_raw   
   
nuclei with Seg_raw info ('All' excluded)   
```{r}
table(ss2_glia.seur@meta.data$Segment)
```
   
why calculate Seg1/2/3/4 separately while already have Distal/Proximal ?   
used to try different parameters to repeat DEG results in paper,      
for Segment part, still not sure how they did it, here just list results in both ways.   

    
```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_glia.masts_inlocal.Seg_raw.filt1$alpha - ss2_glia.masts_inlocal.Seg_raw.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Seg_raw.filt1$alpha - ss2_glia.masts_inlocal.Seg_raw.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.02*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),round(test_quant.Seg_raw[,1],3),cex=0.7)
```
    
```{r volcano_Seg_raw1, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$padjD)+1.8),
     (ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=80,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=55,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
#                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.8),
#     (ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=15,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$padjD)+1.5),
     (ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=100,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 
    
#### Seg_raw DEGs    
   

```{r ss2_glia_Seg_raw1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Segment',label = F) + labs(title = "ss2_glia Seg_raw") +
  coord_fixed(ratio=0.95),
cols = 1)
```

##### Seg3+4(Distal) upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```

```{r echo=FALSE, fig.height=10.5, warning=FALSE, messSegment=FALSE, violin_Seg34,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:7], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[8:14], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[15:21], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[22:28], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=7.5, warning=FALSE, messSegment=FALSE, violin_Seg34.1,fig.width=4}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[29:33], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[34:38], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
cols = 2)
```


##### Seg1+2(Proximal) upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```


```{r echo=FALSE, fig.height=16.5, warning=FALSE, messSegment=FALSE, violin_Seg12,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:15], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[16:30], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[31:45], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[46:60], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSegment=FALSE, violin_Seg12.1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[61:61], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6))
```        
        
        
### Seg_raw_Glia1   
    
nuclei with Seg_raw info ('All' excluded)   
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Segment)
```
      
```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.02*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),
     round(test_quant.Seg_raw[,1],3),cex=0.7)
```
    
```{r volcano_Seg_raw1_Glia1, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg1"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=24,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2_Glia1, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=22,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3_Glia1, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
#                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.8),
#     (ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=3.8,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1 %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg4"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=40,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 
        

#### Seg_raw DEGs    
   

```{r ss2_glia_Seg_raw1_Glia1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(glia.colors.inlocal[1:2],rep("grey",2))) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Segment',label = F, pt.size = 0.55,
        cells = grep("Glia_1",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Seg_raw_Glia1") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),
cols = 1)
```

##### Seg3+4(Distal) upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```

```{r echo=FALSE, fig.height=7.5, warning=FALSE, messSegment=FALSE, violin_Seg34_Glia1,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[6:10], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[11:15], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[16:20], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Seg34.1_Glia1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[21:22], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```


##### Seg1+2(Proximal) upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Seg_raw_Glia1.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```


```{r echo=FALSE, fig.height=10.5, warning=FALSE, messSegment=FALSE, violin_Seg12_Glia1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:7], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```

        
        
### Seg_raw_Glia23   
    
nuclei with Seg_raw info ('All' excluded)   
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2" |inlocal == "Glia_3"))$Segment)
```
      
```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.02*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),
     round(test_quant.Seg_raw[,1],3),cex=0.7)
```
    
```{r volcano_Seg_raw1_Glia23, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg1"))$padjD)+1.2),
     (ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=52,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2_Glia23, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=30,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3_Glia23, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
#                logP=-log10((ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.8),
#     (ss2_glia.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23 %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg4"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=60,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 
        

#### Seg_raw DEGs    
   

```{r ss2_glia_Seg_raw1_Glia23, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(rep("grey",2),glia.colors.inlocal[1:2])) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Segment',label = F, pt.size = 0.55,
        cells = grep("Glia_2|Glia_3",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Seg_raw_Glia2/3") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),
cols = 1)
```

##### Seg3+4(Distal) upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```

```{r echo=FALSE, fig.height=10.5, warning=FALSE, messSegment=FALSE, violin_Seg34_Glia23,fig.width=10}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:7], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[8:14], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[15:21], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[22:28], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[29:35], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```
  

##### Seg1+2(Proximal) upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Seg_raw_Glia23.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```


```{r echo=FALSE, fig.height=12, warning=FALSE, messSegment=FALSE, violin_Seg12_Glia23,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[9:16], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[17:24], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[25:32], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Seg12.1_Glia23,fig.width=2}

easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[33:34], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[ss2_glia.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```

### Sex    
  
nuclei with Sex info   
```{r}
table(ss2_glia.seur@meta.data$Sex_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_glia.masts_inlocal.Sex.filt1$alpha - ss2_glia.masts_inlocal.Sex.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Sex.filt1$alpha - ss2_glia.masts_inlocal.Sex.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.02*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (Male vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=5.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$padjD)+2.8),
     (ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=190,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Sex2, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey", xlim=c(0,3),
     main="Female", xlab="DE coefficient (Female vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$coefD+0.15,
                logP=-log10((ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=38,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r ss2_glia_Sex1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Sex_Processed',label = F) + labs(title = "ss2_glia Sex") +
  coord_fixed(ratio=0.97),
cols = 1)
```

   
#### Sex DEGs

##### Male upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messSegment=FALSE, violin_Sex1,fig.width=6}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene[1:4], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene[5:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene[9:12], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
cols = 3)
```

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messSegment=FALSE, violin_Sex2,fig.width=4}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene[1:4], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene[5:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),

cols = 2)
```

    
      
### Sex_Glia1    

nuclei with Sex info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Sex_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_glia.masts_inlocal.Sex_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Sex_Glia1.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Sex_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Sex_Glia1.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.02*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex1_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1 %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1 %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (M vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identM"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=55,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Sex2_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1 %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1 %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey",
     main="Female", xlab="DE coefficient (F vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=3.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identF"))$padjD)+5.0),
     (ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=280,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Sex_1_Glia1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(glia.colors.inlocal[1:2],rep("grey",2))) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Sex_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_1",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Sex_Glia1") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Sex_Glia1 DEGs
    
##### Male upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identM"))$gene
```

```{r echo=FALSE, fig.height=7.5, warning=FALSE, messSex=FALSE, violin_Sex1_Glia1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identM"))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))

```


##### Female upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Sex_Glia1.filt2 %>% filter(contrast=="identF"))$gene
```

```{r echo=FALSE, fig.height=3, warning=FALSE, messSex=FALSE, violin_Sex2_Glia1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene[1:2], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```

      
### Sex_Glia23    

nuclei with Sex info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2" |inlocal == "Glia_3"))$Sex_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_glia.masts_inlocal.Sex_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Sex_Glia23.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Sex_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Sex_Glia23.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.028*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex1_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23 %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23 %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (M vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=3.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$padjD)+2.5),
     (ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=145,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Sex2_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23 %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23 %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey",
     main="Female", xlab="DE coefficient (F vs. others)", ylab="-log10(adjusted p-value)",xlim=c(0,4))
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identF"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=25,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
   
here Two F specific genes strangely get too low padjD to be zero, so not plotted.   
```{r}
(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast == "identF"))[,c("gene","contrast","coefD","padjD")]
```
    
    
```{r ss2_glia_Sex_1_Glia23, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(rep("grey",2),glia.colors.inlocal[3:4])) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Sex_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_2|Glia_3",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Sex_Glia2/3") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Sex_Glia23 DEGs
    
##### Male upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$gene
```

```{r echo=FALSE, fig.height=7.5, warning=FALSE, messSex=FALSE, violin_Sex1_Glia23,fig.width=4}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identM"))$gene[6:10], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
cols = 2)

```


##### Female upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identF"))$gene
```

```{r echo=FALSE,messSex=FALSE,warning=FALSE,violin_Sex2_Glia23,fig.width=2,fig.height=7.5}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Sex_Glia23.filt2 %>% filter(contrast=="identF"))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6))
```
    
    
### Time    

nuclei with Time info   
```{r}
table(ss2_glia.seur@meta.data$Time_Processed)
```
   
    
```{r}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_glia.masts_inlocal.Time.filt1$alpha - ss2_glia.masts_inlocal.Time.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Time.filt1$alpha - ss2_glia.masts_inlocal.Time.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.45))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.012*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```


```{r volcano_Time1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$coefD+0.03,
                logP=-log10((ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$padjD)+1.55),
     (ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=105,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Time2, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey", xlim=c(0,2),
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$coefD+0.03,
                logP=-log10((ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$padjD)+1.55),
     (ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=95,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r ss2_glia_Time1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Time_Processed',label = F) + labs(title = "ss2_glia Time") +
  coord_fixed(ratio=0.95),
cols = 1)
```

   
#### Time DEGs


##### Evening upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene
```

```{r echo=FALSE, fig.height=7.5, warning=FALSE, messSegment=FALSE, violin_Time1,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[6:10], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[11:15], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[16:20], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSegment=FALSE, violin_Time1.1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[21:23], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6))
```

##### Morning upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene
```

```{r echo=FALSE, fig.height=9, warning=FALSE, messSegment=FALSE, violin_Time2,fig.width=8}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[1:6], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[7:12], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[13:18], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[19:24], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Time2.1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[25:26], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6))
```    
    
      
### Time_Glia1    

nuclei with Time info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_1"))$Time_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_glia.masts_inlocal.Time_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Time_Glia1.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Time_Glia1.filt1$alpha - ss2_glia.masts_inlocal.Time_Glia1.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.5))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.02*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```

```{r volcano_Time1_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1 %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1 %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identEvening"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=46,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Time2_Glia1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1 %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1 %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey",
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identMorning"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=46,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Time_1_Glia1, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(glia.colors.inlocal[1:2],rep("grey",2))) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Time_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_1",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Time_Glia1") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Time_Glia1 DEGs
    
##### Evening upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identEvening"))$gene
```

```{r echo=FALSE, fig.height=10.5, warning=FALSE, messTime=FALSE, violin_Time1_Glia1,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identEvening"))$gene[1:7], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))

```


##### Morning upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Time_Glia1.filt2 %>% filter(contrast=="identMorning"))$gene
```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messTime=FALSE, violin_Time2_Glia1,fig.width=6}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[1:3], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[4:6], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[7:9], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_1",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 3)
```

      
### Time_Glia23    

nuclei with Time info     
```{r}
table((ss2_glia.seur@meta.data %>% filter(inlocal == "Glia_2" |inlocal == "Glia_3"))$Time_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_glia.masts_inlocal.Time_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Time_Glia23.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_glia.masts_inlocal.Time_Glia23.filt1$alpha - ss2_glia.masts_inlocal.Time_Glia23.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.4))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.012*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```

```{r volcano_Time1_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23 %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23 %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.5),
     (ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=55,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Time2_Glia23, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23 %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23 %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey",
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$coefD+0.05,
                logP=-log10((ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.8),
     (ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=48,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_glia_Time_1_Glia23, fig.height=6, fig.width=4.25, warning=FALSE}
multiplot(
DimPlot(ss2_glia.seur, group.by = 'K300',label = T,
        cols = c(rep("grey",2),glia.colors.inlocal[3:4])) + labs(title = "ss2_glia inlocal new"),
DimPlot(ss2_glia.seur, group.by = 'Time_Processed',label = F, pt.size = 0.55,
        cells = grep("Glia_2|Glia_3",ss2_glia.cov$inlocal)) + 
  labs(title = "ss2_glia Time_Glia_2/3") + coord_fixed(xlim = c(-50,38), ylim = c(-40,35)),

cols = 1)
```
   
#### Time_Glia23 DEGs
    
##### Evening upregulated       

```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messTime=FALSE, violin_Time1_Glia23,fig.width=4}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$gene[1:4], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$gene[5:8], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 2)

```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messTime=FALSE, violin_Time1.1_Glia23,fig.width=2}
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identEvening"))$gene[9:11], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6))
```

##### Morning upregulated    
   
```{r eval=FALSE, include=FALSE}
(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$gene
```

```{r echo=FALSE,messTime=FALSE,warning=FALSE,violin_Time2_Glia23,fig.width=6,fig.height=7.5}
multiplot(
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$gene[1:5], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$gene[6:10], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_glia.seur,
            genes=(ss2_glia.masts_inlocal.Time_Glia23.filt2 %>% filter(contrast=="identMorning"))$gene[11:15], 
            data=ss2_glia.seur@assays[['RNA']]@data, 
            groups=ss2_glia.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_glia.seur@meta.data)[!is.na(ss2_glia.seur@meta.data[,"Time_Processed"]) &
                                                      grepl("Glia_2|Glia_3",ss2_glia.cov$inlocal)], 
            ylim=c(0,6)),
cols = 3)
```
    
  
ss2_glia part ends here.      






