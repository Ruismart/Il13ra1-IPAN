---
output: 
  html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
---
# ss2_neur part  
  
load all dependancies  
```{r message=FALSE, warning=FALSE}
source("analysis.r")
```
  
  
load seurat object from ss2_neur/glia sub-clustering results in previous page  
because ss2_neur has over 20 sub-clusters, more complicated than ss2_glia's, first to do ss2_glia        

```{r}
ss2_neur.seur <- readRDS("ss2_neur.seur.rds")
```

```{r eval=FALSE, include=FALSE}
ss2_neur.seur@meta.data$inlocal[ss2_neur.seur@meta.data$inlocal=="PSVN1"] <- "PSVN_1"
ss2_neur.seur@meta.data$inlocal[ss2_neur.seur@meta.data$inlocal=="PSVN2"] <- "PSVN_2"
```


## before differeital analysis  

before differential analysis, make sure the subclustering result is certain.   
(the real flow should be multiply repeated, checked over and over again)    
(here just trying to be similar to that described in paper)   

```{r ss2_neur_inpl, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
  DimPlot(ss2_neur.seur, group.by = 'Annotation', label = T) + labs(title = "ss2_neur inpaper"),
  DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T) + labs(title = "ss2_neur inlocal"),
  cols = 1
)
```
  
### five major groups: (1) PEMNs    

Chat+Tac1+ putative excitatory motor neurons (PEMNs)     
    
PINs and PSNs are also Chat+    
PIN_3/4 are also Chat+Tac1+    
  
```{r ss2_neur_PEMNs, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(neur.colors.inlocal_PEMN,rep("grey",18))) +
  labs(title = "ss2_neur inlocal PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Chat","Tac1"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```
    
```{r fig.height=6, message=FALSE, warning=FALSE, ChatTac1, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Chat", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,6),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Tac1", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,6),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```
    

### five major groups: (2) PIMNs    

Nos1+ putative inhibitory motor neurons (PIMNs)     

Nos1+Vip+, together coordinate muscle contraction and relaxation  

Vip+: PIMN_1/2/3/4, also PSVN_1   
    
```{r ss2_neur_PIMNs, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",7),neur.colors.inlocal_PIMN,rep("grey",10))) +
  labs(title = "ss2_neur inlocal PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Nos1","Vip"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```
    
```{r fig.height=6, message=FALSE, warning=FALSE, Nos1Vip, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Nos1", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,6),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Vip", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,8),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```    
    
    
### five major groups: (3) PSNs    

CGRP+ putative sensory neurons (PSNs)    
    
CGRP+ (calcitonin gene-related peptide producing), sense and respond to chemical and mechanical stimuli in the intestine   
    
Calca: hard to see on this kind of scatterplot because very few cells get high expression       
Calcb: also PIN_1/2   

    
```{r ss2_neur_PSNs, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",19),neur.colors.inlocal_PSN,rep("grey",2))) +
  labs(title = "ss2_neur inlocal PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Calca","Calcb"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```

```{r fig.height=6, message=FALSE, warning=FALSE, CalcaCalcb, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Calca", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Calcb", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,6),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```


##### but how about inpaper PSNs: inpaper PSN_4 contains most of inlocal PSN_3/4,     
while inpaper PSN_3 targeted most Calcb+ of inlocal PIN_1/2.   

```{r ss2_neur_PSNs.1, fig.height=4.6, fig.width=7.6, warning=FALSE}
DimPlot(ss2_neur.seur, group.by = 'Annotation', label = F, cols = c(rep("grey",15),neur.colors.inlocal_PSN,rep("grey",2))) +
  labs(title = "ss2_neur inpaper PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88)
```

```{r fig.height=6, message=FALSE, warning=FALSE, CalcaCalcb1, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Calca", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Annotation"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = neur.colors.inlocal[c(1:5,8:14,16:18,19:25)],
            color.point = rep("black",25)[c(1:5,8:14,16:18,19:25)]),
easy_violin(seur=ss2_neur.seur,
            genes="Calcb", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Annotation"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,6),
            color.fill = neur.colors.inlocal[c(1:5,8:14,16:18,19:25)],
            color.point = rep("black",25)[c(1:5,8:14,16:18,19:25)]),
cols = 1)
```


this issue reminds us that this inlocal clustering result may need an additional normalization,   
or some parameters ever used could be modified using a proper cutoff.    

anyway, for getting through the whole analysis and repeat the main conclusion as quickly as I can,    
after trying for a while,      
here just ingore issues like this to avoid that taking too much time to improve it without a clue but it wouldn't work better.   


### five major groups: (4) PINs    

Penk+ putative interneurons (PINs)    
    
Penk+ (the endogenous opioid, enkephalin), relay signals between neurons    
    
Penk: all PINs, also in some PEMNs, very few but high in PIMN_1    
Chat: all PINs          

    
```{r ss2_neur_PINs, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",15),neur.colors.inlocal_PIN,rep("grey",6))) +
  labs(title = "ss2_neur inlocal PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Penk","Chat"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```
    
```{r fig.height=6, message=FALSE, warning=FALSE, PenkChat, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Penk", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,8),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Chat", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```


### five major groups: (5) PSVNs    

Glp2r+ putative secretomotor/vasodilator neurons (PSVNs)    
    
Glp2r+ (the endogenous opioid, enkephalin), trigger secretions and fluid movement in other cell types       
    
Glp2r: uniquely high in PSVN_1/2    
Chat: also high in PSVN_2   
    
```{r ss2_neur_PSVNs, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",23),neur.colors.inlocal_PSVN)) +
  labs(title = "ss2_neur inlocal PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Glp2r","Chat"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```
    
```{r fig.height=6, message=FALSE, warning=FALSE, Glp2rChat, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Glp2r", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Chat", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```


### subclusters markers(?): (1) PEMNs    
    
Drd2 (the D2 dopamine receptor) in PEMN_3 ? here expressed in _4/6/7, not very high.   

```{r ss2_neur_PEMNs_1, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",3),neur.colors.inlocal_PEMN[4],rep("grey",1),neur.colors.inlocal_PEMN[6:7],rep("grey",18))) +
  labs(title = "ss2_neur inlocal PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Chat","Drd2"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```


```{r fig.height=3, message=FALSE, warning=FALSE, Drd2, fig.width=12}
easy_violin(seur=ss2_neur.seur,
            genes="Drd2", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25))
```


### subclusters markers(?): (2) PIMNs    
   
Adm (adrenomedullin)    
Lgr5 (leucine rich repeat containing G protein coupled receptor 5)  
  
```{r ss2_neur_PIMNs_1, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",7),neur.colors.inlocal_PIMN[1:4],rep("grey",14))) +
  labs(title = "ss2_neur inlocal PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Adm","Lgr5"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```

```{r fig.height=6, message=FALSE, warning=FALSE, Adm, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Adm", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Lgr5", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```


### subclusters markers(?): (3) PSNs    
    
Cck (cholecystokinin)   
Vip (vasoactive intestinal polypeptide)   
Bdnf (brain-derived neurotrophic factor)    
Piezo2 (a mechanosensitive ion channel that may regulate smooth muscle tone )   
   
```{r ss2_neur_PSNs_1, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",21),neur.colors.inlocal_PSN[3:4],rep("grey",2))) +
  labs(title = "ss2_neur inlocal PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Cck","Vip","Bdnf","Piezo2"),ncol = 2,coord.fixed = 0.88) ,
cols = 1)
```
    
same issue for PSNs, PSN_4 mixed with PIN_1/2    
    
```{r fig.height=12, message=FALSE, warning=FALSE, Cck, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Cck", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Vip", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,8),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Bdnf", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,2),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Piezo2", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```
    
Nog (Noggin)    
Nmu (Neuromedin U)    
Il4ra (the interleukin-13 (IL-13) receptor )    
Il13ra1 (the interleukin-13 (IL-13) receptor )    
Il7 (a major regulator of ILCs and T cells )    
   
    
```{r ss2_neur_PSNs_2, fig.height=16.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",19),neur.colors.inlocal_PSN[1],rep("grey",5))) +
  labs(title = "ss2_neur inlocal PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Nog","Nmu","Il4ra","Il13ra1","Il7"),ncol = 2,coord.fixed = 0.88) ,
cols = 1)
```

```{r fig.height=15, message=FALSE, warning=FALSE, Nog, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Nog", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,1.5),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Nmu", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,5),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Il4ra", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Il13ra1", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Il7", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```
    
    

### subclusters markers(?): (4) PINs    
   
prlr (the prolactin receptor)     
Mtnr1a (the melatonin receptor)    
   
```{r ss2_neur_PINs_1, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",17),neur.colors.inlocal_PIN[3],rep("grey",7))) +
  labs(title = "ss2_neur inlocal PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Prlr","Mtnr1a"),ncol = 2) + coord_fixed(ratio=0.88),
cols = 1)
```

```{r fig.height=6, message=FALSE, warning=FALSE, Prlr, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Prlr", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Mtnr1a", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```

### subclusters markers(?): (5) PSVNs    
    
Fst (follistatin)    
Csf2rb (the Csf2 receptor)    
Csf2rb2 (the Csf2 receptor)    
    

```{r ss2_neur_PSVNs_1, fig.height=9.2, fig.width=7.6, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T, cols = c(rep("grey",23),neur.colors.inlocal_PSVN)) +
  labs(title = "ss2_neur inlocal PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
FeaturePlot(ss2_neur.seur, c("Glp2r","Fst","Csf2rb","Csf2rb2"),ncol = 2,coord.fixed =0.88) ,
cols = 1)
```

```{r fig.height=12, message=FALSE, warning=FALSE, Fst, fig.width=12}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes="Glp2r", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,4),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Fst", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,3),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Csf2rb", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,2),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
easy_violin(seur=ss2_neur.seur,
            genes="Csf2rb2", 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"inlocal"], 
            cells=rownames(ss2_neur.seur@meta.data), 
            do.facet=FALSE,
            facet_by = NULL, 
            ylim=c(0,1.5),
            color.fill = neur.colors.inlocal,
            color.point = rep("black",25)),
cols = 1)
```



#### noticed  

differences of subclustering noticed:    
     
in previous analysis page of ss2_neur subclustering      
    
comparing to inpaper Annotations,    
inlocal got mainly matched five major groups, but in each major group, subgroups partly mixed with each other    
    
here just keep it and move on to the next step.   
differential analysis would add contrasts between five major groups.    

```{r ss2_neur_phenocount3, fig.height= 4.8, fig.width=8.3}
pheno_neur <- read.table("pheno_neur.ss2.csv",sep=",")
subclust_neur <- data.frame(inlocal=paste0(c(paste0("PEMN_",1:7),paste0("PIMN_",1:8),paste0("PIN_",1:4),paste0("PSN_",1:4),paste0("PSVN_",1:2))),
                            raw=paste0("pheno_",c(7,12,22,1,16,20,6,21,4,5,0,2,3,10,23,8,14,17,13,19,24,11,15,18,9)))

pheatmap::pheatmap(pheno_neur[,c(subclust_neur$raw,"count")] %>% 
                     mutate_all(as.numeric), 
                   cluster_rows = F, cluster_cols = F, breaks = seq(0,300,3),
                   display_numbers =T, number_format = '%.0f', labels_row= rownames(pheno_neur),
                   labels_col = c(paste0(subclust_neur$inlocal,"_inlocal"),"count"),
                   gaps_col = c(7,15,19,23,25), gaps_row = c(5,12,15,19,21))
```

    
    
## test nGene distribution.   
    
```{r ss2_neur_inpl3, fig.height=4.8, fig.width=5.8, warning=FALSE}
DimPlot(ss2_neur.seur, group.by = 'nGene', cols = material.heat(1909)) + labs(title = "Number of genes")  + 
             guides(colour = guide_coloursteps(ticks = FALSE,show.limits = TRUE,label=FALSE))
```
    
##### sorry for still unavailable to add scale mark on the colorbar because of the conflicts of data formats inside.    
##### up from 'colorbar: lightblue' should be 'nGene: 6000+'    
    
```{r}
cat("nGene quantile statistics of ss2_neur: \n" ); quantile(as.numeric(ss2_neur.seur@meta.data$nGene), probs=seq(0.01,1,0.1))
```

next just show nGene distribution of each major group,   
with large chunks of boring code hided. (similar to ss2_glia nGene part)       

```{r warning=FALSE,nGene0,fig.width=8,fig.height=6}
h <- hist(as.numeric(ss2_neur.seur@meta.data$nGene), breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,250), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,250), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,250), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,250), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,250), plot = F)
h5 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,250), plot = F)

d <- density(as.numeric(ss2_neur.seur@meta.data$nGene))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]))
d5 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN",ss2_neur.seur@meta.data$inlocal)]))

title(paste0("nGene distribution for ss2_neur:  five major groups"))
lines(x = d$x, y=d$y* length(as.numeric(ss2_neur.seur@meta.data$nGene))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,250))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=neur.colors.inlocal_PEMN[1],lwd=3, xlim = c(0,12300), ylim = c(0,250))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=neur.colors.inlocal_PIMN[1],lwd=3, xlim = c(0,12300), ylim = c(0,250))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=neur.colors.inlocal_PIN[1],lwd=3, xlim = c(0,12300), ylim = c(0,250))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=neur.colors.inlocal_PSN[1],lwd=3, xlim = c(0,12300), ylim = c(0,250))
lines(x = d5$x, y=d5$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN",ss2_neur.seur@meta.data$inlocal)]))* diff(h5$breaks)[1],
      col=neur.colors.inlocal_PSVN[1],lwd=3, xlim = c(0,12300), ylim = c(0,250))
legend(x=0,y=250,cex = 0.75,legend = c("ALL","PEMNs","PIMNs","PINs","PSNs","PSVNs"), lty = c(1,1,1,1,1,1),lwd = c(rep(2,6)),
      col = c("black",neur.colors.inlocal_PEMN[1],neur.colors.inlocal_PIMN[1],neur.colors.inlocal_PIN[1],
              neur.colors.inlocal_PSN[1],neur.colors.inlocal_PSVN[1]) )
```
    
totally the five major groups have no obvious bias on nGene distributions.  
    
### test nGene distribution: PEMNs    

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene1.1,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = F)
h5 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_5",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = F)
h6 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_6",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = F)
h7 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_7",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,60), plot = F)


d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_4",ss2_neur.seur@meta.data$inlocal)]))
d5 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_5",ss2_neur.seur@meta.data$inlocal)]))
d6 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_6",ss2_neur.seur@meta.data$inlocal)]))
d7 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_7",ss2_neur.seur@meta.data$inlocal)]))

title(paste0("nGene distribution for ss2_neur:  PEMNs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,60))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,60))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,60))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,60))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,60))
lines(x = d5$x, y=d5$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_5",ss2_neur.seur@meta.data$inlocal)]))* diff(h5$breaks)[1],
      col=material.heat(8)[5],lwd=3, xlim = c(0,12300), ylim = c(0,60))
lines(x = d6$x, y=d6$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_6",ss2_neur.seur@meta.data$inlocal)]))* diff(h6$breaks)[1],
      col=material.heat(8)[6],lwd=3, xlim = c(0,12300), ylim = c(0,60))
lines(x = d7$x, y=d7$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_7",ss2_neur.seur@meta.data$inlocal)]))* diff(h7$breaks)[1],
      col=material.heat(8)[7],lwd=3, xlim = c(0,12300), ylim = c(0,60))


legend(x=0,y=60,cex = 0.75,legend = c("PEMNs",paste0("PEMN_",1:7)), lty = c(rep(1,8)),lwd = c(rep(2,8)),
      col = c("black",material.heat(8)) )
```

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene1.2,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = F)
h5 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_5",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = F)
h6 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_6",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = F)
h7 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_7",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,12), plot = F)


d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_4",ss2_neur.seur@meta.data$inlocal)]))
d5 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_5",ss2_neur.seur@meta.data$inlocal)]))
d6 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_6",ss2_neur.seur@meta.data$inlocal)]))
d7 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_7",ss2_neur.seur@meta.data$inlocal)]))

title(paste0("nGene distribution for ss2_neur:  PEMNs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,12))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,12))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,12))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,12))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,12))
lines(x = d5$x, y=d5$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_5",ss2_neur.seur@meta.data$inlocal)]))* diff(h5$breaks)[1],
      col=material.heat(8)[5],lwd=3, xlim = c(0,12300), ylim = c(0,12))
lines(x = d6$x, y=d6$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_6",ss2_neur.seur@meta.data$inlocal)]))* diff(h6$breaks)[1],
      col=material.heat(8)[6],lwd=3, xlim = c(0,12300), ylim = c(0,12))
lines(x = d7$x, y=d7$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PEMN_7",ss2_neur.seur@meta.data$inlocal)]))* diff(h7$breaks)[1],
      col=material.heat(8)[7],lwd=3, xlim = c(0,12300), ylim = c(0,12))


legend(x=0,y=12,cex = 0.75,legend = c("PEMNs",paste0("PEMN_",1:7)), lty = c(rep(1,8)),lwd = c(rep(2,8)),
      col = c("black",material.heat(8)) )
```


### test nGene distribution: PIMNs    

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene2.1,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)
h5 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_5",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)
h6 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_6",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)
h7 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_7",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)
h8 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_8",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,130), plot = F)

d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_4",ss2_neur.seur@meta.data$inlocal)]))
d5 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_5",ss2_neur.seur@meta.data$inlocal)]))
d6 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_6",ss2_neur.seur@meta.data$inlocal)]))
d7 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_7",ss2_neur.seur@meta.data$inlocal)]))
d8 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_8",ss2_neur.seur@meta.data$inlocal)]))

title(paste0("nGene distribution for ss2_neur:  PIMNs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d5$x, y=d5$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_5",ss2_neur.seur@meta.data$inlocal)]))* diff(h5$breaks)[1],
      col=material.heat(8)[5],lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d6$x, y=d6$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_6",ss2_neur.seur@meta.data$inlocal)]))* diff(h6$breaks)[1],
      col=material.heat(8)[6],lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d7$x, y=d7$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_7",ss2_neur.seur@meta.data$inlocal)]))* diff(h7$breaks)[1],
      col=material.heat(8)[7],lwd=3, xlim = c(0,12300), ylim = c(0,130))
lines(x = d8$x, y=d8$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_8",ss2_neur.seur@meta.data$inlocal)]))* diff(h8$breaks)[1],
      col=material.heat(8)[8],lwd=3, xlim = c(0,12300), ylim = c(0,130))

legend(x=0,y=130,cex = 0.75,legend = c("PIMNs",paste0("PIMN_",1:8)), lty = c(rep(1,9)),lwd = c(rep(2,9)),
      col = c("black",material.heat(8)) )
```

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene2.2,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)
h5 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_5",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)
h6 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_6",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)
h7 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_7",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)
h8 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_8",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,15), plot = F)

d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_4",ss2_neur.seur@meta.data$inlocal)]))
d5 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_5",ss2_neur.seur@meta.data$inlocal)]))
d6 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_6",ss2_neur.seur@meta.data$inlocal)]))
d7 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_7",ss2_neur.seur@meta.data$inlocal)]))
d8 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_8",ss2_neur.seur@meta.data$inlocal)]))

title(paste0("nGene distribution for ss2_neur:  PIMNs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d5$x, y=d5$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_5",ss2_neur.seur@meta.data$inlocal)]))* diff(h5$breaks)[1],
      col=material.heat(8)[5],lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d6$x, y=d6$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_6",ss2_neur.seur@meta.data$inlocal)]))* diff(h6$breaks)[1],
      col=material.heat(8)[6],lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d7$x, y=d7$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_7",ss2_neur.seur@meta.data$inlocal)]))* diff(h7$breaks)[1],
      col=material.heat(8)[7],lwd=3, xlim = c(0,12300), ylim = c(0,15))
lines(x = d8$x, y=d8$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIMN_8",ss2_neur.seur@meta.data$inlocal)]))* diff(h8$breaks)[1],
      col=material.heat(8)[8],lwd=3, xlim = c(0,12300), ylim = c(0,15))

legend(x=0,y=15,cex = 0.75,legend = c("PIMNs",paste0("PIMN_",1:8)), lty = c(rep(1,9)), lwd = c(rep(2,9)),
      col = c("black",material.heat(8)) )
```


### test nGene distribution: PSNs    

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene3.1,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,23), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,23), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,23), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,23), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,23), plot = F)


d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_4",ss2_neur.seur@meta.data$inlocal)]))


title(paste0("nGene distribution for ss2_neur:  PSNs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,23))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,23))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,23))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,23))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,23))


legend(x=0,y=23,cex = 0.75,legend = c("PSNs",paste0("PSN_",1:4)), lty = c(rep(1,5)),lwd = c(rep(2,5)),
      col = c("black",material.heat(8)) )
```

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene3.2,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,5), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,5), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,5), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,5), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,5), plot = F)


d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_4",ss2_neur.seur@meta.data$inlocal)]))


title(paste0("nGene distribution for ss2_neur:  PSNs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,5))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,5))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,5))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,5))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,5))


legend(x=0,y=5,cex = 0.75,legend = c("PSNs",paste0("PSN_",1:4)), lty = c(rep(1,5)),lwd = c(rep(2,5)),
      col = c("black",material.heat(8)) )
```
    
       
### test nGene distribution: PINs    

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene4.1,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,30), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,30), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,30), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,30), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,30), plot = F)


d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_4",ss2_neur.seur@meta.data$inlocal)]))


title(paste0("nGene distribution for ss2_neur:  PINs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,30))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,30))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,30))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,30))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,30))


legend(x=0,y=30,cex = 0.75,legend = c("PINs",paste0("PIN_",1:4)), lty = c(rep(1,5)),lwd = c(rep(2,5)),
      col = c("black",material.heat(8)) )
```

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene4.2,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,7), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,7), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,7), plot = F)
h3 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_3",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,7), plot = F)
h4 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_4",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,7), plot = F)


d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_2",ss2_neur.seur@meta.data$inlocal)]))
d3 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_3",ss2_neur.seur@meta.data$inlocal)]))
d4 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_4",ss2_neur.seur@meta.data$inlocal)]))


title(paste0("nGene distribution for ss2_neur:  PINs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,7))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,7))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,7))
lines(x = d3$x, y=d3$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_3",ss2_neur.seur@meta.data$inlocal)]))* diff(h3$breaks)[1],
      col=material.heat(8)[3],lwd=3, xlim = c(0,12300), ylim = c(0,7))
lines(x = d4$x, y=d4$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PIN_4",ss2_neur.seur@meta.data$inlocal)]))* diff(h4$breaks)[1],
      col=material.heat(8)[4],lwd=3, xlim = c(0,12300), ylim = c(0,7))


legend(x=0,y=7,cex = 0.75,legend = c("PINs",paste0("PIN_",1:4)), lty = c(rep(1,5)),lwd = c(rep(2,5)),
      col = c("black",material.heat(8)) )
```       
    
   
### test nGene distribution: PSVNs    

```{r echo=FALSE, fig.height=6, warning=FALSE, nGene5.1,fig.width=8}
h <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN",ss2_neur.seur@meta.data$inlocal)]), 
          breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,10), plot = T)
h1 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN_1",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,10), plot = F)
h2 <- hist(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN_2",ss2_neur.seur@meta.data$inlocal)]), 
                      breaks = 50, xlab="", main="", xlim = c(0,12300), ylim = c(0,10), plot = F)



d <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN",ss2_neur.seur@meta.data$inlocal)]))
d1 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN_1",ss2_neur.seur@meta.data$inlocal)]))
d2 <- density(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN_2",ss2_neur.seur@meta.data$inlocal)]))



title(paste0("nGene distribution for ss2_neur:  PSVNs"))
lines(x = d$x, y=d$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN",ss2_neur.seur@meta.data$inlocal)]))* diff(h$breaks)[1],
      col="black",lwd=3, xlim = c(0,12300), ylim = c(0,10))
lines(x = d1$x, y=d1$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN_1",ss2_neur.seur@meta.data$inlocal)]))* diff(h1$breaks)[1],
      col=material.heat(8)[1],lwd=3, xlim = c(0,12300), ylim = c(0,10))
lines(x = d2$x, y=d2$y* length(as.numeric((ss2_neur.seur@meta.data$nGene)[grep("PSVN_2",ss2_neur.seur@meta.data$inlocal)]))* diff(h2$breaks)[1],
      col=material.heat(8)[2],lwd=3, xlim = c(0,12300), ylim = c(0,10))



legend(x=0,y=10,cex = 0.75,legend = c("PSVNs",paste0("PSVN_",1:2)), lty = c(rep(1,3)),lwd = c(rep(2,3)),
      col = c("black",material.heat(8)) )
```
    
    
##### nGene of ss2_neur subgroups have complex differences, at present nothing further to say about it.     
    
```{r eval=FALSE, include=FALSE}
material.heat(8)
```


```{r eval=FALSE, include=FALSE}
sort(unique(ss2_neur.seur@meta.data$inlocal))
```



## differential analysis

test with MAST, fit a hurdle model,      
for mouse colon atlas,  
fit Yi with covariate:    
   
 Yi : standardzed log2(TP10K+1) expression vector for gene i across cells  
 X : variable reflecting cell subset membership (e.g. PSNs versus non-PSNs)   
 A : age associated with each cell (aged versus adult)  
 C : circadian phase for each cell (evening versus morning)  
 L : location for each cell (distal versus proximal)  
 S : sex for each cell (male versus female)  
 T : mouse model for each cell (Uchl1 versus Sox10)  
 N: scaled number of genes for each cell (i.e., cell complexity)   

    
to find DEGs between different conditions, used to add covariates, but got quite different results comparing to inpaper's  
(ss2_neur, similar - different: Segment > Time > Age)  
here just without other covariates except nGene  

to find DEGs between sub-clusters, add covariates which would have effect on the comparison to do a regression to decrease the putative effects,     
    
to filter for final unique DEGs between sub-clusters, inpaper calculates the next highest values for each highly-regulated gene     
but the results are confused and lack exact cutoffs of parameters to get a very close DEG list (which is always a tricky process)     
     
add one more kind of contrasts between five major groups !    
add condition contrasts on major group !     

```{r}
# build covariates dataframe
#     
ss2_neur.cov <- data.frame(inlocal = factor(as.character(ss2_neur.seur@meta.data$inlocal)),
                           inpaper = factor(as.character(ss2_neur.seur@meta.data$Annotation)),
                           Age = factor(as.character(ss2_neur.seur@meta.data$Age_Processed), levels = c("Old","Young")),
                           Time = as.character(ss2_neur.seur@meta.data$Time_Processed),
                           Segment = factor(as.character(ss2_neur.seur@meta.data$Segment_Processed), levels = c("Distal","Proximal")),
                           Seg_raw = as.character(ss2_neur.seur@meta.data$Segment),
                           Sex = factor(as.character(ss2_neur.seur@meta.data$Sex_Processed), levels = c("M","F")),
                           Model = factor(as.character(ss2_neur.seur@meta.data$Model_Processed), levels = c("Uchl1","Sox10")),
                           nGene = scale(as.numeric(ss2_neur.seur@meta.data$nGene)),
                           Sample = factor(rownames(ss2_neur.seur@meta.data)))
ss2_neur.cov$Time[ss2_neur.cov$Time=="7AM"] <- "Morning"
ss2_neur.cov$Time[ss2_neur.cov$Time=="7PM"] <- "Evening"
ss2_neur.cov$Time <- factor(ss2_neur.cov$Time, levels = c("Evening","Morning"))
ss2_neur.cov$Seg_raw[ss2_neur.cov$Seg_raw=="1"] <- "Seg1"
ss2_neur.cov$Seg_raw[ss2_neur.cov$Seg_raw=="2"] <- "Seg2"
ss2_neur.cov$Seg_raw[ss2_neur.cov$Seg_raw=="3"] <- "Seg3"
ss2_neur.cov$Seg_raw[ss2_neur.cov$Seg_raw=="4"] <- "Seg4"
ss2_neur.cov$Seg_raw <- factor(ss2_neur.cov$Seg_raw, levels = c("Seg1","Seg2","Seg3","Seg4"))

rownames(ss2_neur.cov) <- as.character(ss2_neur.cov$Sample)

ss2_neur.cov$major <- as.character(ss2_neur.seur@meta.data$inlocal)
for(maj in c("PEMN","PIMN","PIN","PSN","PSVN")){
  ss2_neur.cov$major[grep(maj,ss2_neur.cov$major)] <- paste0(maj,"s")
}
ss2_neur.cov$major <- factor(ss2_neur.cov$major)

#ss2_neur.cov
```

```{r}
#write.table(ss2_neur.cov,"ss2_neur.cov.csv",col.names = TRUE,row.names = FALSE,quote = FALSE,sep=",")
```



differential analysis with MAST  
```{r}
# inlocal
#ss2_neur.masts_inlocal <- sapply(levels(factor(ss2_neur.cov$inlocal)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$inlocal == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Age","Time","Segment","Sex","Model","Sample")], 
#                 formula='~ nGene + ident + Age + Time + Segment + Sex + Model', 
#                lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal <- do.call(rbind,ss2_neur.masts_inlocal)

# major

#ss2_neur.masts_inlocal.major <- sapply(levels(factor(ss2_neur.cov$major)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$major == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Age","Time","Segment","Sex","Model","Sample")], 
#                 formula='~ nGene + ident + Age + Time + Segment + Sex + Model', 
#                lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.major <- do.call(rbind,ss2_neur.masts_inlocal.major)

# conditions
# Age
#ss2_neur.masts_inlocal.Age <- sapply(levels(factor(ss2_neur.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Age))]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Age <- do.call(rbind,ss2_neur.masts_inlocal.Age)

# Age_PEMNs
#ss2_neur.masts_inlocal.Age_PEMNs <- sapply(levels(factor(ss2_neur.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Age)) & (ss2_neur.cov$major == "PEMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Age_PEMNs <- do.call(rbind,ss2_neur.masts_inlocal.Age_PEMNs)
    
# Age_PIMNs
#ss2_neur.masts_inlocal.Age_PIMNs <- sapply(levels(factor(ss2_neur.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Age)) & (ss2_neur.cov$major == "PIMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Age_PIMNs <- do.call(rbind,ss2_neur.masts_inlocal.Age_PIMNs)
    
# Age_PINs
#ss2_neur.masts_inlocal.Age_PINs <- sapply(levels(factor(ss2_neur.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Age)) & (ss2_neur.cov$major == "PINs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Age_PINs <- do.call(rbind,ss2_neur.masts_inlocal.Age_PINs)
    
# Age_PSNs
#ss2_neur.masts_inlocal.Age_PSNs <- sapply(levels(factor(ss2_neur.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Age)) & (ss2_neur.cov$major == "PSNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Age_PSNs <- do.call(rbind,ss2_neur.masts_inlocal.Age_PSNs)
    
# Age_PSVNs
#ss2_neur.masts_inlocal.Age_PSVNs <- sapply(levels(factor(ss2_neur.cov$Age)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Age == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Age)) & (ss2_neur.cov$major == "PSVNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Age_PSVNs <- do.call(rbind,ss2_neur.masts_inlocal.Age_PSVNs)
    

# Time
#ss2_neur.masts_inlocal.Time <- sapply(levels(factor(ss2_neur.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Time))]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Time <- do.call(rbind,ss2_neur.masts_inlocal.Time)

# Time_PEMNs
#ss2_neur.masts_inlocal.Time_PEMNs <- sapply(levels(factor(ss2_neur.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Time)) & (ss2_neur.cov$major == "PEMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Time_PEMNs <- do.call(rbind,ss2_neur.masts_inlocal.Time_PEMNs)
    
# Time_PIMNs
#ss2_neur.masts_inlocal.Time_PIMNs <- sapply(levels(factor(ss2_neur.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Time)) & (ss2_neur.cov$major == "PIMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Time_PIMNs <- do.call(rbind,ss2_neur.masts_inlocal.Time_PIMNs)
    
# Time_PINs
#ss2_neur.masts_inlocal.Time_PINs <- sapply(levels(factor(ss2_neur.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Time)) & (ss2_neur.cov$major == "PINs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Time_PINs <- do.call(rbind,ss2_neur.masts_inlocal.Time_PINs)
    
# Time_PSNs
#ss2_neur.masts_inlocal.Time_PSNs <- sapply(levels(factor(ss2_neur.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Time)) & (ss2_neur.cov$major == "PSNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Time_PSNs <- do.call(rbind,ss2_neur.masts_inlocal.Time_PSNs)
    
# Time_PSVNs
#ss2_neur.masts_inlocal.Time_PSVNs <- sapply(levels(factor(ss2_neur.cov$Time)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Time == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Time)) & (ss2_neur.cov$major == "PSVNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Time_PSVNs <- do.call(rbind,ss2_neur.masts_inlocal.Time_PSVNs)
    

# Segment
#ss2_neur.masts_inlocal.Segment <- sapply(levels(factor(ss2_neur.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Segment))]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Segment <- do.call(rbind,ss2_neur.masts_inlocal.Segment)

# Segment_PEMNs
#ss2_neur.masts_inlocal.Segment_PEMNs <- sapply(levels(factor(ss2_neur.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Segment)) & (ss2_neur.cov$major == "PEMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Segment_PEMNs <- do.call(rbind,ss2_neur.masts_inlocal.Segment_PEMNs)
    
# Segment_PIMNs
#ss2_neur.masts_inlocal.Segment_PIMNs <- sapply(levels(factor(ss2_neur.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Segment)) & (ss2_neur.cov$major == "PIMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Segment_PIMNs <- do.call(rbind,ss2_neur.masts_inlocal.Segment_PIMNs)
    
# Segment_PINs
#ss2_neur.masts_inlocal.Segment_PINs <- sapply(levels(factor(ss2_neur.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Segment)) & (ss2_neur.cov$major == "PINs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Segment_PINs <- do.call(rbind,ss2_neur.masts_inlocal.Segment_PINs)
    
# Segment_PSNs
#ss2_neur.masts_inlocal.Segment_PSNs <- sapply(levels(factor(ss2_neur.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Segment)) & (ss2_neur.cov$major == "PSNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Segment_PSNs <- do.call(rbind,ss2_neur.masts_inlocal.Segment_PSNs)
    
# Segment_PSVNs
#ss2_neur.masts_inlocal.Segment_PSVNs <- sapply(levels(factor(ss2_neur.cov$Segment)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Segment == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Segment)) & (ss2_neur.cov$major == "PSVNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Segment_PSVNs <- do.call(rbind,ss2_neur.masts_inlocal.Segment_PSVNs)
    

# Seg_raw
#ss2_neur.masts_inlocal.Seg_raw <- sapply(levels(factor(ss2_neur.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Seg_raw))]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Seg_raw <- do.call(rbind,ss2_neur.masts_inlocal.Seg_raw)
    
# Seg_raw_PEMNs
#ss2_neur.masts_inlocal.Seg_raw_PEMNs <- sapply(levels(factor(ss2_neur.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Seg_raw)) &(ss2_neur.cov$major == "PEMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Seg_raw_PEMNs <- do.call(rbind,ss2_neur.masts_inlocal.Seg_raw_PEMNs)
     
# Seg_raw_PIMNs
#ss2_neur.masts_inlocal.Seg_raw_PIMNs <- sapply(levels(factor(ss2_neur.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Seg_raw)) &(ss2_neur.cov$major == "PIMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Seg_raw_PIMNs <- do.call(rbind,ss2_neur.masts_inlocal.Seg_raw_PIMNs)
     
# Seg_raw_PINs
#ss2_neur.masts_inlocal.Seg_raw_PINs <- sapply(levels(factor(ss2_neur.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Seg_raw)) &(ss2_neur.cov$major == "PINs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Seg_raw_PINs <- do.call(rbind,ss2_neur.masts_inlocal.Seg_raw_PINs)
     
# Seg_raw_PSNs
#ss2_neur.masts_inlocal.Seg_raw_PSNs <- sapply(levels(factor(ss2_neur.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Seg_raw)) &(ss2_neur.cov$major == "PSNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Seg_raw_PSNs <- do.call(rbind,ss2_neur.masts_inlocal.Seg_raw_PSNs)
     
# Seg_raw_PSVNs
#ss2_neur.masts_inlocal.Seg_raw_PSVNs <- sapply(levels(factor(ss2_neur.cov$Seg_raw)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Seg_raw == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Seg_raw)) &(ss2_neur.cov$major == "PSVNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Seg_raw_PSVNs <- do.call(rbind,ss2_neur.masts_inlocal.Seg_raw_PSVNs)
     
# Sex
#ss2_neur.masts_inlocal.Sex <- sapply(levels(factor(ss2_neur.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Sex))]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Sex <- do.call(rbind,ss2_neur.masts_inlocal.Sex)

# Sex_PEMNs
#ss2_neur.masts_inlocal.Sex_PEMNs <- sapply(levels(factor(ss2_neur.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Sex)) & (ss2_neur.cov$major == "PEMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Sex_PEMNs <- do.call(rbind,ss2_neur.masts_inlocal.Sex_PEMNs)
    
# Sex_PIMNs
#ss2_neur.masts_inlocal.Sex_PIMNs <- sapply(levels(factor(ss2_neur.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Sex)) & (ss2_neur.cov$major == "PIMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Sex_PIMNs <- do.call(rbind,ss2_neur.masts_inlocal.Sex_PIMNs)
    
# Sex_PINs
#ss2_neur.masts_inlocal.Sex_PINs <- sapply(levels(factor(ss2_neur.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Sex)) & (ss2_neur.cov$major == "PINs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Sex_PINs <- do.call(rbind,ss2_neur.masts_inlocal.Sex_PINs)
    
# Sex_PSNs
#ss2_neur.masts_inlocal.Sex_PSNs <- sapply(levels(factor(ss2_neur.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Sex)) & (ss2_neur.cov$major == "PSNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Sex_PSNs <- do.call(rbind,ss2_neur.masts_inlocal.Sex_PSNs)
    
# Sex_PSVNs
#ss2_neur.masts_inlocal.Sex_PSVNs <- sapply(levels(factor(ss2_neur.cov$Sex)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Sex == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Sex)) & (ss2_neur.cov$major == "PSVNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Sex_PSVNs <- do.call(rbind,ss2_neur.masts_inlocal.Sex_PSVNs)
    
# Model
#ss2_neur.masts_inlocal.Model <- sapply(levels(factor(ss2_neur.cov$Model)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Model == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Model))]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Model <- do.call(rbind,ss2_neur.masts_inlocal.Model)

# Model_PEMNs
#ss2_neur.masts_inlocal.Model_PEMNs <- sapply(levels(factor(ss2_neur.cov$Model)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Model == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Model)) & (ss2_neur.cov$major == "PEMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Model_PEMNs <- do.call(rbind,ss2_neur.masts_inlocal.Model_PEMNs)
    
# Model_PIMNs
#ss2_neur.masts_inlocal.Model_PIMNs <- sapply(levels(factor(ss2_neur.cov$Model)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Model == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Model)) & (ss2_neur.cov$major == "PIMNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Model_PIMNs <- do.call(rbind,ss2_neur.masts_inlocal.Model_PIMNs)
    
# Model_PINs
#ss2_neur.masts_inlocal.Model_PINs <- sapply(levels(factor(ss2_neur.cov$Model)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Model == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Model)) & (ss2_neur.cov$major == "PINs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Model_PINs <- do.call(rbind,ss2_neur.masts_inlocal.Model_PINs)
    
## Model_PSNs
#ss2_neur.masts_inlocal.Model_PSNs <- sapply(levels(factor(ss2_neur.cov$Model)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Model == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Model)) & (ss2_neur.cov$major == "PSNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Model_PSNs <- do.call(rbind,ss2_neur.masts_inlocal.Model_PSNs)
    
# Model_PSVNs
#ss2_neur.masts_inlocal.Model_PSVNs <- sapply(levels(factor(ss2_neur.cov$Model)), function(ident){
#  ident.use = factor(ifelse(ss2_neur.cov$Model == ident, ident, 'Other'), levels=c('Other', ident))
#  cells.use = ss2_neur.cov$Sample[!is.na(as.character(ss2_neur.cov$Model)) & (ss2_neur.cov$major == "PSVNs")]
#  p.find_markers(seur=ss2_neur.seur, 
#                 ident.1 = ident, 
#                 ident.use=ident.use, 
#                 cells.use=cells.use,
#                 min_alph=.01, 
#                 min_fc=1.2, 
#                 max_cells=2500,
#                 covariates=ss2_neur.cov[,c("nGene","Sample")], 
#                 formula='~ nGene + ident', 
#                 lrt_regex=ident,n.cores=8)
#}, simplify=F)
#ss2_neur.masts_inlocal.Model_PSVNs <- do.call(rbind,ss2_neur.masts_inlocal.Model_PSVNs)
    

## save raw output
#write.table(protectgene(ss2_neur.masts_inlocal),"MAST_raw/ss2_neur.masts_inlocal.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.major),"MAST_raw/ss2_neur.masts_inlocal.major.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Age),"MAST_raw/ss2_neur.masts_inlocal.Age.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PEMNs),"MAST_raw/ss2_neur.masts_inlocal.Age_PEMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PIMNs),"MAST_raw/ss2_neur.masts_inlocal.Age_PIMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PINs),"MAST_raw/ss2_neur.masts_inlocal.Age_PINs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PSNs),"MAST_raw/ss2_neur.masts_inlocal.Age_PSNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PSVNs),"MAST_raw/ss2_neur.masts_inlocal.Age_PSVNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Model),"MAST_raw/ss2_neur.masts_inlocal.Model.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PEMNs),"MAST_raw/ss2_neur.masts_inlocal.Model_PEMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PIMNs),"MAST_raw/ss2_neur.masts_inlocal.Model_PIMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PINs),"MAST_raw/ss2_neur.masts_inlocal.Model_PINs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PSNs),"MAST_raw/ss2_neur.masts_inlocal.Model_PSNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PSVNs),"MAST_raw/ss2_neur.masts_inlocal.Model_PSVNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Segment),"MAST_raw/ss2_neur.masts_inlocal.Segment.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PEMNs),"MAST_raw/ss2_neur.masts_inlocal.Segment_PEMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PIMNs),"MAST_raw/ss2_neur.masts_inlocal.Segment_PIMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PINs),"MAST_raw/ss2_neur.masts_inlocal.Segment_PINs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PSNs),"MAST_raw/ss2_neur.masts_inlocal.Segment_PSNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PSVNs),"MAST_raw/ss2_neur.masts_inlocal.Segment_PSVNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw),"MAST_raw/ss2_neur.masts_inlocal.Seg_raw.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PEMNs),"MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PEMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PIMNs),"MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PIMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PINs),"MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PINs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PSNs),"MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PSNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PSVNs),"MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PSVNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Sex),"MAST_raw/ss2_neur.masts_inlocal.Sex.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PEMNs),"MAST_raw/ss2_neur.masts_inlocal.Sex_PEMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PIMNs),"MAST_raw/ss2_neur.masts_inlocal.Sex_PIMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PINs),"MAST_raw/ss2_neur.masts_inlocal.Sex_PINs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PSNs),"MAST_raw/ss2_neur.masts_inlocal.Sex_PSNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PSVNs),"MAST_raw/ss2_neur.masts_inlocal.Sex_PSVNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Time),"MAST_raw/ss2_neur.masts_inlocal.Time.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PEMNs),"MAST_raw/ss2_neur.masts_inlocal.Time_PEMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PIMNs),"MAST_raw/ss2_neur.masts_inlocal.Time_PIMNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PINs),"MAST_raw/ss2_neur.masts_inlocal.Time_PINs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PSNs),"MAST_raw/ss2_neur.masts_inlocal.Time_PSNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PSVNs),"MAST_raw/ss2_neur.masts_inlocal.Time_PSVNs.raw.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

```

  
this part would take time, annotate the code when it's done.   
 
```{r}
ss2_neur.masts_inlocal <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.raw.csv",
                                     header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.major <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.major.raw.csv",
                                           header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_neur.masts_inlocal.Age <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Age.raw.csv",
                                         header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Age_PEMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Age_PEMNs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Age_PIMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Age_PIMNs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Age_PINs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Age_PINs.raw.csv",
                                              header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Age_PSNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Age_PSNs.raw.csv",
                                              header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Age_PSVNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Age_PSVNs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_neur.masts_inlocal.Model <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Model.raw.csv",
                                           header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Model_PEMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Model_PEMNs.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Model_PIMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Model_PIMNs.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Model_PINs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Model_PINs.raw.csv",
                                                header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Model_PSNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Model_PSNs.raw.csv",
                                                header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Model_PSVNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Model_PSVNs.raw.csv",
                                                 header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_neur.masts_inlocal.Segment <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Segment.raw.csv",
                                             header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Segment_PEMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Segment_PEMNs.raw.csv",
                                                   header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Segment_PIMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Segment_PIMNs.raw.csv",
                                                   header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Segment_PINs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Segment_PINs.raw.csv",
                                                  header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Segment_PSNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Segment_PSNs.raw.csv",
                                                  header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Segment_PSVNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Segment_PSVNs.raw.csv",
                                                   header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_neur.masts_inlocal.Seg_raw <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Seg_raw.raw.csv",
                                             header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Seg_raw_PEMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PEMNs.raw.csv",
                                                   header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Seg_raw_PIMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PIMNs.raw.csv",
                                                   header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Seg_raw_PINs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PINs.raw.csv",
                                                  header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Seg_raw_PSNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PSNs.raw.csv",
                                                  header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Seg_raw_PSVNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Seg_raw_PSVNs.raw.csv",
                                                   header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_neur.masts_inlocal.Sex <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Sex.raw.csv",
                                         header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Sex_PEMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Sex_PEMNs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Sex_PIMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Sex_PIMNs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Sex_PINs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Sex_PINs.raw.csv",
                                              header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Sex_PSNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Sex_PSNs.raw.csv",
                                              header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Sex_PSVNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Sex_PSVNs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))

ss2_neur.masts_inlocal.Time <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Time.raw.csv",
                                          header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Time_PEMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Time_PEMNs.raw.csv",
                                                header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Time_PIMNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Time_PIMNs.raw.csv",
                                                header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Time_PINs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Time_PINs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Time_PSNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Time_PSNs.raw.csv",
                                               header = TRUE, stringsAsFactors = FALSE, sep = ","))
ss2_neur.masts_inlocal.Time_PSVNs <- recgene(read.table("MAST_raw/ss2_neur.masts_inlocal.Time_PSVNs.raw.csv",
                                                header = TRUE, stringsAsFactors = FALSE, sep = ","))

```



## filtering and figures  
    
     
there're a few columns to filter for the final unique DEGs,   
for ss2 data, here ignores contam.res (contaminated residuals for droplet-based filtering)   
and would only filter with p.adjD<0.05 (coefD > 0 and sorted) to save DEGs' table,    
(keep duplicated DEGs only in one group with biggest coefD instead of using 'next highest' things)    

if filter others like mean expression (mu, mean), expressed cells ratio(alpha) and log2FC et al. just for repeating figures in paper..     
   
### filt1  

```{r}
filt1_mast <- function(mast_raw){
  mast_filt <- mast_raw %>% filter(padjD<0.05) %>% filter(coefD >0) %>% arrange(desc(coefD))
  mast_filt <- mast_filt[!duplicated(mast_filt$gene),]
  mast_filt <- mast_filt %>% arrange(contrast,desc(coefD))
  return(mast_filt)
}
```


```{r}
ss2_neur.masts_inlocal.filt1 <- filt1_mast(ss2_neur.masts_inlocal)
ss2_neur.masts_inlocal.major.filt1 <- filt1_mast(ss2_neur.masts_inlocal.major)

ss2_neur.masts_inlocal.Age.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Age)
ss2_neur.masts_inlocal.Age_PEMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Age_PEMNs)
ss2_neur.masts_inlocal.Age_PIMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Age_PIMNs)
ss2_neur.masts_inlocal.Age_PINs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Age_PINs)
ss2_neur.masts_inlocal.Age_PSNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Age_PSNs)
ss2_neur.masts_inlocal.Age_PSVNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Age_PSVNs)

ss2_neur.masts_inlocal.Model.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Model)
ss2_neur.masts_inlocal.Model_PEMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Model_PEMNs)
ss2_neur.masts_inlocal.Model_PIMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Model_PIMNs)
ss2_neur.masts_inlocal.Model_PINs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Model_PINs)
ss2_neur.masts_inlocal.Model_PSNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Model_PSNs)
ss2_neur.masts_inlocal.Model_PSVNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Model_PSVNs)

ss2_neur.masts_inlocal.Segment.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Segment)
ss2_neur.masts_inlocal.Segment_PEMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Segment_PEMNs)
ss2_neur.masts_inlocal.Segment_PIMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Segment_PIMNs)
ss2_neur.masts_inlocal.Segment_PINs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Segment_PINs)
ss2_neur.masts_inlocal.Segment_PSNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Segment_PSNs)
ss2_neur.masts_inlocal.Segment_PSVNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Segment_PSVNs)

ss2_neur.masts_inlocal.Seg_raw.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Seg_raw)
ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Seg_raw_PEMNs)
ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Seg_raw_PIMNs)
ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Seg_raw_PINs)
ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Seg_raw_PSNs)
ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Seg_raw_PSVNs)

ss2_neur.masts_inlocal.Sex.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Sex)
ss2_neur.masts_inlocal.Sex_PEMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Sex_PEMNs)
ss2_neur.masts_inlocal.Sex_PIMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Sex_PIMNs)
ss2_neur.masts_inlocal.Sex_PINs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Sex_PINs)
ss2_neur.masts_inlocal.Sex_PSNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Sex_PSNs)
ss2_neur.masts_inlocal.Sex_PSVNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Sex_PSVNs)

ss2_neur.masts_inlocal.Time.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Time)
ss2_neur.masts_inlocal.Time_PEMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Time_PEMNs)
ss2_neur.masts_inlocal.Time_PIMNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Time_PIMNs)
ss2_neur.masts_inlocal.Time_PINs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Time_PINs)
ss2_neur.masts_inlocal.Time_PSNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Time_PSNs)
ss2_neur.masts_inlocal.Time_PSVNs.filt1 <- filt1_mast(ss2_neur.masts_inlocal.Time_PSVNs)
```


```{r}
#write.table(protectgene(ss2_neur.masts_inlocal.filt1),"MAST_filt1/ss2_neur.masts_inlocal.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.major.filt1),"MAST_filt1/ss2_neur.masts_inlocal.major.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Age.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Age.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PEMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Age_PEMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PIMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Age_PIMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PINs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Age_PINs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PSNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Age_PSNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PSVNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Age_PSVNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Model.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Model.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PEMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Model_PEMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PIMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Model_PIMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PINs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Model_PINs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PSNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Model_PSNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PSVNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Model_PSVNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Segment.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Segment.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PEMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Segment_PEMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PIMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Segment_PIMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PINs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Segment_PINs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PSNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Segment_PSNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PSVNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Segment_PSVNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Seg_raw.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PINs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Seg_raw_PINs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Sex.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Sex.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PEMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Sex_PEMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PIMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Sex_PIMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PINs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Sex_PINs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PSNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Sex_PSNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PSVNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Sex_PSVNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Time.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Time.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PEMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Time_PEMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PIMNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Time_PIMNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PINs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Time_PINs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PSNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Time_PSNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PSVNs.filt1),"MAST_filt1/ss2_neur.masts_inlocal.Time_PSVNs.filt1.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
```
    
several columns in MAST results could be candidate cutoffs to filter for 'significant' DEGs   
   
| Column | Description |  
| :-----| :------------------------------------------------------------------------------------------|  
| ident | Cell subset or lineage |  
| gene | Gene |  
| coefD | Coefficient (discrete term) |  
| pvalD | P-value (discrete term) |  
| padjD | Adjusted p-value (discrete term) |  
| coefC | Coefficient (continuous term) |  
| pvalC | P-value (continuous term) |  
| padjC | Adjusted p-value (continuous term) |  
| mastfc | Fold change estimated by MAST |  
| alpha | Fraction of expressing cells |  
| ref_alpha | Fraction of expressing cells (reference group) |  
| mu | Mean log2(TP10K) in expressing cells |  
| ref_mu | Mean log2(TP10K) in expressing cells (reference group) |  
| mean | Mean log2(TP10K) in all cells |  
| ref_mean | Mean log2(TP10K) in all cells (reference group) |  
| log2fc | log2 fold change (relative to reference group) |  
| contam.res | Residual (contamination model) |  
| Note: | reference group = all other cells (for example, reference group for Tregs = all non-Tregs) |  
    
    
### filt2       
    
tested "mu","mean","foldchange","n","alpha", still confused about how to exactly do it.      
finally just use quantile 95% of "diff_alpha = alpha - ref_alpha" as cutoff, which fit ss2_glia data.   

```{r}
# min - max of diff_alpha  
range(ss2_neur.masts_inlocal.filt1$alpha - ss2_neur.masts_inlocal.filt1$ref_alpha)
```

```{r paged.print=FALSE}
# quantile with step 0.05
test_quant <- data.frame(quantile(ss2_neur.masts_inlocal.filt1$alpha - ss2_neur.masts_inlocal.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant) <- "alpha-ref_alpha"
test_quant
```

choose 95% as cutoff  
```{r quantile1,fig.width=8,fig.height=6}
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.filt1$alpha - ss2_neur.masts_inlocal.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.1,0.95))
text(x=0:20*1.2+0.65,y=test_quant[,1]+0.02*test_quant[,1]/abs(test_quant[,1]),round(test_quant[,1],3),cex=0.8)
```
    
    
modification from 'future check':   
if one gene expressed in most cells, or with similar ratio in all groups,   
but uniquely high in one(or two), this 'alpha - ref_alpha' filtering couldn't find them.   
     
so filt2 add condition:   
or " genes with alpha > 'quantile 30%' and 'mu - ref_mu' > 'quantile 95%' "     
    
filt2  
```{r}
filt2_mast <- function(mast_raw){
  mast_filt <- mast_raw %>% filter(padjD<0.05) %>% filter(coefD >0) %>% arrange(desc(coefD))
  mast_filt <- mast_filt[!duplicated(mast_filt$gene),]
  mast_filt <- mast_filt %>% arrange(contrast,desc(coefD))

  mast_filt$diff_alpha <- mast_filt$alpha - mast_filt$ref_alpha
  mast_filt$diff_mu <- mast_filt$mu - mast_filt$ref_mu 
  
  mast_filt <- mast_filt %>% filter(diff_alpha> as.numeric((quantile(mast_filt$diff_alpha,
                                                                     probs = seq(0,1,0.05)))["95%"]) |
                                      (diff_mu > as.numeric((quantile(mast_filt$diff_mu,
                                                                      probs = seq(0,1,0.05)))["95%"]) &
                                         alpha > as.numeric((quantile(mast_filt$alpha,
                                                                      probs = seq(0,1,0.05)))["20%"])))
  return(mast_filt)
}
```

```{r}
ss2_neur.masts_inlocal.filt2 <- filt2_mast(ss2_neur.masts_inlocal)
ss2_neur.masts_inlocal.major.filt2 <- filt2_mast(ss2_neur.masts_inlocal.major)

ss2_neur.masts_inlocal.Age.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Age)
ss2_neur.masts_inlocal.Age_PEMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Age_PEMNs)
ss2_neur.masts_inlocal.Age_PIMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Age_PIMNs)
ss2_neur.masts_inlocal.Age_PINs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Age_PINs)
ss2_neur.masts_inlocal.Age_PSNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Age_PSNs)
ss2_neur.masts_inlocal.Age_PSVNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Age_PSVNs)

ss2_neur.masts_inlocal.Model.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Model)
ss2_neur.masts_inlocal.Model_PEMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Model_PEMNs)
ss2_neur.masts_inlocal.Model_PIMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Model_PIMNs)
ss2_neur.masts_inlocal.Model_PINs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Model_PINs)
ss2_neur.masts_inlocal.Model_PSNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Model_PSNs)
ss2_neur.masts_inlocal.Model_PSVNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Model_PSVNs)

ss2_neur.masts_inlocal.Segment.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Segment)
ss2_neur.masts_inlocal.Segment_PEMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Segment_PEMNs)
ss2_neur.masts_inlocal.Segment_PIMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Segment_PIMNs)
ss2_neur.masts_inlocal.Segment_PINs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Segment_PINs)
ss2_neur.masts_inlocal.Segment_PSNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Segment_PSNs)
ss2_neur.masts_inlocal.Segment_PSVNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Segment_PSVNs)

ss2_neur.masts_inlocal.Seg_raw.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Seg_raw)
ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Seg_raw_PEMNs)
ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Seg_raw_PIMNs)
ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Seg_raw_PINs)
ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Seg_raw_PSNs)
ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Seg_raw_PSVNs)

ss2_neur.masts_inlocal.Sex.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Sex)
ss2_neur.masts_inlocal.Sex_PEMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Sex_PEMNs)
ss2_neur.masts_inlocal.Sex_PIMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Sex_PIMNs)
ss2_neur.masts_inlocal.Sex_PINs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Sex_PINs)
ss2_neur.masts_inlocal.Sex_PSNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Sex_PSNs)
ss2_neur.masts_inlocal.Sex_PSVNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Sex_PSVNs)

ss2_neur.masts_inlocal.Time.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Time)
ss2_neur.masts_inlocal.Time_PEMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Time_PEMNs)
ss2_neur.masts_inlocal.Time_PIMNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Time_PIMNs)
ss2_neur.masts_inlocal.Time_PINs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Time_PINs)
ss2_neur.masts_inlocal.Time_PSNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Time_PSNs)
ss2_neur.masts_inlocal.Time_PSVNs.filt2 <- filt2_mast(ss2_neur.masts_inlocal.Time_PSVNs)

```

```{r}
#write.table(protectgene(ss2_neur.masts_inlocal.filt2),"MAST_filt2/ss2_neur.masts_inlocal.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.major.filt2),"MAST_filt2/ss2_neur.masts_inlocal.major.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Age.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Age.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PEMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Age_PEMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PIMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Age_PIMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PINs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Age_PINs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PSNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Age_PSNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Age_PSVNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Age_PSVNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Model.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Model.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PEMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Model_PEMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PIMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Model_PIMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PINs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Model_PINs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PSNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Model_PSNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Model_PSVNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Model_PSVNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Segment.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Segment.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PEMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Segment_PEMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PIMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Segment_PIMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PINs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Segment_PINs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PSNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Segment_PSNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Segment_PSVNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Segment_PSVNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Seg_raw.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Seg_raw_PINs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Sex.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Sex.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PEMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Sex_PEMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PIMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Sex_PIMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PINs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Sex_PINs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PSNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Sex_PSNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Sex_PSVNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Sex_PSVNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")

#write.table(protectgene(ss2_neur.masts_inlocal.Time.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Time.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PEMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Time_PEMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PIMNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Time_PIMNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PINs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Time_PINs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PSNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Time_PSNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
#write.table(protectgene(ss2_neur.masts_inlocal.Time_PSVNs.filt2),"MAST_filt2/ss2_neur.masts_inlocal.Time_PSVNs.filt2.csv", 
#            col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
```


how many DEGs in .filt2    
```{r}
dim(ss2_neur.masts_inlocal.filt2)[1]
```

```{r}
ss2_neur.masts_inlocal.filt2[1:5,]
```

## DEGs of subclusters   
    
### volcano plots          
#### PEMNs      
    
```{r volcano_PEMN_1,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_1"))$padjD)),
     pch=16,col="grey",
     main="PEMN_1", xlab="DE coefficient (PEMN_1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_1"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_1"))$gene,cex=0.6)

legend(x=0,y=45,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PEMN_2,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_2"))$padjD)),
     pch=16,col="grey",
     main="PEMN_2", xlab="DE coefficient (PEMN_2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_2"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_2"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_2"))$gene,cex=0.6)

legend(x=0,y=35,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PEMN_3,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_3"))$padjD)),
     pch=16,col="grey",
     main="PEMN_3", xlab="DE coefficient (PEMN_3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3"))$gene,cex=0.6)

legend(x=0,y=11,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```    
    
    
```{r volcano_PEMN_4,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_4"))$padjD)),
     pch=16,col="grey",
     main="PEMN_4", xlab="DE coefficient (PEMN_4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_4"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_4"))$padjD)+2),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_4"))$gene,cex=0.6)

legend(x=0,y=85,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PEMN_5,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_5"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_5"))$padjD)),
     pch=16,col="grey",
     main="PEMN_5", xlab="DE coefficient (PEMN_5 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_5"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_5"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_5"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_5"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_5"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_5"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_5"))$gene,cex=0.6)

legend(x=0,y=45,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

    
```{r volcano_PEMN_6,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_6"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_6"))$padjD)),
     pch=16,col="grey",
     main="PEMN_6", xlab="DE coefficient (PEMN_6 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_6"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_6"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_6"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_6"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_6"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_6"))$padjD)+0.5),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_6"))$gene,cex=0.6)

legend(x=0,y=20,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PEMN_7,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_7"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPEMN_7"))$padjD)),
     pch=16,col="grey",
     main="PEMN_7", xlab="DE coefficient (PEMN_7 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_7"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPEMN_7"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_7"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_7"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_7"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_7"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_7"))$gene,cex=0.6)

legend(x=0,y=55,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
#### PIMNs      
    
```{r volcano_PIMN_1,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_1"))$padjD)),
     pch=16,col="grey",
     main="PIMN_1", xlab="DE coefficient (PIMN_1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1"))$padjD)+0.25),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1"))$gene,cex=0.6)

legend(x=0,y=15,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PIMN_2,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_2"))$padjD)),
     pch=16,col="grey",
     main="PIMN_2", xlab="DE coefficient (PIMN_2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_2"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_2"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_2"))$gene,cex=0.6)

legend(x=0,y=55,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PIMN_3,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_3"))$padjD)),
     pch=16,col="grey",
     main="PIMN_3", xlab="DE coefficient (PIMN_3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_3"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_3"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_3"))$gene,cex=0.6)

legend(x=0,y=53,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PIMN_4,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_4"))$padjD)),
     pch=16,col="grey",
     main="PIMN_4", xlab="DE coefficient (PIMN_4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_4"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_4"))$padjD)+1.5),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_4"))$gene,cex=0.6)

legend(x=0,y=75,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PIMN_5,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_5"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_5"))$padjD)),
     pch=16,col="grey",
     main="PIMN_5", xlab="DE coefficient (PIMN_5 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_5"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_5"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_5"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_5"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_5"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_5"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_5"))$gene,cex=0.6)

legend(x=0,y=50,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PIMN_6,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_6"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_6"))$padjD)),
     pch=16,col="grey",
     main="PIMN_6", xlab="DE coefficient (PIMN_6 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_6"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_6"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_6"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_6"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_6"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_6"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_6"))$gene,cex=0.6)

legend(x=0,y=50,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PIMN_7,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_7"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_7"))$padjD)),
     pch=16,col="grey",
     main="PIMN_7", xlab="DE coefficient (PIMN_7 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_7"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_7"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_7"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_7"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_7"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_7"))$padjD)+0.75),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_7"))$gene,cex=0.6)

legend(x=0,y=30,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PIMN_8,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_8"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIMN_8"))$padjD)),
     pch=16,col="grey",
     main="PIMN_8", xlab="DE coefficient (PIMN_8 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_8"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIMN_8"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8"))$coefD-0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8"))$padjD)+0.15),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8"))$gene,cex=0.6)

legend(x=0,y=8.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
#### PSNs          
    
```{r volcano_PSN_1,fig.width=10,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_1"))$padjD)),
     pch=16,col="grey",
     main="PSN_1", xlab="DE coefficient (PSN_1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1"))$gene,cex=0.6)

legend(x=0,y=41,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PSN_2,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_2"))$padjD)),
     pch=16,col="grey",
     main="PSN_2", xlab="DE coefficient (PSN_2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2"))$padjD)+0.5),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2"))$gene,cex=0.6)

legend(x=0,y=25,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PSN_3,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_3"))$padjD)),
     pch=16,col="grey",
     main="PSN_3", xlab="DE coefficient (PSN_3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_3"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_3"))$padjD)+1.5),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_3"))$gene,cex=0.6)

legend(x=0,y=75,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r volcano_PSN_4,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSN_4"))$padjD)),
     pch=16,col="grey",
     main="PSN_4", xlab="DE coefficient (PSN_4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSN_4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_4"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_4"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_4"))$gene,cex=0.6)

legend(x=0,y=45,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
#### PINs          
    
```{r volcano_PIN_1,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_1"))$padjD)),
     pch=16,col="grey",
     main="PIN_1", xlab="DE coefficient (PIN_1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1"))$coefD+0.08,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1"))$gene,cex=0.6)

legend(x=0,y=40,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  
    
    
```{r volcano_PIN_2,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_2"))$padjD)),
     pch=16,col="grey",
     main="PIN_2", xlab="DE coefficient (PIN_2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2"))$gene,cex=0.6)

legend(x=0,y=42,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  
    
    
```{r volcano_PIN_3,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_3"))$padjD)),
     pch=16,col="grey",
     main="PIN_3", xlab="DE coefficient (PIN_3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3"))$padjD)+1.2),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3"))$gene,cex=0.6)

legend(x=0,y=65,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  
    
    
```{r volcano_PIN_4,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPIN_4"))$padjD)),
     pch=16,col="grey",
     main="PIN_4", xlab="DE coefficient (PIN_4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPIN_4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_4"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_4"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_4"))$gene,cex=0.6)

legend(x=0,y=62,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  
    
#### PSVNs   
    
```{r volcano_PSVN_1,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSVN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSVN_1"))$padjD)),
     pch=16,col="grey",
     main="PSVN_1", xlab="DE coefficient (PSVN_1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSVN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSVN_1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1"))$padjD)+1),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1"))$gene,cex=0.6)

legend(x=0,y=45,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  
    
    
```{r volcano_PSVN_2,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSVN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal %>% filter(coefD > 0 & contrast=="identPSVN_2"))$padjD)),
     pch=16,col="grey",
     main="PSVN_2", xlab="DE coefficient (PSVN_2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.12,y=2.5,"padjD < 0.05",cex=0.75)

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSVN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt1 %>% filter(contrast=="identPSVN_2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2"))$coefD-0.15,
                logP=-log10((ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2"))$padjD)+1.3),
     (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2"))$gene,cex=0.6)

legend(x=0,y=72,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  
  

as displayed above, filt2 filtering for 'diff_alpha' basically get genes with top '-log10(padjD)' which would make sense logically.      
however, if it's 'really significant' ? I have no idea. could only say 'putative' or 'candidate'. next check these DEGs.   
    
noticed that if one subcluster has fewer cells than others within one major group, would get much more final DEGs,    
like PEMN_3, PIMN_1, PIMN_8, PSN_1, some of them could be really unique identifiers,   
but some of them could only be shared with the close subcluster(s),    
why getting enriched, in filt1 removing duplicates step, like markers both in PEMN_3/4, they would keep in PEMN_3 for possibly a little higher coefD.        


### DEGs    

```{r ss2_neur_inpl2.1, fig.height=3.8, fig.width=12.8, warning=FALSE}
multiplot(
  DimPlot(ss2_neur.seur, group.by = 'Annotation', label = T) + labs(title = "ss2_neur inpaper"),
  DimPlot(ss2_neur.seur, group.by = 'inlocal', label = T) + labs(title = "ss2_neur inlocal"),
  cols=2
)
```

    
#### PEMN_1 DEGs    

```{r ss2_neur_inpl_1.1, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(neur.colors.inlocal_PEMN[1],rep("grey",24))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_1") %>% arrange(padjD))$gene
```


```{r feat1_1.1,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_1") %>% arrange(padjD))$gene[1:14],ncol = 4)
```
    
#### PEMN_2 DEGs    

```{r ss2_neur_inpl_1.2, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",1),neur.colors.inlocal_PEMN[2],rep("grey",23))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_2") %>% arrange(padjD))$gene
```

```{r feat1_1.2,fig.width=9,fig.height=2.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_2") %>% arrange(padjD))$gene[1:3],ncol = 3)
```

    
#### PEMN_3 DEGs    

```{r ss2_neur_inpl_1.3, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",2),neur.colors.inlocal_PEMN[3],rep("grey",22))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3") %>% arrange(padjD))$gene
```

```{r feat1_1.31,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3") %>% arrange(padjD))$gene[1:16],ncol = 4)
```

```{r feat1_1.32,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3") %>% arrange(padjD))$gene[17:32],ncol = 4)
```

```{r feat1_1.33,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3") %>% arrange(padjD))$gene[33:48],ncol = 4)
```

```{r feat1_1.34,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3") %>% arrange(padjD))$gene[49:64],ncol = 4)
```

```{r feat1_1.35,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3") %>% arrange(padjD))$gene[65:80],ncol = 4)
```

```{r feat1_1.36,fig.width=12,fig.height=5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_3") %>% arrange(padjD))$gene[81:86],ncol = 4)
```

though very many, visually few could be unique.    
    
#### PEMN_4 DEGs    

```{r ss2_neur_inpl_1.4, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",3),neur.colors.inlocal_PEMN[4],rep("grey",21))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_4") %>% arrange(padjD))$gene
```

```{r feat1_1.4,fig.width=12,fig.height=12.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_4") %>% arrange(padjD))$gene[1:17],ncol = 4)
```

    
#### PEMN_5 DEGs    

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_5") %>% arrange(padjD))$gene
```

```{r ss2_neur_inpl_1.5, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",4),neur.colors.inlocal_PEMN[5],rep("grey",20))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r feat1_1.5,fig.width=12,fig.height=7.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_5") %>% arrange(padjD))$gene[1:9],ncol = 4)
```

    
#### PEMN_6 DEGs    

```{r ss2_neur_inpl_1.6, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",5),neur.colors.inlocal_PEMN[6],rep("grey",19))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_6") %>% arrange(padjD))$gene
```

```{r feat1_1.6,fig.width=12,fig.height=7.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_6") %>% arrange(padjD))$gene[1:9],ncol = 4)
```

    
#### PEMN_7 DEGs    

```{r ss2_neur_inpl_1.7, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",6),neur.colors.inlocal_PEMN[7],rep("grey",18))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_7") %>% arrange(padjD))$gene
```

```{r feat1_1.11,fig.width=12,fig.height=7.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPEMN_7") %>% arrange(padjD))$gene[1:9],ncol = 4)
```

    
#### PIMN_1 DEGs    

```{r ss2_neur_inpl_2.1, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",7),neur.colors.inlocal_PIMN[1],rep("grey",17))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1") %>% arrange(padjD))$gene
```

```{r feat1_2.11,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1") %>% arrange(padjD))$gene[1:16],ncol = 4)
```
    
```{r feat1_2.12,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1") %>% arrange(padjD))$gene[17:32],ncol = 4)
```    
    
```{r feat1_2.13,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1") %>% arrange(padjD))$gene[33:48],ncol = 4)
```     
    
```{r feat1_2.14,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1") %>% arrange(padjD))$gene[49:64],ncol = 4)
```     
    
```{r feat1_2.15,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1") %>% arrange(padjD))$gene[65:80],ncol = 4)
```     
    
    
```{r feat1_2.16,fig.width=12,fig.height=5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_1") %>% arrange(padjD))$gene[81:85],ncol = 4)
``` 


#### PIMN_2 DEGs    

```{r ss2_neur_inpl_2.2, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",8),neur.colors.inlocal_PIMN[2],rep("grey",16))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```
    
```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_2") %>% arrange(padjD))$gene
```    
    
```{r feat1_2.2, fig.height=2.5, fig.width=3}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_2") %>% arrange(padjD))$gene[1:1],ncol = 1)
```
    
#### PIMN_3 DEGs    

```{r ss2_neur_inpl_2.3, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",9),neur.colors.inlocal_PIMN[3],rep("grey",15))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_3") %>% arrange(padjD))$gene
```

```{r feat1_2.3,fig.width=3,fig.height=2.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_3") %>% arrange(padjD))$gene[1:1],ncol = 1)
```
    
#### PIMN_4 DEGs    

```{r ss2_neur_inpl_2.4, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",10),neur.colors.inlocal_PIMN[4],rep("grey",14))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_4") %>% arrange(padjD))$gene
```

```{r feat1_2.4,fig.width=12,fig.height=5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_4") %>% arrange(padjD))$gene[1:6],ncol = 4)
```
    
#### PIMN_5 DEGs    

```{r ss2_neur_inpl_2.5, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",11),neur.colors.inlocal_PIMN[5],rep("grey",13))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_5") %>% arrange(padjD))$gene
```

```{r feat1_2.5,fig.width=12,fig.height=5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_5") %>% arrange(padjD))$gene[1:6],ncol = 4)
```
    
#### PIMN_6 DEGs    

```{r ss2_neur_inpl_2.6, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",12),neur.colors.inlocal_PIMN[6],rep("grey",12))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_6") %>% arrange(padjD))$gene
```

```{r feat1_2.6,fig.width=12,fig.height=5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_6") %>% arrange(padjD))$gene[1:7],ncol = 4)
```
    
##### see this 'Aldh1a3' again.       
    
#### PIMN_7 DEGs    

```{r ss2_neur_inpl_2.7, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",13),neur.colors.inlocal_PIMN[7],rep("grey",11))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_7") %>% arrange(padjD))$gene
```

```{r feat1_2.7,fig.width=12,fig.height=2.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_7") %>% arrange(padjD))$gene[1:4],ncol = 4)
```
    
#### PIMN_8 DEGs    

```{r ss2_neur_inpl_2.8, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",14),neur.colors.inlocal_PIMN[8],rep("grey",10))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8") %>% arrange(padjD))$gene
```

```{r feat1_2.81,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8") %>% arrange(padjD))$gene[1:16],ncol = 4)
```


```{r feat1_2.82,fig.width=12,fig.height=7.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIMN_8") %>% arrange(padjD))$gene[17:26],ncol = 4)
```
        
#### PSN_1 DEGs    

```{r ss2_neur_inpl_3.1, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",19),neur.colors.inlocal_PSN[1],rep("grey",5))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene
```
  
```{r feat1_3.11,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[1:16],ncol = 4)
```
   
  
```{r feat1_3.12,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[17:32],ncol = 4)
```   
   
  
```{r feat1_3.13,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[33:48],ncol = 4)
```   
   
```{r feat1_3.14,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[49:64],ncol = 4)
```     
   
   
```{r feat1_3.15,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[65:80],ncol = 4)
```   
   
   
```{r feat1_3.16,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[81:96],ncol = 4)
```   
   
   
```{r feat1_3.17,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[97:112],ncol = 4)
```     
   
   
```{r feat1_3.18,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[113:128],ncol = 4)
```     
   
   
```{r feat1_3.19,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[129:144],ncol = 4)
```    
   
   
```{r feat1_3.110,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[145:160],ncol = 4)
```    
   
```{r feat1_3.111,fig.width=12,fig.height=5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_1") %>% arrange(padjD))$gene[161:168],ncol = 4)
```    
   
   
#### PSN_2 DEGs    

```{r ss2_neur_inpl_3.2, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",20),neur.colors.inlocal_PSN[2],rep("grey",4))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2") %>% arrange(padjD))$gene
```
  
```{r feat1_3.21,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2") %>% arrange(padjD))$gene[1:16],ncol = 4)
```

```{r feat1_3.22,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2") %>% arrange(padjD))$gene[17:32],ncol = 4)
```   
   

```{r feat1_3.23,fig.width=6,fig.height=2.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_2") %>% arrange(padjD))$gene[33:34],ncol = 2)
``` 

   
#### PSN_3 DEGs    

```{r ss2_neur_inpl_3.3, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",21),neur.colors.inlocal_PSN[3],rep("grey",3))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_3") %>% arrange(padjD))$gene
```
  
```{r feat1_3.3,fig.width=12,fig.height=12.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_3") %>% arrange(padjD))$gene[1:17],ncol = 4)
```
   
#### PSN_4 DEGs    

```{r ss2_neur_inpl_3.4, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",22),neur.colors.inlocal_PSN[4],rep("grey",2))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_4") %>% arrange(padjD))$gene
```
  
```{r feat1_3.31,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSN_4") %>% arrange(padjD))$gene[1:14],ncol = 4)
```

    
#### PIN_1 DEGs    

```{r ss2_neur_inpl_4.1, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",15),neur.colors.inlocal_PIN[1],rep("grey",9))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1") %>% arrange(padjD))$gene
```
  
```{r feat1_4.11,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1") %>% arrange(padjD))$gene[1:16],ncol = 4)
```

    
```{r feat1_4.12,fig.width=12,fig.height=12.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_1") %>% arrange(padjD))$gene[17:34],ncol = 4)
```
        
#### PIN_2 DEGs    

```{r ss2_neur_inpl_4.2, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",16),neur.colors.inlocal_PIN[2],rep("grey",8))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2") %>% arrange(padjD))$gene
```  
  
```{r feat1_4.21,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2") %>% arrange(padjD))$gene[1:16],ncol = 4)
```

  
```{r feat1_4.22,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2") %>% arrange(padjD))$gene[17:32],ncol = 4)
```
    
  
```{r feat1_4.23,fig.width=12,fig.height=7.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_2") %>% arrange(padjD))$gene[33:44],ncol = 4)
```    
    
#### PIN_3 DEGs   

```{r ss2_neur_inpl_4.3, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",17),neur.colors.inlocal_PIN[3],rep("grey",7))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3") %>% arrange(padjD))$gene
```
  
```{r feat1_4.31,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3") %>% arrange(padjD))$gene[1:16],ncol = 4)
```

  
```{r feat1_4.32,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3") %>% arrange(padjD))$gene[17:32],ncol = 4)
```
    
  
```{r feat1_4.33,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3") %>% arrange(padjD))$gene[33:48],ncol = 4)
```

    
```{r feat1_4.34,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3") %>% arrange(padjD))$gene[49:64],ncol = 4)
```

    
```{r feat1_4.35,fig.width=12,fig.height=12.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_3") %>% arrange(padjD))$gene[65:83],ncol = 4)
```
   

#### PIN_4 DEGs   

```{r ss2_neur_inpl_4.4, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",18),neur.colors.inlocal_PIN[4],rep("grey",6))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_4") %>% arrange(padjD))$gene
```
  
```{r feat1_4.4,fig.width=12,fig.height=7.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPIN_4") %>% arrange(padjD))$gene[1:11],ncol = 4)
```


#### PSVN_1 DEGs    

```{r ss2_neur_inpl_5.1, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",23),neur.colors.inlocal_PSVN[1],rep("grey",1))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1") %>% arrange(padjD))$gene
```
  
```{r feat1_5.11,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1") %>% arrange(padjD))$gene[1:16],ncol = 4)
```

  
```{r feat1_5.12,fig.width=12,fig.height=12.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_1") %>% arrange(padjD))$gene[17:33],ncol = 4)
```    
    
   
#### PSVN_2 DEGs    

```{r ss2_neur_inpl_5.2, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",24),neur.colors.inlocal_PSVN[2])) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2") %>% arrange(padjD))$gene
```  
  
```{r feat1_5.21,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2") %>% arrange(padjD))$gene[1:16],ncol = 4)
```

  
```{r feat1_5.22,fig.width=12,fig.height=10}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2") %>% arrange(padjD))$gene[17:32],ncol = 4)
```


  
```{r feat1_5.23,fig.width=12,fig.height=7.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.filt2 %>% filter(contrast=="identPSVN_2") %>% arrange(padjD))$gene[33:44],ncol = 4)
```  


## conclusion of ss2_neur DEGs     
     
filtering of 'alpha-ref_alpha' has some limitations, like "Lgr5","Gabrb2","Edar","Ptger2","Nxph2","Agtr1b" et al. in Fig.S3C,   
no big difference of 'alpha' for all subclusters, it could be hard to get them,     
    
test situation like that:         

quantile of 'mu - ref_mu' which means the expression difference of expressed cells between 'ident vs others':   
```{r paged.print=FALSE}
quantile((ss2_neur.masts_inlocal.filt1$mu - ss2_neur.masts_inlocal.filt1$ref_mu), probs = seq(0,1,0.05))
```
    
quantile of 'alpha' which means percentage of expressed cells in 'ident group':   
```{r paged.print=FALSE}
quantile(ss2_neur.masts_inlocal.filt1$alpha, probs = seq(0,1,0.05))
```

choose 'mu - ref_mu > 2.03' > 'quantile 95%' as cutoff, all genes with 'alpha > 0.35' > 'quantile 20%:     
(no standard way to do this, these cutoffs could change)    
(if it works, back to add them in all filt2 step )        

```{r}
ss2_neur.masts_inlocal.filt1[,c("gene","contrast","coefD","n","alpha","ref_alpha","mu","ref_mu")] %>% 
  filter(gene=="Lgr5" |gene=="Gabrb2")
```
    

```{r eval=FALSE, include=FALSE, paged.print=FALSE}
(ss2_neur.masts_inlocal.filt1 %>% filter(alpha>0.5 & (mu - ref_mu)>2.03 & (alpha-ref_alpha) < 0.52)
 )[,c("gene","contrast","coefD","n","alpha","ref_alpha","mu","ref_mu")]
```

```{r}
#write.table((ss2_neur.masts_inlocal.filt1 %>% filter(alpha>0.5 & (mu - ref_mu)>2.03 & (alpha-ref_alpha) < 0.52)
#             )[,c("gene","contrast","coefD","n","alpha","ref_alpha","mu","ref_mu")],
#            "MAST_filt2/ss2_neur.masts_inlocal.filt3.csv", col.names = TRUE, row.names = FALSE, quote = FALSE, sep = ",")
```
      
      
if those missed markers found in filt3     
```{r}
c("Lgr5","Gabrb2","Edar","Ptger2","Nxph2","Agtr1b") %in% (ss2_neur.masts_inlocal.filt1 %>% 
                                                            filter(alpha>0.5 & (mu - ref_mu)>2.03 & (alpha-ref_alpha) < 0.52))$gene
```

      
## Pseudotime     
       
##### how about UMAP result comparing to tSNE ?    
##### and what does the putative cell trajectory look like ?   

```{r message=FALSE, warning=FALSE}
#ss2_neur.seur_traj <- ss2_neur.seur
#ss2_neur.seur_traj <- RunUMAP(ss2_neur.seur_traj, dims=1:15)
```

```{r}
#saveRDS(ss2_neur.seur_traj,"ss2_neur.seur_traj.rds")
ss2_neur.seur_traj <- readRDS("ss2_neur.seur_traj.rds")
```


```{r ss2_neur_inpl_4, fig.height=10.8, fig.width=8.55, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur_traj,reduction = 'tsne', group.by = 'inlocal',label = T) + labs(title = "ss2_neur inlocal tSNE"),
DimPlot(ss2_neur.seur_traj,reduction = 'umap', group.by = "inlocal",label = T) + labs(title = "ss2_neur inlocal UMAP"),
cols = 1)
```
     
        
visually, UMAP result gives a clearer understanding of the difference between clusters.     
      
### DiffusionMap using DEGs or PCs      
ref. https://broadinstitute.github.io/2020_scWorkshop/trajectory-inference.html  

```{r}
diffusion_test <- DiffusionMap(t(data.frame(ss2_neur.seur_traj@assays[['RNA']]@data))[,ss2_neur.masts_inlocal.filt2$gene])
diffusion_testpca <- DiffusionMap(data.frame(ss2_neur.seur_traj@reductions[['pca']]@cell.embeddings)[,1:15])
```

```{r}
diffusion_tmp <- data.frame(DC1 = eigenvectors(diffusion_test)[,1],
                            DC2 = eigenvectors(diffusion_test)[,2],
                            label = ss2_neur.seur_traj$inlocal)
head(diffusion_tmp)
```

```{r}
diffusion_pca <- data.frame(DC1 = eigenvectors(diffusion_testpca)[,1],
                            DC2 = eigenvectors(diffusion_testpca)[,2],
                            label = ss2_neur.seur_traj$inlocal)
head(diffusion_pca)
```

```{r eval=FALSE, include=FALSE}
plot(eigenvalues(diffusion_test), ylim = 0:1, pch = 20, xlab = 'Diffusion component (DC)', ylab = 'Eigenvalue')
plot(eigenvalues(diffusion_testpca), ylim = 0:1, pch = 20, xlab = 'Diffusion component (DC)', ylab = 'Eigenvalue')
```

```{r diffusion1,fig.height=9.6, fig.width=7.2}
multiplot(
ggplot(diffusion_tmp, aes(x = DC1, y = DC2, colour = label)) +
    geom_point(cex=1.0) + 
    scale_color_manual(values=neur.colors.inlocal) +
    #ggthemes::scale_color_tableau() + 
    xlab("Diffusion component 1") + 
    ylab("Diffusion component 2") +
    theme_classic() + labs(title=("DM with DEGs")),
ggplot(diffusion_pca, aes(x = DC1, y = DC2, colour = label)) +
    geom_point(cex=1.0) + 
    scale_color_manual(values=neur.colors.inlocal) +
    #ggthemes::scale_color_tableau() + 
    xlab("Diffusion component 1") + 
    ylab("Diffusion component 2") +
    theme_classic() + labs(title=("DM with PCs")),
cols = 1)
```


### Slingshot pseudotime on UMAP    
ref. https://bustools.github.io/BUS_notebooks_R/slingshot.html  

```{r}
sds_umap <- slingshot(Embeddings(ss2_neur.seur_traj, "umap"), clusterLabels = ss2_neur.seur_traj$inlocal)
```

```{r}
sds_umap
```

```{r}
# as people described, to plot Slingshot result, may need to give each cell a color  
sds_colors <- ss2_neur.seur_traj$inlocal
clust_colors <- neur.colors.inlocal
clust_names <- sort(unique(ss2_neur.cov$inlocal))
for(i in 1:length(clust_colors)){
  sds_colors[sds_colors==clust_names[i]] <- clust_colors[i]
}
```

```{r sds1,fig.height=7.2, fig.width=9}
plot(reducedDims(sds_umap), col = sds_colors, pch=16, cex = 0.55, asp = 0.88,
     ylim=c(-9,13.5),main="Slingshot on UMAP")
lines(sds_umap, lwd=2, type = 'lineages', col = 'black')
legend(x=-12.5,y=13.5,clust_names,cex=0.55,
       col=clust_colors,pch=c(16,16,16))
```
       
       
seems the trajectory is a bit hard to describe.   

well, no direction yet,     
here just take a look, all those methods are doing the same thing: Dimension Reduction,          
which one is better has been discussed a lot,     
just as https://broadinstitute.github.io/2020_scWorkshop/trajectory-inference.html,    
those google slides make a good introduction.    

additionally check pseudotime in monocle3.    


### Monocle3 Pseudotime     
ref. https://cole-trapnell-lab.github.io/monocle3/docs/trajectories/#learn-graph     


```{r message=FALSE, warning=FALSE}
# perform seruat v3 object to monocle v3 trajectory analysis  
# ref. https://github.com/satijalab/seurat/issues/1658  
gene_annt <- as.data.frame(rownames(ss2_neur.seur_traj@reductions[['pca']]@feature.loadings),
                           row.names = rownames(ss2_neur.seur_traj@reductions[['pca']]@feature.loadings))
colnames(gene_annt) <- "gene_short_name"
# genes in @feature.loadings is the seurat used variable genes ! 
# so here just use those about 1500 features instead of whole >10k genes.  

cell_meta <- as.data.frame(ss2_neur.seur_traj@meta.data)

new_mtx <- ss2_neur.seur_traj@assays[['RNA']]@counts
new_mtx <- new_mtx[rownames(ss2_neur.seur_traj@reductions[['pca']]@feature.loadings),]

cds <- new_cell_data_set(new_mtx,
                         cell_metadata = cell_meta,
                         gene_metadata = gene_annt)

recreate.partition <- c(rep(1,length(cds@colData@rownames)))
#recreate.partition <- ss2_neur.seur_traj@meta.data$K300
names(recreate.partition) <- cds@colData@rownames
recreate.partition <- as.factor(recreate.partition)

cds@clusters@listData[['UMAP']][['partitions']] <- recreate.partition
#cds@clusters@listData[['tSNE']][['partitions']] <- recreate.partition

list_clusters <- ss2_neur.seur_traj@meta.data$inlocal
names(list_clusters) <- rownames(ss2_neur.seur_traj@meta.data)

cds@clusters@listData[['UMAP']][['clusters']] <- list_clusters
#cds@clusters@listData[['tSNE']][['clusters']] <- list_clusters

cds@clusters@listData[['UMAP']][['louvarin_res']] <- "NA"
#cds@clusters@listData[['tSNE']][['louvarin_res']] <- "NA"
cds@int_colData@listData[['reducedDims']][["UMAP"]] <- ss2_neur.seur_traj@reductions[['umap']]@cell.embeddings
#cds@int_colData@listData[['reducedDims']][["tSNE"]] <- ss2_neur.seur_traj@reductions[['tsne']]@cell.embeddings

cds@preprocess_aux$gene_loadings <- ss2_neur.seur_traj@reductions[["pca"]]@feature.loadings
# UMAP from Seurat v3 to Monocle v3 done.  

cds <- learn_graph(cds)
```

```{r eval=FALSE, include=FALSE}
cds
```


similar to DM, but more branches making it complex.            


```{r echo=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, cds_umap2,fig.width=6}
plot_cells(cds, label_groups_by_cluster = T, reduction_method = "UMAP",group_label_size = 3.5,graph_label_size = 3,cell_size = 0.75)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
root_cells <- rownames(ss2_neur.seur_traj@meta.data %>% filter(K300 == "neur_1.1") )[
  order((ss2_neur.seur_traj@meta.data %>% filter(K300 == "neur_1.1"))$nGene)[1:10]]
cds <- order_cells(cds,root_cells = root_cells )
#manually choose 10 cells in neur_1.1 with the smallest nGene values as 'root_cells',       
#so there are directions starting in color 0:'dark purple'.   
```

    
```{r eval=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, cds_umap3,fig.width=7, include=FALSE}
plot_cells(cds,color_cells_by = "pseudotime",show_trajectory_graph = TRUE,group_label_size = 4.5,graph_label_size = 4,cell_size = 0.75)
```

```{r eval=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, cds_umap4,fig.width=6.5, include=FALSE}
DimPlot(ss2_neur.seur_traj, group.by = 'nGene', reduction = 'umap',cols = material.heat(1909)) + labs(title = "nGene distribution")  + 
             guides(colour = guide_coloursteps(show.limits = TRUE,label=FALSE))
```
      
##### about this pseudotime map, at present nothing further to tell about it.      
    
## DEGs of five major groups     
    
nuclei info    
```{r}
table(ss2_neur.cov$major)
```

### volcano plots    
   

```{r}
# quantile with step 0.05
test_quant.major <- data.frame(quantile(ss2_neur.masts_inlocal.major.filt1$alpha - ss2_neur.masts_inlocal.major.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.major) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.major.filt1$alpha - ss2_neur.masts_inlocal.major.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.9))
text(x=0:20*1.2+0.65,y=test_quant.major[,1]+0.025*test_quant.major[,1]/abs(test_quant.major[,1]),round(test_quant.major[,1],3),cex=0.7)
```

#### PEMNs   

```{r volcano_major1PEMNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPEMNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPEMNs"))$padjD)),
     pch=16,col="grey",
     main="PEMNs", xlab="DE coefficient (PEMNs vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=3.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPEMNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPEMNs"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPEMNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPEMNs"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPEMNs"))$coefD+0.1,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPEMNs" ))$padjD)+2.8),
     (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPEMNs"))$gene,cex=0.6)

legend(x=0,y=310,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    

#### PIMNs   

```{r volcano_major1PIMNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPIMNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPIMNs"))$padjD)),
     pch=16,col="grey",
     main="PIMNs", xlab="DE coefficient (PIMNs vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=4.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPIMNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPIMNs"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPIMNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPIMNs"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPIMNs"))$coefD+0.1,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPIMNs" ))$padjD)+3.8),
     (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPIMNs"))$gene,cex=0.6)

legend(x=0,y=320,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```    
    

#### PINs     

```{r volcano_major1PINs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPINs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPINs"))$padjD)),
     pch=16,col="grey",
     main="PINs", xlab="DE coefficient (PINs vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=3.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPINs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPINs"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPINs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPINs"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPINs"))$coefD+0.1,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPINs" ))$padjD)+1.8),
     (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPINs"))$gene,cex=0.6)

legend(x=0,y=140,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    

#### PSNs     

```{r volcano_major1PSNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPSNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPSNs"))$padjD)),
     pch=16,col="grey",
     main="PSNs", xlab="DE coefficient (PSNs vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=3.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPSNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPSNs"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSNs"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSNs"))$coefD+0.08,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSNs" ))$padjD)+1.8),
     (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSNs"))$gene,cex=0.6)

legend(x=0,y=140,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    

#### PSVNs   

```{r volcano_major1PSVNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPSVNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major %>% filter(coefD > 0 & contrast=="identPSVNs"))$padjD)),
     pch=16,col="grey",
     main="PSVNs", xlab="DE coefficient (PSVNs vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=3.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPSVNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt1 %>% filter(contrast=="identPSVNs"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSVNs"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSVNs"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSVNs"))$coefD+0.1,
                logP=-log10((ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSVNs" ))$padjD)+1.5),
     (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSVNs"))$gene,cex=0.6)

legend(x=0,y=100,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

    
### DEGs       

#### PEMNs DEGs    

```{r ss2_neur_major_1, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(neur.colors.inlocal_PEMN[1:7],rep("grey",18))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPEMNs") %>% arrange(padjD))$gene
```
   
##### this Oprk1/Fgfr2, which is found in PEMN_5/7 above, might be better than Chat+Tac+ to define PEMNs ~     
##### however, to cluster PEMNs/PIMNs into 7-8 subgroups could be a little more.   

```{r feat_major_1,fig.width=12,fig.height=49.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPEMNs") %>% arrange(padjD))$gene[1:85],ncol = 4)
```
     
#### PIMNs DEGs    

```{r ss2_neur_major_2, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",7),neur.colors.inlocal_PIMN[1:8],rep("grey",10))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPIMNs") %>% arrange(padjD))$gene
```
   

```{r feat_major_2,fig.width=12,fig.height=67.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPIMNs") %>% arrange(padjD))$gene[1:107],ncol = 4)
```
    
#### PSNs DEGs    

```{r ss2_neur_major_3, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",19),neur.colors.inlocal_PSN[1:4],rep("grey",2))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSNs") %>% arrange(padjD))$gene
```
   

```{r feat_major_3,fig.width=12,fig.height=62.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSNs") %>% arrange(padjD))$gene[1:97],ncol = 4)
```
    
#### PINs DEGs    

```{r ss2_neur_major_4, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",15),neur.colors.inlocal_PIN[1:4],rep("grey",6))) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPINs") %>% arrange(padjD))$gene
```
   

```{r feat_major_4,fig.width=12,fig.height=97.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPINs") %>% arrange(padjD))$gene[1:153],ncol = 4)
```
    
#### PSVNs DEGs    

```{r ss2_neur_major_5, fig.height=7.6, fig.width=6.4, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,label.size = 3) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
DimPlot(ss2_neur.seur, group.by = 'inlocal', label = F, cols = c(rep("grey",23),neur.colors.inlocal_PSVN[1:2])) + 
  labs(title = "ss2_neur inlocal") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio=0.88),
cols = 1)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSVNs") %>% arrange(padjD))$gene
```
   

```{r feat_major_5,fig.width=12,fig.height=62.5}
FeaturePlot(ss2_neur.seur,
            (ss2_neur.masts_inlocal.major.filt2 %>% filter(contrast=="identPSVNs") %>% arrange(padjD))$gene[1:97],ncol = 4)
```
    

## DEGs of different conditions    

### Age    

nuclei with Age info     
```{r}
table(ss2_neur.seur@meta.data$Age_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_neur.masts_inlocal.Age.filt1$alpha - ss2_neur.masts_inlocal.Age.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Age.filt1$alpha - ss2_neur.masts_inlocal.Age.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.45))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.02*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=13,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age2, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=46,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Age_1, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Age_Processed',label = F) + 
  coord_fixed(0.88) + labs(title = "ss2_neur Age"),
cols = 1)
```
   
#### Age DEGs
    
##### Old upregulated       

```{r}
(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene
```

```{r echo=FALSE, fig.height=19.5, message=FALSE, warning=FALSE, violin_Age1,fig.width=6}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[1:13], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[14:26], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identOld"))$gene[27:39], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
cols = 3)
```


##### Young upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r echo=FALSE,message=FALSE,warning=FALSE,violin_Age2,fig.width=8,fig.height=49.5}
multiplot(
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[1:33], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[34:66], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[67:99], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age.filt2 %>% filter(contrast=="identYoung"))$gene[100:132], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

### Age_PEMNs    

nuclei with Age info     
```{r}
table(ss2_neur.seur@meta.data[grep("PEMN",ss2_neur.seur@meta.data$inlocal),"Age_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_neur.masts_inlocal.Age_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PEMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Age_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PEMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.4))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.012*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age11PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
#               logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$padjD)+0.8),
#     (ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=6,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age21PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.2),
     (ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=12.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Age_1_PEMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(neur.colors.inlocal_PEMN,rep("grey",18))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Age_Processed',label = F, pt.size = 0.55,
        cells = grep("PEMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Age_PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Age_PEMNs DEGs
    
##### Old upregulated       
    
none.   
```{r}
(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$gene
```

```{r eval=FALSE, fig.height=19.5, message=FALSE, warning=FALSE, include=FALSE, violin_Age1_PEMNs,fig.width=6}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$gene[1:13], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$gene[14:26], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identOld"))$gene[27:39], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 3)
```


##### Young upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r echo=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, violin_Age2_PEMNs,fig.width=4}
multiplot(
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PEMNs.filt2 %>% filter(contrast=="identYoung"))$gene[4:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),

cols = 2)
```

    
### Age_PIMNs    

nuclei with Age info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIMN",ss2_neur.seur@meta.data$inlocal),"Age_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_neur.masts_inlocal.Age_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PIMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Age_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PIMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.4))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.012*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age11PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$padjD)+0.1),
     (ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=7,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age21PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=21,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Age_1_PIMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",7),neur.colors.inlocal_PIMN,rep("grey",10))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Age_Processed',label = F, pt.size = 0.55,
        cells = grep("PIMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Age_PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Age_PIMNs DEGs
    
##### Old upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$gene
```

```{r echo=FALSE, fig.height=6, message=FALSE, warning=FALSE, violin_Age1_PIMNs,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identOld"))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),

cols = 2)
```


##### Young upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r echo=FALSE, fig.height=13.5, message=FALSE, warning=FALSE, violin_Age2_PIMNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene[1:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene[10:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene[19:27], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene[28:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene[37:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```

```{r echo=FALSE, fig.height=1.5, message=FALSE, warning=FALSE, violin_Age21_PIMNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PIMNs.filt2 %>% filter(contrast=="identYoung"))$gene[46:46], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Age_PSNs    

nuclei with Age info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSN",ss2_neur.seur@meta.data$inlocal),"Age_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_neur.masts_inlocal.Age_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PSNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Age_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PSNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.018*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age11PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSNs %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSNs.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
#               logP=-log10((ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$padjD)+0.1),
#     (ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=1.2,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age21PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSNs %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSNs.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.05),
     (ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=2.1,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Age_1_PSNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",19),neur.colors.inlocal_PSN,rep("grey",2))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Age_Processed',label = F, pt.size = 0.55,
        cells = grep("PSN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Age_PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Age_PSNs DEGs
    
##### Old upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$gene
```

none.    
```{r eval=FALSE, fig.height=6, message=FALSE, warning=FALSE, include=FALSE, violin_Age1_PSNs,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identOld"))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),

cols = 2)
```


##### Young upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r eval=FALSE, fig.height=13.5, message=FALSE, warning=FALSE, include=FALSE, violin_Age2_PSNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene[1:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene[10:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene[19:27], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene[28:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene[37:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```

```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE, violin_Age21_PSNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSNs.filt2 %>% filter(contrast=="identYoung"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Age_PINs    

nuclei with Age info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIN",ss2_neur.seur@meta.data$inlocal),"Age_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_neur.masts_inlocal.Age_PINs.filt1$alpha - ss2_neur.masts_inlocal.Age_PINs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Age_PINs.filt1$alpha - ss2_neur.masts_inlocal.Age_PINs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.015*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age11PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PINs %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PINs.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
#               logP=-log10((ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$padjD)+0.1),
#     (ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=2,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age21PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PINs %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PINs.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.1),
     (ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=4.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Age_1_PINs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",15),neur.colors.inlocal_PIN,rep("grey",6))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Age_Processed',label = F, pt.size = 0.55,
        cells = grep("PIN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Age_PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Age_PINs DEGs
    
##### Old upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$gene
```

none.   
```{r eval=FALSE, fig.height=6, message=FALSE, warning=FALSE, include=FALSE, violin_Age1_PINs,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identOld"))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),

cols = 2)
```


##### Young upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene
```

```{r eval=FALSE, fig.height=13.5, message=FALSE, warning=FALSE, include=FALSE, violin_Age2_PINs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene[1:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene[10:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene[19:27], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene[28:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene[37:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```

```{r echo=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, violin_Age21_PINs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PINs.filt2 %>% filter(contrast=="identYoung"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Age_PSVNs    

nuclei with Age info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSVN",ss2_neur.seur@meta.data$inlocal),"Age_Processed"])
```

such ratio getting no result for filt1 filtering.   

```{r eval=FALSE, include=FALSE}
# quantile with step 0.05
test_quant.Age <- data.frame(quantile(ss2_neur.masts_inlocal.Age_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PSVNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Age) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Age_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Age_PSVNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.4))
text(x=0:20*1.2+0.65,y=test_quant.Age[,1]+0.012*test_quant.Age[,1]/abs(test_quant.Age[,1]),round(test_quant.Age[,1],3),cex=0.7)
```

```{r volcano_Age11PSVNs, eval=FALSE, fig.height=10, fig.width=10, include=FALSE}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs %>% filter(coefD > 0 & contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs %>% filter(coefD > 0 & contrast=="identOld"))$padjD)),
     pch=16,col="grey",
     main="Old", xlab="DE coefficient (Old vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs.filt1 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs.filt1 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$padjD)+0.1),
     (ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$gene,cex=0.6)

legend(x=0,y=7,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Age21PSVNs, eval=FALSE, fig.height=10, fig.width=10, include=FALSE}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs %>% filter(coefD > 0 & contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs %>% filter(coefD > 0 & contrast=="identYoung"))$padjD)),
     pch=16,col="grey",
     main="Young", xlab="DE coefficient (Young vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs.filt1 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs.filt1 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene,cex=0.6)

legend(x=0,y=21,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Age_1_PSVNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",23),neur.colors.inlocal_PSVN,rep("grey",0))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Age_Processed',label = F, pt.size = 0.55,
        cells = grep("PSVN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Age_PSVNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Age_PSVNs DEGs
    
##### Old upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$gene
```

none.   
```{r eval=FALSE, fig.height=6, message=FALSE, warning=FALSE, include=FALSE, violin_Age1_PSVNs,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identOld"))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),

cols = 2)
```


##### Young upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene
```

none.   
```{r eval=FALSE, fig.height=13.5, message=FALSE, warning=FALSE, include=FALSE, violin_Age2_PSVNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene[1:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene[10:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene[19:27], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene[28:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene[37:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```

```{r eval=FALSE, fig.height=1.5, message=FALSE, warning=FALSE, include=FALSE, violin_Age21_PSVNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Age_PSVNs.filt2 %>% filter(contrast=="identYoung"))$gene[46:46], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Age_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Age_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Model    
    
    
nuclei with Model info     
```{r}
table(ss2_neur.seur@meta.data$Model_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Model <- data.frame(quantile(ss2_neur.masts_inlocal.Model.filt1$alpha - ss2_neur.masts_inlocal.Model.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Model) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Model.filt1$alpha - ss2_neur.masts_inlocal.Model.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.5))
text(x=0:20*1.2+0.65,y=test_quant.Model[,1]+0.02*test_quant.Model[,1]/abs(test_quant.Model[,1]),round(test_quant.Model[,1],3),cex=0.7)
```
   
```{r volcano_Model1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model %>% filter(coefD > 0 & contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model %>% filter(coefD > 0 & contrast=="identUchl1"))$padjD)),
     pch=16,col="grey",
     main="Uchl1", xlab="DE coefficient (Uchl1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=7.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model.filt1 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model.filt1 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$padjD)+2.8),
     (ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$gene,cex=0.6)

legend(x=0,y=180,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

   
```{r volcano_Model2, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model %>% filter(coefD > 0 & contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model %>% filter(coefD > 0 & contrast=="identSox10"))$padjD)),
     pch=16,col="grey",
     main="Sox10", xlab="DE coefficient (Sox10 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.1,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model.filt1 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model.filt1 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$gene,cex=0.6)

legend(x=0,y=48,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
        
```{r ss2_neur_Model_1, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Model_Processed',label = F) + 
  coord_fixed(0.88) + labs(title = "ss2_neur Model"),
cols = 1)
```
   
   
#### Model DEGs
    
##### Uchl1 upregulated       

```{r}
(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$gene
```

```{r echo=FALSE, fig.height=96, warning=FALSE, messModel=FALSE, violin_Model1,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$gene[1:64], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$gene[65:128], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$gene[129:192], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identUchl1"))$gene[193:256], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```


##### Sox10 upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$gene
```

```{r echo=FALSE,messModel=FALSE,warning=FALSE,violin_Model2,fig.width=8,fig.height=36}
multiplot(
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$gene[1:24], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$gene[25:48], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$gene[49:72], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model.filt2 %>% filter(contrast=="identSox10"))$gene[73:96], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

### Model_PEMNs    

nuclei with Model info     
```{r}
table(ss2_neur.seur@meta.data[grep("PEMN",ss2_neur.seur@meta.data$inlocal),"Model_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Model <- data.frame(quantile(ss2_neur.masts_inlocal.Model_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PEMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Model) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Model_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PEMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Model[,1]+0.012*test_quant.Model[,1]/abs(test_quant.Model[,1]),round(test_quant.Model[,1],3),cex=0.7)
```

```{r volcano_Model11PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs %>% filter(coefD > 0 & contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs %>% filter(coefD > 0 & contrast=="identUchl1"))$padjD)),
     pch=16,col="grey",
     main="Uchl1", xlab="DE coefficient (Uchl1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs.filt1 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs.filt1 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$gene,cex=0.6)

legend(x=0,y=56,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Model21PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs %>% filter(coefD > 0 & contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs %>% filter(coefD > 0 & contrast=="identSox10"))$padjD)),
     pch=16,col="grey",
     main="Sox10", xlab="DE coefficient (Sox10 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs.filt1 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs.filt1 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$gene,cex=0.6)

legend(x=0,y=19,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Model_1_PEMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(neur.colors.inlocal_PEMN,rep("grey",18))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Model_Processed',label = F, pt.size = 0.55,
        cells = grep("PEMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Model_PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Model_PEMNs DEGs
    
##### Uchl1 upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$gene
```

```{r echo=FALSE, fig.height=28.5, warning=FALSE, messModel=FALSE, violin_Model1_PEMNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[1:19], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[20:38], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[39:57], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[58:76], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messModel=FALSE, violin_Model2_PEMNs,fig.width=2}
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[77:77], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

##### Sox10 upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messModel=FALSE, violin_Model2_PEMNs2,fig.width=8}
multiplot(
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$gene[9:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PEMNs.filt2 %>% filter(contrast=="identSox10"))$gene[13:16], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

    
### Model_PIMNs    

nuclei with Model info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIMN",ss2_neur.seur@meta.data$inlocal),"Model_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Model <- data.frame(quantile(ss2_neur.masts_inlocal.Model_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PIMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Model) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Model_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PIMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.50))
text(x=0:20*1.2+0.65,y=test_quant.Model[,1]+0.012*test_quant.Model[,1]/abs(test_quant.Model[,1]),round(test_quant.Model[,1],3),cex=0.7)
```

```{r volcano_Model11PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs %>% filter(coefD > 0 & contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs %>% filter(coefD > 0 & contrast=="identUchl1"))$padjD)),
     pch=16,col="grey",
     main="Uchl1", xlab="DE coefficient (Uchl1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs.filt1 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs.filt1 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)+1.2),
     (ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$gene,cex=0.6)

legend(x=0,y=78,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Model21PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs %>% filter(coefD > 0 & contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs %>% filter(coefD > 0 & contrast=="identSox10"))$padjD)),
     pch=16,col="grey",
     main="Sox10", xlab="DE coefficient (Sox10 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs.filt1 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs.filt1 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene,cex=0.6)

legend(x=0,y=25,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Model_1_PIMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",7),neur.colors.inlocal_PIMN,rep("grey",10))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Model_Processed',label = F, pt.size = 0.55,
        cells = grep("PIMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Model_PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Model_PIMNs DEGs
    
##### Uchl1 upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$gene
```

```{r echo=FALSE, fig.height=46.5, messModel=FALSE, warning=FALSE, violin_Model1_PIMNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[1:31], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[32:62], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[63:93], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[94:124], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identUchl1"))$gene[125:155], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```


##### Sox10 upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene
```

```{r echo=FALSE, fig.height=19.5, messModel=FALSE, warning=FALSE, violin_Model2_PIMNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene[1:13], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene[14:26], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene[27:39], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene[40:52], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene[53:65], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```

```{r echo=FALSE, fig.height=6, messModel=FALSE, warning=FALSE, violin_Model21_PIMNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PIMNs.filt2 %>% filter(contrast=="identSox10"))$gene[66:69], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Model_PSNs    

nuclei with Model info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSN",ss2_neur.seur@meta.data$inlocal),"Model_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Model <- data.frame(quantile(ss2_neur.masts_inlocal.Model_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PSNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Model) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Model_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PSNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Model[,1]+0.018*test_quant.Model[,1]/abs(test_quant.Model[,1]),round(test_quant.Model[,1],3),cex=0.7)
```

```{r volcano_Model11PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs %>% filter(coefD > 0 & contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSNs %>% filter(coefD > 0 & contrast=="identUchl1"))$padjD)),
     pch=16,col="grey",
     main="Uchl1", xlab="DE coefficient (Uchl1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs.filt1 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSNs.filt1 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$gene,cex=0.6)

legend(x=0,y=14.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Model21PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs %>% filter(coefD > 0 & contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSNs %>% filter(coefD > 0 & contrast=="identSox10"))$padjD)),
     pch=16,col="grey",
     main="Sox10", xlab="DE coefficient (Sox10 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs.filt1 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSNs.filt1 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$padjD)+0.15),
     (ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$gene,cex=0.6)

legend(x=0,y=7.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Model_1_PSNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",19),neur.colors.inlocal_PSN,rep("grey",2))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Model_Processed',label = F, pt.size = 0.55,
        cells = grep("PSN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Model_PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Model_PSNs DEGs
    
##### Uchl1 upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$gene
```

  
```{r echo=FALSE, fig.height=16.5, warning=FALSE, messModel=FALSE, violin_Model1_PSNs,fig.width=6}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$gene[1:11], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$gene[12:22], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identUchl1"))$gene[23:33], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 3)
```


##### Sox10 upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$gene
```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messModel=FALSE, violin_Model2_PSNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$gene[4:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$gene[7:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSNs.filt2 %>% filter(contrast=="identSox10"))$gene[10:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```


### Model_PINs    

nuclei with Model info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIN",ss2_neur.seur@meta.data$inlocal),"Model_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Model <- data.frame(quantile(ss2_neur.masts_inlocal.Model_PINs.filt1$alpha - ss2_neur.masts_inlocal.Model_PINs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Model) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Model_PINs.filt1$alpha - ss2_neur.masts_inlocal.Model_PINs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Model[,1]+0.015*test_quant.Model[,1]/abs(test_quant.Model[,1]),round(test_quant.Model[,1],3),cex=0.7)
```

```{r volcano_Model11PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs %>% filter(coefD > 0 & contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PINs %>% filter(coefD > 0 & contrast=="identUchl1"))$padjD)),
     pch=16,col="grey",
     main="Uchl1", xlab="DE coefficient (Uchl1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs.filt1 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PINs.filt1 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$coefD+0.03,
               logP=-log10((ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$padjD)+0.2),
     (ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$gene,cex=0.6)

legend(x=0,y=12.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Model21PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs %>% filter(coefD > 0 & contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PINs %>% filter(coefD > 0 & contrast=="identSox10"))$padjD)),
     pch=16,col="grey",
     main="Sox10", xlab="DE coefficient (Sox10 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs.filt1 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PINs.filt1 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$padjD)+0.1),
#     (ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$gene,cex=0.6)

legend(x=0,y=4.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Model_1_PINs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",15),neur.colors.inlocal_PIN,rep("grey",6))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Model_Processed',label = F, pt.size = 0.55,
        cells = grep("PIN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Model_PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Model_PINs DEGs
    
##### Uchl1 upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$gene
```

    
```{r echo=FALSE, fig.height=9, warning=FALSE, messModel=FALSE, violin_Model1_PINs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$gene[1:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$gene[7:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$gene[13:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$gene[19:24], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identUchl1"))$gene[25:30], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```


##### Sox10 upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$gene
```

None.   
```{r eval=FALSE, fig.height=13.5, messModel=FALSE, warning=FALSE, include=FALSE, violin_Model2_PINs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$gene[1:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$gene[10:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$gene[19:27], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$gene[28:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PINs.filt2 %>% filter(contrast=="identSox10"))$gene[37:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```



### Model_PSVNs    

nuclei with Model info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSVN",ss2_neur.seur@meta.data$inlocal),"Model_Processed"])
```

such ratio getting no result for filt1 filtering.   

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Model <- data.frame(quantile(ss2_neur.masts_inlocal.Model_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PSVNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Model) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Model_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Model_PSVNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.65))
text(x=0:20*1.2+0.65,y=test_quant.Model[,1]+0.015*test_quant.Model[,1]/abs(test_quant.Model[,1]),round(test_quant.Model[,1],3),cex=0.7)
```

```{r volcano_Model11PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs %>% filter(coefD > 0 & contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs %>% filter(coefD > 0 & contrast=="identUchl1"))$padjD)),
     pch=16,col="grey",
     main="Uchl1", xlab="DE coefficient (Uchl1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs.filt1 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs.filt1 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identUchl1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identUchl1"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identUchl1"))$padjD)+0.15),
     (ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identUchl1"))$gene,cex=0.6)

legend(x=0,y=8,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Model21PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs %>% filter(coefD > 0 & contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs %>% filter(coefD > 0 & contrast=="identSox10"))$padjD)),
     pch=16,col="grey",
     main="Sox10", xlab="DE coefficient (Sox10 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs.filt1 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs.filt1 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$padjD)+0.3),
#     (ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$gene,cex=0.6)

legend(x=0,y=1.4,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Model_1_PSVNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",23),neur.colors.inlocal_PSVN,rep("grey",0))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Model_Processed',label = F, pt.size = 0.55,
        cells = grep("PSVN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Model_PSVNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Model_PSVNs DEGs
    
##### Uchl1 upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identUchl1"))$gene
```

   
```{r echo=FALSE, fig.height=4.5, warning=FALSE, messModel=FALSE, violin_Model1_PSVNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identUchl1"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### Sox10 upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$gene
```

none.   
```{r eval=FALSE, fig.height=13.5, messModel=FALSE, warning=FALSE, include=FALSE, violin_Model2_PSVNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$gene[1:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$gene[10:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$gene[19:27], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$gene[28:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Model_PSVNs.filt2 %>% filter(contrast=="identSox10"))$gene[37:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Model_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Model_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```

  
    
### Segment    
    
nuclei with Segment info   
```{r}
table(ss2_neur.seur@meta.data$Segment_Processed)
```
    
```{r}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_neur.masts_inlocal.Segment.filt1$alpha - ss2_neur.masts_inlocal.Segment.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Segment.filt1$alpha - ss2_neur.masts_inlocal.Segment.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(-0.15,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.02*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```
      
        
```{r volcano_Segment1, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$padjD)+1.8),
     (ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=110,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```    

```{r volcano_Segment2, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=5.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$padjD)+1.8),
     (ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=150,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```  


```{r ss2_neur_Segment_1, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment_Processed',label = F) + labs(title = "ss2_neur Segment") +
  coord_fixed(0.88),
cols = 1)
```
   
#### Segment DEGs

##### Distal upregulated       

```{r}
(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene
```

```{r echo=FALSE, fig.height=43.5, warning=FALSE, messSegment=FALSE, violin_Segment1,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[1:29], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[30:58], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[59:87], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identDistal"))$gene[88:116], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

##### Proximal upregulated       

```{r}
(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene
```

```{r echo=FALSE, fig.height=31.5, warning=FALSE, messSegment=FALSE, violin_Segment2,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[1:21], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[22:42], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[43:63], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[64:84], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[85:105], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6)),
cols = 5)
```
   
```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Segment21,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment.filt2 %>% filter(contrast=="identProximal"))$gene[106:107], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"])], 
            ylim=c(0,6))
```    
    
### Segment_PEMNs    

nuclei with Segment info     
```{r}
table(ss2_neur.seur@meta.data[grep("PEMN",ss2_neur.seur@meta.data$inlocal),"Segment_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_neur.masts_inlocal.Segment_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PEMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Segment_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PEMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.012*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```

```{r volcano_Segment11PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=24.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Segment21PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$padjD)+0.5),
     (ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=40,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Segment_1_PEMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(neur.colors.inlocal_PEMN,rep("grey",18))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment_Processed',label = F, pt.size = 0.55,
        cells = grep("PEMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Segment_PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Segment_PEMNs DEGs
    
##### Distal upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$gene
```

```{r echo=FALSE, fig.height=10.5, warning=FALSE, messSegment=FALSE, violin_Segment1_PEMNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$gene[1:7], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$gene[8:14], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$gene[15:21], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$gene[22:28], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSegment=FALSE, violin_Segment12_PEMNs,fig.width=2}
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identDistal"))$gene[29:29], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

##### Proximal upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$gene
```

```{r echo=FALSE, fig.height=9, warning=FALSE, messSegment=FALSE, violin_Segment2_PEMNs,fig.width=8}
multiplot(
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$gene[1:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$gene[7:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$gene[13:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PEMNs.filt2 %>% filter(contrast=="identProximal"))$gene[19:24], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

    
### Segment_PIMNs    

nuclei with Segment info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIMN",ss2_neur.seur@meta.data$inlocal),"Segment_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_neur.masts_inlocal.Segment_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PIMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Segment_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PIMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.60))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.015*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```

```{r volcano_Segment11PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$padjD)+1.2),
     (ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=85,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Segment21PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=55,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Segment_1_PIMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",7),neur.colors.inlocal_PIMN,rep("grey",10))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment_Processed',label = F, pt.size = 0.55,
        cells = grep("PIMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Segment_PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Segment_PIMNs DEGs
    
##### Distal upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$gene
```

```{r echo=FALSE, fig.height=39, messSegment=FALSE, warning=FALSE, violin_Segment1_PIMNs,fig.width=6}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$gene[1:26], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$gene[27:52], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identDistal"))$gene[53:78], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 3)
```


##### Proximal upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$gene
```

```{r echo=FALSE, fig.height=22.5, messSegment=FALSE, warning=FALSE, violin_Segment2_PIMNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$gene[1:15], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$gene[16:30], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$gene[31:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$gene[46:60], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PIMNs.filt2 %>% filter(contrast=="identProximal"))$gene[61:75], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```
    

### Segment_PSNs    

nuclei with Segment info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSN",ss2_neur.seur@meta.data$inlocal),"Segment_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_neur.masts_inlocal.Segment_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PSNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Segment_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PSNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.018*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```

```{r volcano_Segment11PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identDistal"))$padjD)+0.15),
     (ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=9.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Segment21PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identProximal"))$padjD)+0.15),
     (ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=7.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Segment_1_PSNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",19),neur.colors.inlocal_PSN,rep("grey",2))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment_Processed',label = F, pt.size = 0.55,
        cells = grep("PSN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Segment_PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Segment_PSNs DEGs
    
##### Distal upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identDistal"))$gene
```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSegment=FALSE, violin_Segment1_PSNs,fig.width=2}
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identDistal"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### Proximal upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identProximal"))$gene
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSegment=FALSE, violin_Segment2_PSNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PSNs.filt2 %>% filter(contrast=="identProximal"))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Segment_PINs    

nuclei with Segment info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIN",ss2_neur.seur@meta.data$inlocal),"Segment_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_neur.masts_inlocal.Segment_PINs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PINs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Segment_PINs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PINs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.015*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```

```{r volcano_Segment11PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PINs %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PINs.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identDistal"))$coefD+0.03,
               logP=-log10((ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identDistal"))$padjD)+0.25),
     (ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=16.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Segment21PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PINs %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PINs.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=20.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Segment_1_PINs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",15),neur.colors.inlocal_PIN,rep("grey",6))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment_Processed',label = F, pt.size = 0.55,
        cells = grep("PIN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Segment_PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Segment_PINs DEGs
    
##### Distal upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identDistal"))$gene
```

    
```{r echo=FALSE, fig.height=16.5, warning=FALSE, messSegment=FALSE, violin_Segment1_PINs,fig.width=2}
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identDistal"))$gene[1:11], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### Proximal upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$gene
```

  
```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSegment=FALSE, violin_Segment2_PINs,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PINs.filt2 %>% filter(contrast=="identProximal"))$gene[4:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 2)
```



### Segment_PSVNs    

nuclei with Segment info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSVN",ss2_neur.seur@meta.data$inlocal),"Segment_Processed"])
```

such ratio getting no result for filt1 filtering.   

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Segment <- data.frame(quantile(ss2_neur.masts_inlocal.Segment_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PSVNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Segment) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Segment_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Segment_PSVNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.65))
text(x=0:20*1.2+0.65,y=test_quant.Segment[,1]+0.015*test_quant.Segment[,1]/abs(test_quant.Segment[,1]),round(test_quant.Segment[,1],3),cex=0.7)
```

```{r volcano_Segment11PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs %>% filter(coefD > 0 & contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs %>% filter(coefD > 0 & contrast=="identDistal"))$padjD)),
     pch=16,col="grey",
     main="Distal", xlab="DE coefficient (Distal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs.filt1 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs.filt1 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identDistal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identDistal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identDistal"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identDistal"))$padjD)+0.12),
     (ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identDistal"))$gene,cex=0.6)

legend(x=0,y=6,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Segment21PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs %>% filter(coefD > 0 & contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs %>% filter(coefD > 0 & contrast=="identProximal"))$padjD)),
     pch=16,col="grey",
     main="Proximal", xlab="DE coefficient (Proximal vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs.filt1 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs.filt1 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identProximal"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identProximal"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identProximal"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identProximal"))$padjD)+0.15),
    (ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identProximal"))$gene,cex=0.6)

legend(x=0,y=9.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Segment_1_PSVNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",23),neur.colors.inlocal_PSVN,rep("grey",0))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment_Processed',label = F, pt.size = 0.55,
        cells = grep("PSVN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Segment_PSVNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Segment_PSVNs DEGs
    
##### Distal upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identDistal"))$gene
```

   
```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Segment1_PSVNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identDistal"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### Proximal upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identProximal"))$gene
```

 
```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Segment2_PSVNs,fig.width=2}
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Segment_PSVNs.filt2 %>% filter(contrast=="identProximal"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Segment_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```
    
    
    
### Seg_raw   
   
nuclei with Seg_raw info ('All' excluded)   
```{r}
table(ss2_neur.seur@meta.data$Segment)
```
   
why calculate Seg1/2/3/4 separately while already have Distal/Proximal ?   
used to try different parameters to repeat DEG results in paper,      
for Segment part, still not sure how they did it, here just list results in both ways.   

    
```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_neur.masts_inlocal.Seg_raw.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Seg_raw.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.45))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.015*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),round(test_quant.Seg_raw[,1],3),cex=0.7)
```
    
```{r volcano_Seg_raw1, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$padjD)+1.8),
     (ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=70,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.02,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.85),
     (ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=55,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=20,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$padjD)+1.2),
     (ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=75,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 
    
#### Seg_raw DEGs    
   

```{r ss2_neur_Seg_raw1, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment',label = F) + labs(title = "ss2_neur Seg_raw") +
  coord_fixed(ratio=0.88),
cols = 1)
```

##### Seg3+4(Distal) upregulated       

```{r}
(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```

```{r echo=FALSE, fig.height=61.5, warning=FALSE, messSegment=FALSE, violin_Seg34,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:41], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[42:82], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[83:123], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[124:164], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
cols = 4)
```
```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSegment=FALSE, violin_Seg34_1,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[165:167], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6))
```

##### Seg1+2(Proximal) upregulated       

```{r}
(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```


```{r echo=FALSE, fig.height=16.5, warning=FALSE, messSegment=FALSE, violin_Seg12,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:11], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[12:22], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[23:33], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[34:44], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[45:55], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6)),
cols = 5)
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messSegment=FALSE, violin_Seg12_1,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[56:59], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4")], 
            ylim=c(0,6))
```
    
### Seg_raw_PEMNs   

nuclei with Seg_raw info ('All' excluded)   
```{r}
table(ss2_neur.seur@meta.data[grep("PEMN",ss2_neur.seur@meta.data$inlocal),"Segment"])
```

```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.45))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.015*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),
     round(test_quant.Seg_raw[,1],3),cex=0.7)
```

```{r volcano_Seg_raw1_PEMNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)+0.2),
     (ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=12,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2_PEMNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.4),
     (ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=22,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3_PEMNs,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.8),
#     (ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=3.8,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4_PEMNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=15,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r ss2_neur_Seg_raw_PEMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(neur.colors.inlocal_PEMN,rep("grey",18))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment',label = F, pt.size = 0.55,
        cells = grep("PEMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Seg_raw_PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Seg_raw_PEMNs DEGs
    
##### Seg3+4(Distal) upregulated    

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messSegment=FALSE, violin_Seg34_PEMNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[9:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[13:16], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSegment=FALSE, violin_Seg34_PEMNs1,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[17:17], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

##### Seg1+2(Proximal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```

```{r echo=FALSE, fig.height=7.5, warning=FALSE, messSegment=FALSE, violin_Seg12_PEMNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:5], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[6:10], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[11:15], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PEMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[16:20], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

    
### Seg_raw_PIMNs   

nuclei with Seg_raw info ('All' excluded)   
```{r}
table(ss2_neur.seur@meta.data[grep("PIMN",ss2_neur.seur@meta.data$inlocal),"Segment"])
```

```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.60))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.015*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),
     round(test_quant.Seg_raw[,1],3),cex=0.7)
```

```{r volcano_Seg_raw1_PIMNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)+0.4),
     (ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=27,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2_PIMNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.4),
     (ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=20,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3_PIMNs,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=16,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4_PIMNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)+0.55),
     (ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=50,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r ss2_neur_Seg_raw_PIMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",7),neur.colors.inlocal_PIMN,rep("grey",10))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment',label = F, pt.size = 0.55,
        cells = grep("PIMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Seg_raw_PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Seg_raw_PIMNs DEGs
    
##### Seg3+4(Distal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```

```{r echo=FALSE, fig.height=27, warning=FALSE, messSegment=FALSE, violin_Seg34_PIMNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[19:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[37:54], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[55:72], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSegment=FALSE, violin_Seg34_PIMNs1,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[73:73], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

##### Seg1+2(Proximal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```

```{r echo=FALSE, fig.height=19.5, warning=FALSE, messSegment=FALSE, violin_Seg12_PIMNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:13], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[14:26], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[27:39], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[40:52], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PIMNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[53:65], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```

    
### Seg_raw_PSNs   

nuclei with Seg_raw info ('All' excluded)   
```{r}
table(ss2_neur.seur@meta.data[grep("PSN",ss2_neur.seur@meta.data$inlocal),"Segment"])
```

```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.65))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.015*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),
     round(test_quant.Seg_raw[,1],3),cex=0.7)
```

```{r volcano_Seg_raw1_PSNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)+0.2),
#     (ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=3,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2_PSNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.4),
#     (ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=1.2,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3_PSNs,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.8),
#     (ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=3.3,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4_PSNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)+0.02),
     (ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=1.8,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r ss2_neur_Seg_raw_PSNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",19),neur.colors.inlocal_PSN,rep("grey",2))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment',label = F, pt.size = 0.55,
        cells = grep("PSN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Seg_raw_PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Seg_raw_PSNs DEGs
    
##### Seg3+4(Distal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```


```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSegment=FALSE, violin_Seg34_PSNs1,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

##### Seg1+2(Proximal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```
   
None.   
```{r eval=FALSE, fig.height=7.5, warning=FALSE, include=FALSE, messSegment=FALSE, violin_Seg12_PSNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:5], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[6:10], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[11:15], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[16:20], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```


    
### Seg_raw_PINs   

nuclei with Seg_raw info ('All' excluded)   
```{r}
table(ss2_neur.seur@meta.data[grep("PIN",ss2_neur.seur@meta.data$inlocal),"Segment"])
```

```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_neur.masts_inlocal.Seg_raw_PINs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PINs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Seg_raw_PINs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PINs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.015*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),
     round(test_quant.Seg_raw[,1],3),cex=0.7)
```

```{r volcano_Seg_raw1_PINs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg1"))$padjD)+0.2),
     (ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=15,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2_PINs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.08),
     (ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=3.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3_PINs,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.8),
#     (ss2_neur.masts_inlocal.Seg_raw.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=1.4,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4_PINs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg4"))$padjD)+0.2),
     (ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=12.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r ss2_neur_Seg_raw_PINs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",15),neur.colors.inlocal_PIN,rep("grey",6))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment',label = F, pt.size = 0.55,
        cells = grep("PIN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Seg_raw_PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Seg_raw_PINs DEGs
    
##### Seg3+4(Distal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messSegment=FALSE, violin_Seg34_PINs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[9:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[13:16], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```


##### Seg1+2(Proximal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```

```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Seg12_PINs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PINs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


    
### Seg_raw_PSVNs   

nuclei with Seg_raw info ('All' excluded)   
```{r}
table(ss2_neur.seur@meta.data[grep("PSVN",ss2_neur.seur@meta.data$inlocal),"Segment"])
```

```{r}
# quantile with step 0.05
test_quant.Seg_raw <- data.frame(quantile(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Seg_raw) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.55))
text(x=0:20*1.2+0.65,y=test_quant.Seg_raw[,1]+0.015*test_quant.Seg_raw[,1]/abs(test_quant.Seg_raw[,1]),
     round(test_quant.Seg_raw[,1],3),cex=0.7)
```

```{r volcano_Seg_raw1_PSVNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg1"))$padjD)),
     pch=16,col="grey",
     main="Seg1", xlab="DE coefficient (Seg1 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg1"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg1"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg1"))$padjD)+0.2),
#     (ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg1"))$gene,cex=0.6)

legend(x=0,y=3.3,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw2_PSVNs, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg2"))$padjD)),
     pch=16,col="grey",
     main="Seg2", xlab="DE coefficient (Seg2 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg2"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg2"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg2"))$padjD)+0.4),
#     (ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg2"))$gene,cex=0.6)

legend(x=0,y=1,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Seg_raw3_PSVNs,fig.width=8,fig.height=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg3"))$padjD)),
     pch=16,col="grey",
     main="Seg3", xlab="DE coefficient (Seg3 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg3"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg3"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg3"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg3"))$padjD)+0.02),
     (ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg3"))$gene,cex=0.6)

legend(x=0,y=1.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Seg_raw4_PSVNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs %>% filter(coefD > 0 & contrast=="identSeg4"))$padjD)),
     pch=16,col="grey",
     main="Seg4", xlab="DE coefficient (Seg4 vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt1 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg4"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg4"))$coefD+0.02,
                logP=-log10((ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg4"))$padjD)+0.05),
     (ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast=="identSeg4"))$gene,cex=0.6)

legend(x=0,y=2.3,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r ss2_neur_Seg_raw_PSVNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",23),neur.colors.inlocal_PSVN,rep("grey",0))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Segment',label = F, pt.size = 0.55,
        cells = grep("PSVN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Seg_raw_PSVNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Seg_raw_PSVNs DEGs
    
##### Seg3+4(Distal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene
```


```{r echo=FALSE, fig.height=3, warning=FALSE, messSegment=FALSE, violin_Seg34_PSVNs1,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% 
                     filter(contrast == "identSeg3" |contrast == "identSeg4" ))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

##### Seg1+2(Proximal) upregulated    

```{r}
(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene
```
   
None.    
```{r eval=FALSE, fig.height=7.5, warning=FALSE, include=FALSE, messSegment=FALSE, violin_Seg12_PSVNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[1:5], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[6:10], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[11:15], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Seg_raw_PSVNs.filt2 %>% 
                     filter(contrast == "identSeg1" |contrast == "identSeg2" ))$gene[16:20], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Segment_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[ss2_neur.seur@meta.data[,"Segment"] %in% c("1","2","3","4") &
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```


### Sex    
  
nuclei with Sex info   
```{r}
table(ss2_neur.seur@meta.data$Sex_Processed)
```

```{r}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_neur.masts_inlocal.Sex.filt1$alpha - ss2_neur.masts_inlocal.Sex.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Sex.filt1$alpha - ss2_neur.masts_inlocal.Sex.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.03*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (Male vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=5.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$padjD)+3),
     (ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=250,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r volcano_Sex2, echo=FALSE, fig.height=8, fig.width=8}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey", xlim=c(0,3),
     main="Female", xlab="DE coefficient (Female vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=38,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r ss2_neur_Sex1, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Sex_Processed',label = F) + labs(title = "ss2_neur Sex") +
  coord_fixed(ratio=0.95),
cols = 1)
```

   
#### Sex DEGs

##### Male upregulated       

```{r}
(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messSegment=FALSE, violin_Sex1,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene[5:8], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene[9:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identM"))$gene[13:16], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
cols = 4)
```

```{r eval=FALSE, include=FALSE}
(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene
```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSegment=FALSE, violin_Sex2,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex.filt2 %>% filter(contrast=="identF"))$gene[4:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"])], 
            ylim=c(0,6)),

cols = 2)
```

### Sex_PEMNs    

nuclei with Sex info     
```{r}
table(ss2_neur.seur@meta.data[grep("PEMN",ss2_neur.seur@meta.data$inlocal),"Sex_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_neur.masts_inlocal.Sex_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PEMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Sex_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PEMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.025*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex11PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (M vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identM"))$padjD)+1.2),
     (ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=80,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Sex21PEMNs,fig.width=10,fig.height=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey",
     main="Female", xlab="DE coefficient (F vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identF"))$padjD)+3.3),
     (ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=190,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Sex_1_PEMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(neur.colors.inlocal_PEMN,rep("grey",18))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Sex_Processed',label = F, pt.size = 0.55,
        cells = grep("PEMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Sex_PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Sex_PEMNs DEGs
    
##### M upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identM"))$gene
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSex=FALSE, violin_Sex1_PEMNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identM"))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```



##### F upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identF"))$gene
```

```{r echo=FALSE, fig.height=3, warning=FALSE, messSex=FALSE, violin_Sex2_PEMNs,fig.width=2}
  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PEMNs.filt2 %>% filter(contrast=="identF"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

    
### Sex_PIMNs    

nuclei with Sex info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIMN",ss2_neur.seur@meta.data$inlocal),"Sex_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_neur.masts_inlocal.Sex_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PIMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Sex_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PIMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.025*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex11PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (M vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$padjD)+1.2),
     (ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=98,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Sex21PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey",
     main="Female", xlab="DE coefficient (F vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identF"))$padjD)+3.3),
     (ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=280,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Sex_1_PIMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",7),neur.colors.inlocal_PIMN,rep("grey",10))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Sex_Processed',label = F, pt.size = 0.55,
        cells = grep("PIMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Sex_PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Sex_PIMNs DEGs
    
##### M upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$gene
```

```{r echo=FALSE, fig.height=4.5, messSex=FALSE, warning=FALSE, violin_Sex1_PIMNs,fig.width=6}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$gene[4:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identM"))$gene[7:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 3)
```


##### F upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identF"))$gene
```

```{r echo=FALSE, fig.height=3, messSex=FALSE, warning=FALSE, violin_Sex2_PIMNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PIMNs.filt2 %>% filter(contrast=="identF"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Sex_PSNs    

nuclei with Sex info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSN",ss2_neur.seur@meta.data$inlocal),"Sex_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_neur.masts_inlocal.Sex_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PSNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Sex_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PSNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.025*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex11PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (M vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identM"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=24,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Sex21PSNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey",
     main="Female", xlab="DE coefficient (F vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identF"))$padjD)+1.15),
     (ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=62.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Sex_1_PSNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",19),neur.colors.inlocal_PSN,rep("grey",2))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Sex_Processed',label = F, pt.size = 0.55,
        cells = grep("PSN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Sex_PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Sex_PSNs DEGs
    
##### M upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identM"))$gene
```

  
```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSex=FALSE, violin_Sex1_PSNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identM"))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### F upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identF"))$gene
```

```{r echo=FALSE, fig.height=3, warning=FALSE, messSex=FALSE, violin_Sex2_PSNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PSNs.filt2 %>% filter(contrast=="identF"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Sex_PINs    

nuclei with Sex info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIN",ss2_neur.seur@meta.data$inlocal),"Sex_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_neur.masts_inlocal.Sex_PINs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PINs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Sex_PINs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PINs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.025*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex11PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PINs %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (M vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PINs.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identM"))$coefD+0.03,
               logP=-log10((ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identM"))$padjD)+0.5),
     (ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=33.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Sex21PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PINs %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey",
     main="Female", xlab="DE coefficient (F vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PINs.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identF"))$padjD)+2.1),
     (ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=94.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Sex_1_PINs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",15),neur.colors.inlocal_PIN,rep("grey",6))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Sex_Processed',label = F, pt.size = 0.55,
        cells = grep("PIN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Sex_PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Sex_PINs DEGs
    
##### M upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identM"))$gene
```

    
```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSex=FALSE, violin_Sex1_PINs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identM"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### F upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identF"))$gene
```

  
```{r echo=FALSE, fig.height=3, warning=FALSE, messSex=FALSE, violin_Sex2_PINs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PINs.filt2 %>% filter(contrast=="identF"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```



### Sex_PSVNs    

nuclei with Sex info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSVN",ss2_neur.seur@meta.data$inlocal),"Sex_Processed"])
```


```{r echo=FALSE}
# quantile with step 0.05
test_quant.Sex <- data.frame(quantile(ss2_neur.masts_inlocal.Sex_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PSVNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Sex) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Sex_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Sex_PSVNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,1.1))
text(x=0:20*1.2+0.65,y=test_quant.Sex[,1]+0.025*test_quant.Sex[,1]/abs(test_quant.Sex[,1]),round(test_quant.Sex[,1],3),cex=0.7)
```

```{r volcano_Sex11PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs %>% filter(coefD > 0 & contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs %>% filter(coefD > 0 & contrast=="identM"))$padjD)),
     pch=16,col="grey",
     main="Male", xlab="DE coefficient (M vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs.filt1 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs.filt1 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identM"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identM"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identM"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identM"))$padjD)+0.25),
     (ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identM"))$gene,cex=0.6)

legend(x=0,y=16,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Sex21PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs %>% filter(coefD > 0 & contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs %>% filter(coefD > 0 & contrast=="identF"))$padjD)),
     pch=16,col="grey",
     main="Female", xlab="DE coefficient (F vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs.filt1 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs.filt1 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identF"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identF"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identF"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identF"))$padjD)+0.6),
     (ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identF"))$gene,cex=0.6)

legend(x=0,y=41.4,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Sex_1_PSVNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",23),neur.colors.inlocal_PSVN,rep("grey",0))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Sex_Processed',label = F, pt.size = 0.55,
        cells = grep("PSVN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Sex_PSVNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Sex_PSVNs DEGs
    
##### M upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identM"))$gene
```

   
```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSex=FALSE, violin_Sex1_PSVNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identM"))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### F upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identF"))$gene
```

 
```{r echo=FALSE, fig.height=1.5, warning=FALSE, messSex=FALSE, violin_Sex2_PSVNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Sex_PSVNs.filt2 %>% filter(contrast=="identF"))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Sex_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Sex_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


### Time    

nuclei with Time info   
```{r}
table(ss2_neur.seur@meta.data$Time_Processed)
```
   
    
```{r}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_neur.masts_inlocal.Time.filt1$alpha - ss2_neur.masts_inlocal.Time.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Time.filt1$alpha - ss2_neur.masts_inlocal.Time.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.3))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.01*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```


```{r volcano_Time1, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$coefD+0.03,
                logP=-log10((ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.8),
     (ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=52,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 


```{r volcano_Time2, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey", xlim=c(0,2),
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$coefD+0.03,
                logP=-log10((ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.6),
     (ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=35,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
``` 

```{r ss2_neur_Time1, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Time_Processed',label = F) + labs(title = "ss2_neur Time") +
  coord_fixed(ratio=0.95),
cols = 1)
```

   
#### Time DEGs


##### Evening upregulated       

```{r}
(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene
```

```{r echo=FALSE, fig.height=4.5, warning=FALSE, messSegment=FALSE, violin_Time1,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[4:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[7:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[10:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identEvening"))$gene[13:15], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
cols = 5)
```


##### Morning upregulated       

```{r}
(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene
```

```{r echo=FALSE, fig.height=25.5, warning=FALSE, messSegment=FALSE, violin_Time2,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[1:17], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time.filt2 %>% filter(contrast=="identMorning"))$gene[18:34], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"])], 
            ylim=c(0,6)),


cols = 2)
```

### Time_PEMNs    

nuclei with Time info     
```{r}
table(ss2_neur.seur@meta.data[grep("PEMN",ss2_neur.seur@meta.data$inlocal),"Time_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_neur.masts_inlocal.Time_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PEMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Time_PEMNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PEMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.45))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.012*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```

```{r volcano_Time11PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identEvening"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.4),
     (ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=30,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Time21PEMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey",
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identMorning"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=16,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Time_1_PEMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(neur.colors.inlocal_PEMN,rep("grey",18))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Time_Processed',label = F, pt.size = 0.55,
        cells = grep("PEMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Time_PEMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Time_PEMNs DEGs
    
##### Evening upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identEvening"))$gene
```

```{r echo=FALSE, fig.height=6, warning=FALSE, messTime=FALSE, violin_Time1_PEMNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identEvening"))$gene[1:4], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```



##### Morning upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identMorning"))$gene
```

```{r echo=FALSE, fig.height=1.5, warning=FALSE, messTime=FALSE, violin_Time2_PEMNs,fig.width=2}

  easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PEMNs.filt2 %>% filter(contrast=="identMorning"))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PEMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```

    
### Time_PIMNs    

nuclei with Time info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIMN",ss2_neur.seur@meta.data$inlocal),"Time_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_neur.masts_inlocal.Time_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PIMNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Time_PIMNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PIMNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.40))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.012*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```

```{r volcano_Time11PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=2.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=18,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Time21PIMNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey",
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identMorning"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.3),
     (ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=25,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Time_1_PIMNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",7),neur.colors.inlocal_PIMN,rep("grey",10))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Time_Processed',label = F, pt.size = 0.55,
        cells = grep("PIMN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Time_PIMNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Time_PIMNs DEGs
    
##### Evening upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$gene
```

```{r echo=FALSE, fig.height=7.5, messTime=FALSE, warning=FALSE, violin_Time1_PIMNs,fig.width=4}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$gene[1:5], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identEvening"))$gene[6:10], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 2)
```


##### Morning upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identMorning"))$gene
```

```{r echo=FALSE, fig.height=7.5, messTime=FALSE, warning=FALSE, violin_Time2_PIMNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PIMNs.filt2 %>% filter(contrast=="identMorning"))$gene[1:5], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIMN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```




### Time_PSNs    

nuclei with Time info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSN",ss2_neur.seur@meta.data$inlocal),"Time_Processed"])
```

none.  
```{r eval=FALSE, include=FALSE}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_neur.masts_inlocal.Time_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PSNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Time_PSNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PSNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.6))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.018*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```

```{r volcano_Time11PSNs, eval=FALSE, fig.height=10, fig.width=10, include=FALSE}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSNs %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSNs.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$coefD+0.05,
#               logP=-log10((ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.3),
#     (ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=14.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Time21PSNs, eval=FALSE, fig.height=10, fig.width=10, include=FALSE}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSNs %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey",
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSNs.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.15),
#     (ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=7.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Time_1_PSNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",19),neur.colors.inlocal_PSN,rep("grey",2))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Time_Processed',label = F, pt.size = 0.55,
        cells = grep("PSN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Time_PSNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Time_PSNs DEGs
    
##### Evening upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$gene
```

none.    
```{r eval=FALSE, fig.height=16.5, warning=FALSE, include=FALSE, messTime=FALSE, violin_Time1_PSNs,fig.width=6}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$gene[1:11], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$gene[12:22], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identEvening"))$gene[23:33], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 3)
```


##### Morning upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$gene
```

```{r eval=FALSE, fig.height=4.5, warning=FALSE, include=FALSE, messTime=FALSE, violin_Time2_PSNs,fig.width=8}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$gene[1:3], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$gene[4:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$gene[7:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSNs.filt2 %>% filter(contrast=="identMorning"))$gene[10:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 4)
```


### Time_PINs    

nuclei with Time info     
```{r}
table(ss2_neur.seur@meta.data[grep("PIN",ss2_neur.seur@meta.data$inlocal),"Time_Processed"])
```

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_neur.masts_inlocal.Time_PINs.filt1$alpha - ss2_neur.masts_inlocal.Time_PINs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Time_PINs.filt1$alpha - ss2_neur.masts_inlocal.Time_PINs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.35))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.015*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```

```{r volcano_Time11PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PINs %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PINs.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$coefD+0.03,
#               logP=-log10((ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.2),
#     (ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=3.5,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Time21PINs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PINs %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey",
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PINs.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identMorning"))$coefD+0.05,
                logP=-log10((ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.05),
     (ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=3.0,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Time_1_PINs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",15),neur.colors.inlocal_PIN,rep("grey",6))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Time_Processed',label = F, pt.size = 0.55,
        cells = grep("PIN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Time_PINs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Time_PINs DEGs
    
##### Evening upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$gene
```

None.      
```{r eval=FALSE, fig.height=9, warning=FALSE, include=FALSE, messTime=FALSE, violin_Time1_PINs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$gene[1:6], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$gene[7:12], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$gene[13:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$gene[19:24], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identEvening"))$gene[25:30], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```


##### Morning upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identMorning"))$gene
```


```{r echo=FALSE, fig.height=1.5, warning=FALSE, messTime=FALSE, violin_Time2_PINs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PINs.filt2 %>% filter(contrast=="identMorning"))$gene[1:1], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PIN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```



### Time_PSVNs    

nuclei with Time info     
```{r}
table(ss2_neur.seur@meta.data[grep("PSVN",ss2_neur.seur@meta.data$inlocal),"Time_Processed"])
```

such ratio getting no result for filt1 filtering.   

```{r echo=FALSE}
# quantile with step 0.05
test_quant.Time <- data.frame(quantile(ss2_neur.masts_inlocal.Time_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PSVNs.filt1$ref_alpha,
                                  probs = seq(0,1,0.05)))
colnames(test_quant.Time) <- "alpha-ref_alpha"
#test_quant

# choose 95% as cutoff
par(mar=c(3,2,3,2))
barplot(quantile(ss2_neur.masts_inlocal.Time_PSVNs.filt1$alpha - ss2_neur.masts_inlocal.Time_PSVNs.filt1$ref_alpha,
                 probs = seq(0,1,0.05)),col = c(rep("grey",19),"lightblue","grey"),
        main = "Quantile of 'alpha - ref_alpha'",ylim=c(0,0.35))
text(x=0:20*1.2+0.65,y=test_quant.Time[,1]+0.010*test_quant.Time[,1]/abs(test_quant.Time[,1]),round(test_quant.Time[,1],3),cex=0.7)
```

```{r volcano_Time11PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs %>% filter(coefD > 0 & contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs %>% filter(coefD > 0 & contrast=="identEvening"))$padjD)),
     pch=16,col="grey",
     main="Evening", xlab="DE coefficient (Evening vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.5,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs.filt1 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs.filt1 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identEvening"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identEvening"))$padjD)),
       pch=16,col="darkred")
text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identEvening"))$coefD+0.05,
               logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identEvening"))$padjD)+0.05),
     (ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identEvening"))$gene,cex=0.6)

legend(x=0,y=3.2,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```

```{r volcano_Time21PSVNs, echo=FALSE, fig.height=10, fig.width=10}
plot(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs %>% filter(coefD > 0 & contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs %>% filter(coefD > 0 & contrast=="identMorning"))$padjD)),
     pch=16,col="grey",
     main="Morning", xlab="DE coefficient (Morning vs. others)", ylab="-log10(adjusted p-value)")
#abline(v=0.5,lty=2)
#text(x=0.7,y=45,"coefD > 0.5",cex=0.8)
abline(h=-log10(0.05),lty=2)
text(x=0.05,y=1.8,"padjD < 0.05",cex=0.65)

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs.filt1 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs.filt1 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="lightblue")

points(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$coefD,
                logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$padjD)),
       pch=16,col="darkred")
#text(data.frame(coefD=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$coefD+0.05,
#                logP=-log10((ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$padjD)+0.3),
#     (ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$gene,cex=0.6)

legend(x=0,y=1.0,c("raw","filt1","filt2"),cex=1,
       col=c("grey","lightblue","darkred"),pch=c(16,16,16))
```
    
    
```{r ss2_neur_Time_1_PSVNs, fig.height=9.6, fig.width=7.2, warning=FALSE}
multiplot(
DimPlot(ss2_neur.seur, group.by = 'inlocal',label = T,
        cols = c(rep("grey",23),neur.colors.inlocal_PSVN,rep("grey",0))) + labs(title = "ss2_neur inlocal"),
DimPlot(ss2_neur.seur, group.by = 'Time_Processed',label = F, pt.size = 0.55,
        cells = grep("PSVN",ss2_neur.cov$inlocal)) + 
  labs(title = "ss2_neur Time_PSVNs") + coord_fixed(xlim = c(-45,45), ylim = c(-45,45),ratio = 0.88),
cols = 1)
```
   
#### Time_PSVNs DEGs
    
##### Evening upregulated       
    
```{r}
(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identEvening"))$gene
```

   
```{r echo=FALSE, fig.height=3, warning=FALSE, messTime=FALSE, violin_Time1_PSVNs,fig.width=2}

easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identEvening"))$gene[1:2], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6))
```


##### Morning upregulated    
   
```{r}
(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$gene
```

None.   
```{r eval=FALSE, fig.height=13.5, warning=FALSE, include=FALSE, messTime=FALSE, violin_Time2_PSVNs,fig.width=10}
multiplot(
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$gene[1:9], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$gene[10:18], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$gene[19:27], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$gene[28:36], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
easy_violin(seur=ss2_neur.seur,
            genes=(ss2_neur.masts_inlocal.Time_PSVNs.filt2 %>% filter(contrast=="identMorning"))$gene[37:45], 
            data=ss2_neur.seur@assays[['RNA']]@data, 
            groups=ss2_neur.seur@meta.data[,"Time_Processed"], 
            cells=rownames(ss2_neur.seur@meta.data)[!is.na(ss2_neur.seur@meta.data[,"Time_Processed"]) & 
                                                      grepl("PSVN",ss2_neur.cov$inlocal)], 
            ylim=c(0,6)),
cols = 5)
```



ss2_neur part ends here.      






